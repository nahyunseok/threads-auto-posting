<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêç Ïû•Ïñ¥ Ï£ºÎ¨∏Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú - Firebase ÌÅ¥ÎùºÏö∞Îìú Î≤ÑÏ†Ñ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #e8f5e8 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .connection-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }

        .status-connected {
            background: #dcfce7;
            color: #166534;
        }

        .status-disconnected {
            background: #fee2e2;
            color: #dc2626;
        }

        .status-loading {
            background: #fef3c7;
            color: #92400e;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab.active {
            background: #3b82f6;
            color: white;
        }

        .tab:hover:not(.active) {
            background: #f3f4f6;
        }

        .content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }

        .content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            font-size: 14px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .btn {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .grid {
            display: grid;
            gap: 20px;
        }

        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #10b981;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .partner-item {
            background: #f8fafc;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .partner-info {
            background: #e0f2fe;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #0ea5e9;
        }

        .quick-price-input {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }

        .dashboard-calendar {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            display: none;
        }

        .dashboard-calendar-header {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 8px;
            background: #3b82f6;
            color: white;
            border-radius: 5px;
            font-size: 12px;
        }

        .dashboard-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .dashboard-calendar-cell {
            padding: 6px;
            text-align: center;
            border: 1px solid #e5e7eb;
            font-size: 10px;
            min-height: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .dashboard-calendar-cell.has-price {
            background: #dcfce7;
        }

        .dashboard-calendar-cell.other-month {
            color: #9ca3af;
            background: #f9fafb;
        }

        .dashboard-price-badge {
            font-size: 8px;
            background: #10b981;
            color: white;
            padding: 1px 2px;
            border-radius: 2px;
            margin-top: 1px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .partner-calendar {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-top: 15px;
            overflow: hidden;
        }

        .partner-calendar-header {
            background: #10b981;
            color: white;
            padding: 10px 15px;
            font-weight: 600;
        }

        .partner-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day-header {
            background: #f8fafc;
            padding: 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #e5e7eb;
            font-size: 12px;
        }

        .partner-calendar-cell {
            padding: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            min-height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .partner-calendar-cell:hover {
            background: #f3f4f6;
        }

        .partner-calendar-cell.selected {
            background: #10b981;
            color: white;
        }

        .partner-calendar-cell.has-price {
            background: #dcfce7;
        }

        .partner-calendar-cell.has-price.selected {
            background: #10b981;
            color: white;
        }

        .partner-calendar-cell.other-month {
            color: #9ca3af;
            background: #f9fafb;
        }

        .calendar-price-badge {
            font-size: 9px;
            background: #10b981;
            color: white;
            padding: 1px 3px;
            border-radius: 2px;
            margin-top: 1px;
        }

        .partner-calendar-cell.selected .calendar-price-badge {
            background: rgba(255,255,255,0.3);
        }

        .price-input-section {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 10px;
            margin: 10px;
        }

        .price-input-section h4 {
            color: #0369a1;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .price-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .price-input-group input {
            flex: 1;
            min-width: 100px;
        }

        .price-input-group .btn {
            margin: 0;
            padding: 8px 12px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .price-input-group {
                flex-direction: column;
            }

            .price-input-group input,
            .price-input-group .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="connectionStatus" class="connection-status status-loading">
                üîÑ Firebase Ïó∞Í≤∞ ÌôïÏù∏ Ï§ë...
            </div>
            <h1>üêç Ïû•Ïñ¥ Ï£ºÎ¨∏Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</h1>
            <p>Firebase ÌÅ¥ÎùºÏö∞Îìú ÎèôÍ∏∞Ìôî Î≤ÑÏ†Ñ - Î™®Îì† Í∏∞Í∏∞ÏóêÏÑú ÎèôÏùºÌïú Îç∞Ïù¥ÌÑ∞</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä ÎåÄÏãúÎ≥¥Îìú</button>
            <button class="tab" onclick="showTab('partners')">üë• Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨</button>
            <button class="tab" onclick="showTab('orders')">üì¶ ÏÑ†Ï£ºÎ¨∏</button>
            <button class="tab" onclick="showTab('advances')">üí≥ Ïô∏ÏÉÅÍ¥ÄÎ¶¨</button>
            <button class="tab" onclick="showTab('payments')">üí∞ ÏûÖÍ∏à</button>
            <button class="tab" onclick="showTab('receipts')">üì• ÏûÖÍ≥†</button>
            <button class="tab" onclick="showTab('history')">üìã Í±∞ÎûòÎÇ¥Ïó≠</button>
        </div>

        <!-- ÎåÄÏãúÎ≥¥Îìú -->
        <div id="dashboard" class="content active">
            <h2>üìä ÎåÄÏãúÎ≥¥Îìú</h2>
            <div id="dashboardStats" class="stats-grid">
                <div class="loading">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</div>
            </div>
            <div id="dashboardContent">
                <div class="loading">Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥ Î°úÎî© Ï§ë...</div>
            </div>
        </div>

        <!-- Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨ -->
        <div id="partners" class="content">
            <h2>üë• Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨</h2>
            <div class="grid grid-2">
                <div>
                    <h3>ÏÉà Í±∞ÎûòÏ≤ò Ï∂îÍ∞Ä</h3>
                    <div class="form-group">
                        <label>Í±∞ÎûòÏ≤òÎ™Ö</label>
                        <input type="text" id="partnerName" placeholder="Í±∞ÎûòÏ≤òÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <div class="form-group">
                        <label>Ïó∞ÎùΩÏ≤ò</label>
                        <input type="text" id="partnerPhone" placeholder="Ïó∞ÎùΩÏ≤òÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <div class="form-group">
                        <label>Ï£ºÏÜå</label>
                        <textarea id="partnerAddress" placeholder="Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Î©îÎ™®</label>
                        <textarea id="partnerMemo" placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                    </div>
                    <button class="btn" onclick="addPartner()">Í±∞ÎûòÏ≤ò Ï∂îÍ∞Ä</button>
                </div>
                <div id="partnersList">
                    <div class="loading">Í±∞ÎûòÏ≤ò Î™©Î°ù Î°úÎî© Ï§ë...</div>
                </div>
            </div>
        </div>

        <!-- ÏÑ†Ï£ºÎ¨∏ -->
        <div id="orders" class="content">
            <h2>üì¶ ÏÑ†Ï£ºÎ¨∏ Í¥ÄÎ¶¨</h2>
            <div class="grid grid-2">
                <div>
                    <h3>ÏÉà ÏÑ†Ï£ºÎ¨∏ Ï∂îÍ∞Ä</h3>
                    <div class="form-group">
                        <label>Í±∞ÎûòÏ≤ò</label>
                        <select id="orderPartner" onchange="showPartnerCalendar('order')">
                            <option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ï£ºÎ¨∏ÎÇ†Ïßú</label>
                        <input type="date" id="orderDate">
                    </div>
                    <div class="form-group">
                        <label>ÏàòÎüâ (kg)</label>
                        <input type="number" id="orderQuantity" placeholder="ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <div class="form-group">
                        <label>Îã®Í∞Ä (Ïõê/kg)</label>
                        <input type="number" id="orderPrice" placeholder="Îã®Í∞ÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <div class="form-group">
                        <label>Ï¥ùÏï°</label>
                        <input type="text" id="orderTotal" readonly>
                    </div>
                    <div class="form-group">
                        <label>Î©îÎ™®</label>
                        <textarea id="orderMemo" placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                    </div>
                    <button class="btn" onclick="addOrder()">ÏÑ†Ï£ºÎ¨∏ Ï∂îÍ∞Ä</button>
                    <div id="orderPartnerCalendar" class="partner-calendar" style="display: none;">
                        <!-- Í±∞ÎûòÏ≤òÎ≥Ñ Îã¨Î†•Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>
                <div id="ordersList">
                    <div class="loading">ÏÑ†Ï£ºÎ¨∏ Î™©Î°ù Î°úÎî© Ï§ë...</div>
                </div>
            </div>
        </div>

        <!-- Ïô∏ÏÉÅÍ¥ÄÎ¶¨ -->
        <div id="advances" class="content">
            <h2>üí≥ Ïô∏ÏÉÅÍ¥ÄÎ¶¨</h2>
            <div class="grid grid-2">
                <div>
                    <h3>ÏÉà Ïô∏ÏÉÅ Ï∂îÍ∞Ä</h3>
                    <div class="form-group">
                        <label>Í±∞ÎûòÏ≤ò</label>
                        <select id="advancePartner">
                            <option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ÎÇ†Ïßú</label>
                        <input type="date" id="advanceDate">
                    </div>
                    <div class="form-group">
                        <label>Ïô∏ÏÉÅÍ∏àÏï° (Ïõê)</label>
                        <input type="number" id="advanceAmount" placeholder="Ïô∏ÏÉÅÍ∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <div class="form-group">
                        <label>Î©îÎ™®</label>
                        <textarea id="advanceMemo" placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="advanceHidden"> ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú Ïà®Í∏∞Í∏∞
                        </label>
                    </div>
                    <button class="btn" onclick="addAdvance()">Ïô∏ÏÉÅ Ï∂îÍ∞Ä</button>
                </div>
                <div id="advancesList">
                    <div class="loading">Ïô∏ÏÉÅ Î™©Î°ù Î°úÎî© Ï§ë...</div>
                </div>
            </div>
        </div>

        <!-- ÏûÖÍ∏à -->
        <div id="payments" class="content">
            <h2>üí∞ ÏûÖÍ∏à Í¥ÄÎ¶¨</h2>
            <div class="grid grid-2">
                <div>
                    <h3>ÏÉà ÏûÖÍ∏à Ï∂îÍ∞Ä</h3>
                    <div class="form-group">
                        <label>Í±∞ÎûòÏ≤ò</label>
                        <select id="paymentPartner" onchange="showPartnerInfo('payment')">
                            <option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                        </select>
                    </div>
                    <div id="paymentPartnerInfo" class="partner-info" style="display: none;">
                        <!-- Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                    <div class="form-group">
                        <label>ÎÇ†Ïßú</label>
                        <input type="date" id="paymentDate">
                    </div>
                    <div class="form-group">
                        <label>ÏûÖÍ∏àÏï° (Ïõê)</label>
                        <input type="number" id="paymentAmount" placeholder="ÏûÖÍ∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <div class="form-group">
                        <label>Î©îÎ™®</label>
                        <textarea id="paymentMemo" placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                    </div>
                    <button class="btn" onclick="addPayment()">ÏûÖÍ∏à Ï∂îÍ∞Ä</button>
                </div>
                <div id="paymentsList">
                    <div class="loading">ÏûÖÍ∏à Î™©Î°ù Î°úÎî© Ï§ë...</div>
                </div>
            </div>
        </div>

        <!-- ÏûÖÍ≥† Í¥ÄÎ¶¨ -->
        <div id="receipts" class="content">
            <h2>üì• ÏûÖÍ≥† Í¥ÄÎ¶¨</h2>
            <div class="grid grid-2">
                <div>
                    <h3>ÏÉà ÏûÖÍ≥† Ï∂îÍ∞Ä</h3>
                    <div class="form-group">
                        <label>Í±∞ÎûòÏ≤ò</label>
                        <select id="receiptPartner" onchange="showPartnerInfo('receipt')">
                            <option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                        </select>
                    </div>
                    <div id="receiptPartnerInfo" class="partner-info" style="display: none;">
                        <!-- Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                    <div class="form-group">
                        <label>ÎÇ†Ïßú</label>
                        <input type="date" id="receiptDate">
                    </div>
                    <div class="form-group">
                        <label>ÏàòÎüâ (kg)</label>
                        <input type="number" id="receiptQuantity" placeholder="ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <div class="form-group">
                        <label>Î©îÎ™®</label>
                        <textarea id="receiptMemo" placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                    </div>
                    <button class="btn" onclick="addReceipt()">ÏûÖÍ≥† Ï∂îÍ∞Ä</button>
                </div>
                <div id="receiptsList">
                    <div class="loading">ÏûÖÍ≥† Î™©Î°ù Î°úÎî© Ï§ë...</div>
                </div>
            </div>
        </div>

        <!-- Í±∞ÎûòÎÇ¥Ïó≠ -->
        <div id="history" class="content">
            <h2>üìã Í±∞ÎûòÎÇ¥Ïó≠</h2>
            <div class="form-group">
                <label>Í±∞ÎûòÏ≤ò ÌïÑÌÑ∞</label>
                <select id="historyFilter" onchange="updateHistoryList()">
                    <option value="">Ï†ÑÏ≤¥ Í±∞ÎûòÏ≤ò</option>
                </select>
            </div>
            <div id="historyList">
                <div class="loading">Í±∞ÎûòÎÇ¥Ïó≠ Î°úÎî© Ï§ë...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Î™®Îìà Î∞©Ïãù) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase ÏÑ§Ï†ï (Ïã§Ï†ú jangeo-trade ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï)
        const firebaseConfig = {
            apiKey: "AIzaSyCXjZ8Gi5fDBUDzqM29V-BtLluiTECcUQM",
            authDomain: "jangeo-trade.firebaseapp.com",
            projectId: "jangeo-trade",
            storageBucket: "jangeo-trade.firebasestorage.app",
            messagingSenderId: "783900173125",
            appId: "1:783900173125:web:d57cbfe31e178d0ba8d42c"
        };

        // Firebase Ï¥àÍ∏∞Ìôî
        let app, db;
        let isOnline = false;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            isOnline = true;
            updateConnectionStatus(true);
            console.log('Firebase Ï¥àÍ∏∞Ìôî ÏÑ±Í≥µ');
            
            // Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú ÏÑ§Ï†ï
            window.db = db;
            window.isOnline = isOnline;
            window.firebaseModules = { collection, addDoc, getDocs, doc, setDoc, deleteDoc };
            
            // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            loadFirebaseData();
        } catch (error) {
            console.error('Firebase Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
            updateConnectionStatus(false);
            initLocalStorage();
        }
    </script>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàòÎì§ (Î™®ÎìàÏóêÏÑú ÏÑ§Ï†ïÎê®)
        let db = window.db;
        let isOnline = window.isOnline || false;

        // Ïó∞Í≤∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.className = 'connection-status status-connected';
                statusElement.textContent = 'üåê Firebase ÌÅ¥ÎùºÏö∞Îìú Ïó∞Í≤∞Îê® - Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî ÌôúÏÑ±';
                isOnline = true;
            } else {
                statusElement.className = 'connection-status status-disconnected';
                statusElement.textContent = 'üî¥ Firebase Ïó∞Í≤∞ Ïã§Ìå® - Î°úÏª¨ Ï†ÄÏû•ÏÜå ÏÇ¨Ïö©';
                isOnline = false;
            }
        }

        // Ï†ÑÏó≠ Îç∞Ïù¥ÌÑ∞ Î≥ÄÏàòÎì§
        let partners = [];
        let orders = [];
        let advances = [];
        let payments = [];
        let receipts = [];
        let partnerPrices = {};

        // Ïª¨Î†âÏÖò Ï∞∏Ï°∞
        const collections = {
            partners: 'partners',
            orders: 'orders',
            advances: 'advances',
            payments: 'payments',
            receipts: 'receipts',
            partnerPrices: 'partnerPrices'
        };

        // Firebase Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadFirebaseData() {
            if (!isOnline || !window.firebaseModules) {
                console.log('Ïò§ÌîÑÎùºÏù∏ Î™®Îìú - Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú');
                loadLocalData();
                return;
            }

            try {
                console.log('FirebaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë...');
                const { collection, getDocs } = window.firebaseModules;
                
                // Î™®Îì† Ïª¨Î†âÏÖò Î≥ëÎ†¨ Î°úÎìú
                const [
                    partnersSnapshot,
                    ordersSnapshot,
                    advancesSnapshot,
                    paymentsSnapshot,
                    receiptsSnapshot,
                    pricesSnapshot
                ] = await Promise.all([
                    getDocs(collection(db, collections.partners)),
                    getDocs(collection(db, collections.orders)),
                    getDocs(collection(db, collections.advances)),
                    getDocs(collection(db, collections.payments)),
                    getDocs(collection(db, collections.receipts)),
                    getDocs(collection(db, collections.partnerPrices))
                ]);

                // Firebase Îç∞Ïù¥ÌÑ∞Î•º Î∞∞Ïó¥Î°ú Î≥ÄÌôò
                const firebasePartners = partnersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const firebaseOrders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const firebaseAdvances = advancesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const firebasePayments = paymentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const firebaseReceipts = receiptsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Í∞ÄÍ≤© Îç∞Ïù¥ÌÑ∞Îäî Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
                const firebasePrices = {};
                pricesSnapshot.docs.forEach(doc => {
                    firebasePrices[doc.id] = doc.data();
                });

                console.log('FirebaseÏóêÏÑú Î°úÎìúÎêú Îç∞Ïù¥ÌÑ∞:', {
                    partners: firebasePartners.length,
                    orders: firebaseOrders.length,
                    advances: firebaseAdvances.length,
                    payments: firebasePayments.length,
                    receipts: receipts.length,
                    prices: Object.keys(firebasePrices).length
                });

                // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ÏôÄ Î≥ëÌï© (Firebase Îç∞Ïù¥ÌÑ∞ Ïö∞ÏÑ†)
                partners = firebasePartners.length > 0 ? firebasePartners : partners;
                orders = firebaseOrders.length > 0 ? firebaseOrders : orders;
                advances = firebaseAdvances.length > 0 ? firebaseAdvances : advances;
                payments = firebasePayments.length > 0 ? firebasePayments : payments;
                receipts = firebaseReceipts.length > 0 ? firebaseReceipts : receipts;
                partnerPrices = Object.keys(firebasePrices).length > 0 ? firebasePrices : partnerPrices;

                // Î≥ëÌï©Îêú Îç∞Ïù¥ÌÑ∞Î•º Î°úÏª¨ÏóêÎèÑ Ï†ÄÏû• (ÎèôÍ∏∞Ìôî)
                saveToLocal();

                console.log('ÏµúÏ¢Ö Îç∞Ïù¥ÌÑ∞ (Firebase Ïö∞ÏÑ† Î≥ëÌï©):', {
                    partners: partners.length,
                    orders: orders.length,
                    advances: advances.length,
                    payments: payments.length,
                    receipts: receipts.length,
                    prices: Object.keys(partnerPrices).length
                });

                updateAllLists();
                
            } catch (error) {
                console.error('Firebase Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                // Firebase Ïã§Ìå® Ïãú localStorageÎ°ú Ìè¥Î∞±
                console.log('Firebase Ïã§Ìå® - Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Î°ú Ìè¥Î∞±');
                loadLocalData();
            }
        }

        // FirestoreÏóê Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        async function saveToFirebase(collectionName, data, docId = null) {
            if (!isOnline || !window.firebaseModules) {
                return saveToLocal();
            }

            try {
                const { collection, addDoc, doc, setDoc } = window.firebaseModules;
                
                if (docId) {
                    await setDoc(doc(db, collectionName, docId), data);
                } else {
                    const docRef = await addDoc(collection(db, collectionName), data);
                    return docRef.id;
                }
            } catch (error) {
                console.error(`${collectionName} Ï†ÄÏû• Ïã§Ìå®:`, error);
                // Firebase Ïã§Ìå® Ïãú localStorageÏóê Ï†ÄÏû•
                saveToLocal();
            }
        }

        // FirestoreÏóêÏÑú Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
        async function deleteFromFirebase(collectionName, docId) {
            if (!isOnline || !window.firebaseModules) {
                console.log('Ïò§ÌîÑÎùºÏù∏ Î™®Îìú ÎòêÎäî Firebase ÏóÜÏùå - Î°úÏª¨ÏóêÏÑúÎßå Ï≤òÎ¶¨');
                return; // Ïò§ÌîÑÎùºÏù∏Ïùº ÎïåÎäî ÏóêÎü¨Í∞Ä ÏïÑÎãò
            }

            try {
                const { doc, deleteDoc } = window.firebaseModules;
                console.log(`FirebaseÏóêÏÑú ${collectionName} ÏÇ≠Ï†ú Ï§ë:`, docId);
                await deleteDoc(doc(db, collectionName, docId));
                console.log(`Firebase ${collectionName} ÏÇ≠Ï†ú ÏôÑÎ£å:`, docId);
            } catch (error) {
                console.error(`${collectionName} Firebase ÏÇ≠Ï†ú Ïã§Ìå®:`, error);
                // Firebase ÏÇ≠Ï†ú Ïã§Ìå®Ïãú ÏóêÎü¨Î•º Îã§Ïãú throwÌïòÏó¨ ÏÉÅÏúÑ Ìï®ÏàòÏóêÏÑú Ï≤òÎ¶¨
                throw new Error(`FirebaseÏóêÏÑú ${collectionName} ÏÇ≠Ï†ú Ïã§Ìå®: ${error.message}`);
            }
        }

        // localStorage Ìè¥Î∞± Ìï®ÏàòÎì§
        function initLocalStorage() {
            loadLocalData();
        }

        function loadLocalData() {
            partners = JSON.parse(localStorage.getItem('eel_partners') || '[]');
            orders = JSON.parse(localStorage.getItem('eel_orders') || '[]');
            advances = JSON.parse(localStorage.getItem('eel_advances') || '[]');
            payments = JSON.parse(localStorage.getItem('eel_payments') || '[]');
            receipts = JSON.parse(localStorage.getItem('eel_receipts') || '[]');
            partnerPrices = JSON.parse(localStorage.getItem('eel_partnerPrices') || '{}');
            
            updateAllLists();
        }

        function saveToLocal() {
            localStorage.setItem('eel_partners', JSON.stringify(partners));
            localStorage.setItem('eel_orders', JSON.stringify(orders));
            localStorage.setItem('eel_advances', JSON.stringify(advances));
            localStorage.setItem('eel_payments', JSON.stringify(payments));
            localStorage.setItem('eel_receipts', JSON.stringify(receipts));
            localStorage.setItem('eel_partnerPrices', JSON.stringify(partnerPrices));
        }

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        function formatNumber(number) {
            return Number(number).toLocaleString('ko-KR');
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        function formatDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        // ÌÉ≠ Ï†ÑÌôò
        function showTab(tabName) {
            // Î™®Îì† ÌÉ≠Í≥º ÏΩòÌÖêÏ∏† ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            
            // ÏÑ†ÌÉùÎêú ÌÉ≠Í≥º ÏΩòÌÖêÏ∏† ÌôúÏÑ±Ìôî
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Í±∞ÎûòÏ≤ò Ï∂îÍ∞Ä
        async function addPartner() {
            const name = document.getElementById('partnerName').value.trim();
            const phone = document.getElementById('partnerPhone').value.trim();
            const address = document.getElementById('partnerAddress').value.trim();
            const memo = document.getElementById('partnerMemo').value.trim();

            if (!name) {
                alert('Í±∞ÎûòÏ≤òÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }

            console.log('Í±∞ÎûòÏ≤ò Ï∂îÍ∞Ä ÏãúÏûë:', name);

            const partner = {
                name: name,
                phone: phone,
                address: address,
                memo: memo,
                createdAt: new Date().toISOString()
            };

            try {
                // FirebaseÏóê Ï†ÄÏû• ÏãúÎèÑ (Ïò®ÎùºÏù∏Ïùº Îïå)
                if (isOnline && window.firebaseModules) {
                    console.log('FirebaseÏóê Í±∞ÎûòÏ≤ò Ï†ÄÏû• Ï§ë...');
                    const docId = await saveToFirebase(collections.partners, partner);
                    partner.id = docId;
                    console.log('Firebase Ï†ÄÏû• ÏôÑÎ£å, ID:', docId);
                } else {
                    console.log('Ïò§ÌîÑÎùºÏù∏ Î™®Îìú - Î°úÏª¨ ID ÏÉùÏÑ±');
                    partner.id = generateId();
                }

                // Î°úÏª¨ Î∞∞Ïó¥Ïóê Ï∂îÍ∞Ä
                partners.push(partner);
                console.log('Í±∞ÎûòÏ≤ò Î∞∞Ïó¥Ïóê Ï∂îÍ∞Ä ÏôÑÎ£å, Ï¥ù Í∞úÏàò:', partners.length);
                
                // Ìï≠ÏÉÅ Î°úÏª¨ Ï†ÄÏû•ÏÜåÏóêÎèÑ Ï†ÄÏû• (ÎèôÍ∏∞Ìôî Î≥¥Ïû•)
                saveToLocal();
                console.log('Î°úÏª¨ Ï†ÄÏû•ÏÜå ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');

            } catch (error) {
                console.error('Í±∞ÎûòÏ≤ò Ï∂îÍ∞Ä Ï§ë Ïò§Î•ò:', error);
                // Firebase Ïã§Ìå®Ïãú Î°úÏª¨ÏóêÎßå Ï†ÄÏû•
                partner.id = generateId();
                partners.push(partner);
                saveToLocal();
                console.log('Firebase Ïã§Ìå® - Î°úÏª¨ÏóêÎßå Ï†ÄÏû•');
            }

            // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            document.getElementById('partnerName').value = '';
            document.getElementById('partnerPhone').value = '';
            document.getElementById('partnerAddress').value = '';
            document.getElementById('partnerMemo').value = '';

            updatePartnersList();
            updateSelects();
            updateDashboard();
            alert('Í±∞ÎûòÏ≤òÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
        }

        // Î™®Îì† Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updateAllLists() {
            updateDashboard();
            updatePartnersList();
            updateOrdersList();
            updateAdvancesList();
            updatePaymentsList();
            updateReceiptsList();
            updateHistoryList();
            updateSelects();
        }

        // ÎåÄÏãúÎ≥¥Îìú ÏóÖÎç∞Ïù¥Ìä∏
        function updateDashboard() {
            updateDashboardStats();
            updateDashboardContent();
        }

        function updateDashboardStats() {
            const statsContainer = document.getElementById('dashboardStats');
            
            // ÎåÄÏãúÎ≥¥ÎìúÏö© Ïô∏ÏÉÅ (Ïà®Í≤®ÏßÑ Í≤É Ï†úÏô∏)
            const visibleAdvances = advances.filter(a => a.hidden !== true);
            const totalAdvanceAmount = visibleAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
            
            // Ï¥ù Ï£ºÎ¨∏ Í∏àÏï°Í≥º ÏàòÎüâ
            const totalOrderAmount = orders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
            const totalOrderQuantity = orders.reduce((sum, o) => sum + (o.quantity || 0), 0);
            
            // Ï¥ù ÏûÖÍ∏à Í∏àÏï°
            const totalPaymentAmount = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
            
            // Ï¥ù ÏûÖÍ≥† ÏàòÎüâ
            const totalReceiptQuantity = receipts.reduce((sum, r) => sum + (r.quantity || 0), 0);
            
            // Ïã§Ï†ú Ï§Ñ ÎèàÍ≥º Î∞õÏùÑ Ïû•Ïñ¥
            const totalAmountToPay = totalOrderAmount + totalAdvanceAmount - totalPaymentAmount;
            const totalEelToReceive = totalOrderQuantity - totalReceiptQuantity;
            
            statsContainer.innerHTML = `
                <div class="stat-card" style="border-left-color: #ef4444;">
                    <div class="stat-number" style="color: #ef4444;">${formatNumber(totalAmountToPay)}Ïõê</div>
                    <div>üí∞ Ï¥ù Ï§Ñ Îèà</div>
                </div>
                <div class="stat-card" style="border-left-color: #10b981;">
                    <div class="stat-number" style="color: #10b981;">${formatNumber(totalEelToReceive)}kg</div>
                    <div>üêç Ï¥ù Î∞õÏùÑ Ïû•Ïñ¥</div>
                </div>
                <div class="stat-card" style="border-left-color: #f59e0b;">
                    <div class="stat-number" style="color: #f59e0b;">${partners.length}Í∞ú</div>
                    <div>üë• Í±∞ÎûòÏ≤ò</div>
                </div>
                <div class="stat-card" style="border-left-color: #8b5cf6;">
                    <div class="stat-number" style="color: #8b5cf6;">${orders.length}Í±¥</div>
                    <div>üì¶ ÏÑ†Ï£ºÎ¨∏</div>
                </div>
            `;
        }

        function updateDashboardContent() {
            const container = document.getElementById('dashboardContent');
            
            if (partners.length === 0) {
                container.innerHTML = '<p>Îì±Î°ùÎêú Í±∞ÎûòÏ≤òÍ∞Ä ÏóÜÏäµÎãàÎã§. Í±∞ÎûòÏ≤òÎ•º Î®ºÏ†Ä Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.</p>';
                return;
            }

            // Í±∞ÎûòÏ≤òÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞
            const partnerData = partners.map(partner => {
                // ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑúÎäî Ïà®Í≤®ÏßÑ Ïô∏ÏÉÅ Ï†úÏô∏
                const partnerAdvances = advances.filter(a => a.partnerId === partner.id && a.hidden !== true);
                const totalAdvanceAmount = partnerAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
                
                const partnerOrders = orders.filter(o => o.partnerId === partner.id);
                const totalOrderAmount = partnerOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
                const totalOrderQuantity = partnerOrders.reduce((sum, o) => sum + (o.quantity || 0), 0);
                
                const partnerPayments = payments.filter(p => p.partnerId === partner.id);
                const totalPaymentAmount = partnerPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
                
                const partnerReceipts = receipts.filter(r => r.partnerId === partner.id);
                const totalReceiptQuantity = partnerReceipts.reduce((sum, r) => sum + (r.quantity || 0), 0);
                
                // Ïã§Ï†ú Ï§Ñ ÎèàÍ≥º Î∞õÏùÑ Ïû•Ïñ¥
                const amountToPay = totalOrderAmount + totalAdvanceAmount - totalPaymentAmount;
                const eelToReceive = totalOrderQuantity - totalReceiptQuantity;
                
                return {
                    partner,
                    amountToPay,
                    eelToReceive,
                    hasData: amountToPay !== 0 || eelToReceive !== 0
                };
            }).filter(data => data.hasData); // Í±∞ÎûòÍ∞Ä ÏûàÎäî Í±∞ÎûòÏ≤òÎßå ÌëúÏãú

            let contentHTML = '<h3>üè¢ Ï£ºÏöî Í±∞ÎûòÏ≤ò ÌòÑÌô©</h3>';
            
            if (partnerData.length === 0) {
                contentHTML += '<p>Í±∞Îûò ÎÇ¥Ïó≠Ïù¥ ÏûàÎäî Í±∞ÎûòÏ≤òÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
            } else {
                partnerData.forEach(data => {
                    const statusColor = data.amountToPay > 0 ? '#ef4444' : '#10b981';
                    const eelColor = data.eelToReceive > 0 ? '#10b981' : '#6b7280';
                    
                    contentHTML += `
                        <div class="partner-item">
                            <div>
                                <strong style="font-size: 16px;">${data.partner.name}</strong>
                                <div style="margin-top: 8px;">
                                    <span style="color: ${statusColor}; font-weight: bold;">üí∞ ${formatNumber(data.amountToPay)}Ïõê</span>
                                    <span style="margin-left: 15px; color: ${eelColor}; font-weight: bold;">üêç ${formatNumber(data.eelToReceive)}kg</span>
                                </div>
                                <div class="quick-price-input">
                                    <input type="number" id="quickPrice_${data.partner.id}" placeholder="Îã®Í∞Ä" style="width: 70px; padding: 4px 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px;">
                                    <button class="btn" onclick="setQuickPrice('${data.partner.id}')" style="padding: 4px 8px; font-size: 11px; background: #10b981;">Ï†ÄÏû•</button>
                                    <button class="btn" onclick="toggleQuickCalendar('${data.partner.id}')" style="padding: 4px 8px; font-size: 11px; background: #3b82f6;">üìÖ Îã¨Î†•</button>
                                </div>
                                <div id="quickCalendar_${data.partner.id}" class="dashboard-calendar" style="display: none;">
                                    <!-- Îã¨Î†•Ïù¥ Ïó¨Í∏∞Ïóê Î†åÎçîÎßÅÎê©ÎãàÎã§ -->
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = contentHTML;
        }

        // Îπ†Î•∏ Îã®Í∞Ä Ï†ÄÏû•
        async function setQuickPrice(partnerId) {
            const priceInput = document.getElementById(`quickPrice_${partnerId}`);
            const price = parseFloat(priceInput.value);
            
            if (!price || price <= 0) {
                alert('Ïò¨Î∞îÎ•∏ Îã®Í∞ÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const today = new Date();
            const dateKey = formatDateKey(today);
            const priceKey = `${partnerId}_${dateKey}`;
            
            const priceData = {
                price: price,
                note: 'ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú Îπ†Î•∏ ÏûÖÎ†•',
                updatedAt: new Date().toISOString()
            };
            
            partnerPrices[priceKey] = priceData;
            
            if (isOnline) {
                await saveToFirebase(collections.partnerPrices, priceData, priceKey);
            } else {
                saveToLocal();
            }
            
            priceInput.value = '';
            renderQuickCalendar(partnerId);
            alert('Ïò§Îäò Îã®Í∞ÄÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
        }

        // Îπ†Î•∏ Îã¨Î†• ÌÜ†Í∏Ä
        function toggleQuickCalendar(partnerId) {
            const calendar = document.getElementById(`quickCalendar_${partnerId}`);
            if (!calendar) return;
            
            if (calendar.style.display === 'none' || calendar.style.display === '') {
                calendar.style.display = 'block';
                setTimeout(() => renderQuickCalendar(partnerId), 10);
            } else {
                calendar.style.display = 'none';
            }
        }

        // Îπ†Î•∏ Îã¨Î†• Î†åÎçîÎßÅ
        function renderQuickCalendar(partnerId) {
            const calendar = document.getElementById(`quickCalendar_${partnerId}`);
            if (!calendar) return;
            
            const partner = partners.find(p => p.id === partnerId);
            if (!partner) return;
            
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            
            let calendarHTML = `
                <div class="dashboard-calendar-header">
                    ${partner.name} - ${year}ÎÖÑ ${month + 1}Ïõî
                </div>
                <div class="dashboard-calendar-grid">
            `;
            
            // ÏöîÏùº Ìó§Îçî
            const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
            days.forEach(day => {
                calendarHTML += `<div style="background: #f8fafc; padding: 3px; text-align: center; font-weight: 600; border: 1px solid #e5e7eb; font-size: 9px;">${day}</div>`;
            });
            
            // Îã¨Î†• ÎÇ†ÏßúÎì§
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + (week * 7) + day);
                    
                    const isCurrentMonth = cellDate.getMonth() === month;
                    const dateKey = formatDateKey(cellDate);
                    const priceKey = `${partnerId}_${dateKey}`;
                    const priceInfo = partnerPrices[priceKey];
                    
                    let cellClass = 'dashboard-calendar-cell';
                    if (!isCurrentMonth) cellClass += ' other-month';
                    if (priceInfo) cellClass += ' has-price';
                    
                    const priceBadge = priceInfo ? 
                        `<div class="dashboard-price-badge">${formatNumber(priceInfo.price)}</div>` : '';
                    
                    calendarHTML += `
                        <div class="${cellClass}" style="min-height: 25px; padding: 2px;">
                            <div style="font-size: 9px;">${cellDate.getDate()}</div>
                            ${priceBadge}
                        </div>
                    `;
                }
            }
            
            calendarHTML += `</div>`;
            calendar.innerHTML = calendarHTML;
        }

        // select ÏòµÏÖò ÏóÖÎç∞Ïù¥Ìä∏
        function updateSelects() {
            const selects = ['orderPartner', 'advancePartner', 'paymentPartner', 'receiptPartner', 'historyFilter'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                const isHistoryFilter = selectId === 'historyFilter';
                
                select.innerHTML = isHistoryFilter ? 
                    '<option value="">Ï†ÑÏ≤¥ Í±∞ÎûòÏ≤ò</option>' : 
                    '<option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
                
                partners.forEach(partner => {
                    const option = document.createElement('option');
                    option.value = partner.id;
                    option.textContent = partner.name;
                    if (currentValue === partner.id) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });
        }

        // Í±∞ÎûòÏ≤ò Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updatePartnersList() {
            const container = document.getElementById('partnersList');
            if (!container) return;
            
            container.innerHTML = '<h3>Í±∞ÎûòÏ≤ò Î™©Î°ù</h3>';
            
            if (partners.length === 0) {
                container.innerHTML += '<p>Îì±Î°ùÎêú Í±∞ÎûòÏ≤òÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            partners.forEach(partner => {
                const partnerDiv = document.createElement('div');
                partnerDiv.className = 'partner-item';
                partnerDiv.innerHTML = `
                    <div>
                        <strong>${partner.name}</strong>
                        <br>
                        <small>üìû ${partner.phone || 'ÏóÜÏùå'}</small>
                        <br>
                        <small>üìç ${partner.address || 'ÏóÜÏùå'}</small>
                        <br>
                        <small>üìù ${partner.memo || 'ÏóÜÏùå'}</small>
                        <br>
                        <small>Îì±Î°ùÏùº: ${formatDate(partner.createdAt)}</small>
                    </div>
                    <div>
                        <button class="btn" onclick="editPartner('${partner.id}')">ÏàòÏ†ï</button>
                        <button class="btn btn-danger" onclick="immediateDeletePartner('${partner.id}', '${partner.name}')">ÏÇ≠Ï†ú</button>
                    </div>
                `;
                container.appendChild(partnerDiv);
            });
        }

        // Í±∞ÎûòÏ≤ò ÏàòÏ†ï
        async function editPartner(id) {
            const partner = partners.find(p => p.id === id);
            if (!partner) return;
            
            const newName = prompt('Í±∞ÎûòÏ≤òÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', partner.name);
            if (newName === null) return;
            
            if (!newName.trim()) {
                alert('Í±∞ÎûòÏ≤òÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const newContact = prompt('Ïó∞ÎùΩÏ≤òÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', partner.contact || '');
            const newMemo = prompt('Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', partner.memo || '');
            
            // ÌååÌä∏ÎÑà Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            partner.name = newName.trim();
            partner.contact = newContact ? newContact.trim() : '';
            partner.memo = newMemo ? newMemo.trim() : '';
            partner.updatedAt = new Date().toISOString();
            
            try {
                // FirebaseÏóê ÏóÖÎç∞Ïù¥Ìä∏
                if (isOnline) {
                    await saveToFirebase(collections.partners, partner, id);
                }
                
                // Î°úÏª¨ Ï†ÄÏû•ÏÜåÏóêÎèÑ Ï†ÄÏû•
                saveToLocal();
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                updatePartnersList();
                updateSelects();
                
                alert('Í±∞ÎûòÏ≤òÍ∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.');
            } catch (error) {
                console.error('Í±∞ÎûòÏ≤ò ÏàòÏ†ï Ïò§Î•ò:', error);
                alert('Í±∞ÎûòÏ≤ò ÏàòÏ†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // Ï¶âÏãú ÏÇ≠Ï†ú Ìï®Ïàò (ÎîîÎ≤ÑÍπÖ Í∞ïÌôî)
        function immediateDeletePartner(id, name) {
            console.log('=== ÏÇ≠Ï†ú Ìï®Ïàò Ìò∏Ï∂úÎê® ===', id, name);
            
            if (!id) {
                console.error('IDÍ∞Ä ÏóÜÏäµÎãàÎã§!');
                alert('Ïò§Î•ò: Í±∞ÎûòÏ≤ò IDÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            if (!confirm(`${name} Í±∞ÎûòÏ≤òÎ•º Ï†ïÎßêÎ°ú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                console.log('ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÇ≠Ï†úÎ•º Ï∑®ÏÜåÌï®');
                return;
            }
            
            console.log('=== Ï¶âÏãú ÏÇ≠Ï†ú ÏãúÏûë ===', name, id);
            console.log('ÏÇ≠Ï†ú Ï†Ñ partners Î∞∞Ïó¥:', partners);
            console.log('ÏÇ≠Ï†úÌï† IDÎ°ú Í≤ÄÏÉâÌïú Í±∞ÎûòÏ≤ò:', partners.find(p => p.id === id));
            
            // 1. Î∞∞Ïó¥ÏóêÏÑú Ï¶âÏãú Ï†úÍ±∞ (ID ÌÉÄÏûÖ Î¨∏Ï†ú Ìï¥Í≤∞)
            const beforeCount = partners.length;
            const originalPartners = [...partners];
            
            // Î¨∏ÏûêÏó¥Í≥º Ïà´Ïûê ID Î™®Îëê Ï≤òÎ¶¨
            partners = partners.filter(p => {
                const match = (String(p.id) === String(id));
                if (match) {
                    console.log('ÏÇ≠Ï†úÎêòÎäî Í±∞ÎûòÏ≤ò:', p);
                }
                return !match;
            });
            
            orders = orders.filter(o => String(o.partnerId) !== String(id));
            advances = advances.filter(a => String(a.partnerId) !== String(id));
            payments = payments.filter(p => String(p.partnerId) !== String(id));
            receipts = receipts.filter(r => String(r.partnerId) !== String(id));
            
            console.log(`Í±∞ÎûòÏ≤ò Ïàò: ${beforeCount} -> ${partners.length}`);
            console.log('ÏÇ≠Ï†ú ÌõÑ partners Î∞∞Ïó¥:', partners);
            
            if (beforeCount === partners.length) {
                console.error('‚ùå ÏÇ≠Ï†úÍ∞Ä Ïã§ÌñâÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!');
                alert('ÏÇ≠Ï†ú Ïã§Ìå®: Í±∞ÎûòÏ≤òÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // 2. Î°úÏª¨ Ï†ÄÏû•
            try {
                localStorage.setItem('eel_partners', JSON.stringify(partners));
                localStorage.setItem('eel_orders', JSON.stringify(orders));
                localStorage.setItem('eel_advances', JSON.stringify(advances));
                localStorage.setItem('eel_payments', JSON.stringify(payments));
                localStorage.setItem('eel_receipts', JSON.stringify(receipts));
                console.log('‚úÖ localStorage Ï†ÄÏû• ÏôÑÎ£å');
            } catch (error) {
                console.error('‚ùå localStorage Ï†ÄÏû• Ïã§Ìå®:', error);
            }
            
            // 3. FirebaseÏóêÏÑúÎèÑ ÏÇ≠Ï†ú ÏãúÎèÑ
            if (isOnline && window.firebaseModules) {
                try {
                    deleteFromFirebase(collections.partners, id);
                    console.log('Firebase ÏÇ≠Ï†ú ÏöîÏ≤≠ Ï†ÑÏÜ°');
                } catch (error) {
                    console.warn('Firebase ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                }
            }
            
            // 4. UI Í∞ïÏ†ú ÏóÖÎç∞Ïù¥Ìä∏
            console.log('UI ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë...');
            try {
                updatePartnersList();
                console.log('‚úÖ updatePartnersList ÏôÑÎ£å');
                updateDashboardStats();
                console.log('‚úÖ updateDashboardStats ÏôÑÎ£å');
                updateDashboardContent();
                console.log('‚úÖ updateDashboardContent ÏôÑÎ£å');
                updateSelects();
                console.log('‚úÖ updateSelects ÏôÑÎ£å');
            } catch (error) {
                console.error('‚ùå UI ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:', error);
            }
            
            console.log('=== Ï¶âÏãú ÏÇ≠Ï†ú ÏôÑÎ£å ===');
            alert('Í±∞ÎûòÏ≤òÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        }

        // Í∞ÑÎã®Ìïú Í±∞ÎûòÏ≤ò ÏÇ≠Ï†ú (Í∞ïÏ†ú Ïã§Ìñâ)
        async function forceDeletePartner(id) {
            const partner = partners.find(p => p.id === id);
            if (!partner) {
                alert('Í±∞ÎûòÏ≤òÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            if (!confirm(`${partner.name} Í±∞ÎûòÏ≤òÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }
            
            console.log('Í∞ïÏ†ú ÏÇ≠Ï†ú ÏãúÏûë:', partner.name, 'ID:', id);
            console.log('ÏÇ≠Ï†ú Ï†Ñ Í±∞ÎûòÏ≤ò Ïàò:', partners.length);
            
            // Î°úÏª¨ Î∞∞Ïó¥ÏóêÏÑú Ï¶âÏãú Ï†úÍ±∞
            const originalCount = partners.length;
            partners = partners.filter(p => p.id !== id);
            orders = orders.filter(o => o.partnerId !== id);
            advances = advances.filter(a => a.partnerId !== id);
            payments = payments.filter(p => p.partnerId !== id);
            receipts = receipts.filter(r => r.partnerId !== id);
            
            console.log('ÏÇ≠Ï†ú ÌõÑ Í±∞ÎûòÏ≤ò Ïàò:', partners.length, '(', originalCount, '->', partners.length, ')');
            
            // Î°úÏª¨ Ï†ÄÏû•
            saveToLocal();
            console.log('Î°úÏª¨ Ï†ÄÏû• ÏôÑÎ£å');
            
            // FirebaseÏóêÏÑúÎèÑ Ï¶âÏãú ÏÇ≠Ï†ú ÏãúÎèÑ
            if (isOnline && window.firebaseModules) {
                try {
                    console.log('FirebaseÏóêÏÑú Í±∞ÎûòÏ≤ò ÏÇ≠Ï†ú Ï§ë...');
                    await deleteFromFirebase(collections.partners, id);
                    console.log('Firebase ÏÇ≠Ï†ú ÏôÑÎ£å');
                } catch (error) {
                    console.warn('Firebase ÏÇ≠Ï†ú Ïã§Ìå® (Î°úÏª¨ÏóêÏÑúÎäî ÏÇ≠Ï†úÎê®):', error);
                }
            }
            
            // UI Í∞ïÏ†ú ÏóÖÎç∞Ïù¥Ìä∏ - DOM ÏßÅÏ†ë Ï°∞Ïûë
            console.log('UI ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë');
            
            // Í±∞ÎûòÏ≤ò Î™©Î°ù ÏôÑÏ†ÑÌûà Ïû¨Íµ¨ÏÑ±
            const container = document.getElementById('partnersList');
            if (container) {
                container.innerHTML = '<h3>Í±∞ÎûòÏ≤ò Î™©Î°ù</h3>';
                if (partners.length === 0) {
                    container.innerHTML += '<p>Îì±Î°ùÎêú Í±∞ÎûòÏ≤òÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                } else {
                    partners.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'partner-item';
                        div.innerHTML = `
                            <div>
                                <strong>${p.name}</strong><br>
                                <small>üìû ${p.phone || 'ÏóÜÏùå'}</small><br>
                                <small>üìç ${p.address || 'ÏóÜÏùå'}</small><br>
                                <small>Îì±Î°ùÏùº: ${formatDate(p.createdAt)}</small>
                            </div>
                            <div>
                                <button class="btn" onclick="editPartner('${p.id}')">ÏàòÏ†ï</button>
                                <button class="btn btn-danger" onclick="immediateDeletePartner('${p.id}', '${p.name}')">ÏÇ≠Ï†ú</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
                console.log('Í±∞ÎûòÏ≤ò Î™©Î°ù DOM ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
            }
            
            // ÎåÄÏãúÎ≥¥Îìú ÌÜµÍ≥Ñ Í∞ïÏ†ú Ïû¨Í≥ÑÏÇ∞ Î∞è ÏóÖÎç∞Ïù¥Ìä∏
            setTimeout(() => {
                // ÎåÄÏãúÎ≥¥Îìú ÌÜµÍ≥Ñ Í∞ïÏ†ú Ïû¨ÏûëÏÑ±
                const statsContainer = document.getElementById('dashboardStats');
                if (statsContainer) {
                    const visibleAdvances = advances.filter(a => a.hidden !== true);
                    const totalAdvanceAmount = visibleAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
                    const totalOrderAmount = orders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
                    const totalOrderQuantity = orders.reduce((sum, o) => sum + (o.quantity || 0), 0);
                    const totalPaymentAmount = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
                    const totalReceiptQuantity = receipts.reduce((sum, r) => sum + (r.quantity || 0), 0);
                    const totalAmountToPay = totalOrderAmount + totalAdvanceAmount - totalPaymentAmount;
                    const totalEelToReceive = totalOrderQuantity - totalReceiptQuantity;
                    
                    statsContainer.innerHTML = `
                        <div class="stat-card" style="border-left-color: #ef4444;">
                            <div class="stat-number" style="color: #ef4444;">${formatNumber(totalAmountToPay)}Ïõê</div>
                            <div>üí∞ Ï¥ù Ï§Ñ Îèà</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #10b981;">
                            <div class="stat-number" style="color: #10b981;">${formatNumber(totalEelToReceive)}kg</div>
                            <div>üêç Ï¥ù Î∞õÏùÑ Ïû•Ïñ¥</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #f59e0b;">
                            <div class="stat-number" style="color: #f59e0b;">${partners.length}Í∞ú</div>
                            <div>üë• Í±∞ÎûòÏ≤ò</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #8b5cf6;">
                            <div class="stat-number" style="color: #8b5cf6;">${visibleAdvances.length}Í±¥</div>
                            <div>ü•Ñ ÏÑ†Ï£ºÎ¨∏</div>
                        </div>
                    `;
                    console.log('ÎåÄÏãúÎ≥¥Îìú ÌÜµÍ≥Ñ Í∞ïÏ†ú ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
                }
                
                updateDashboardContent();
                updateSelects();
                console.log('ÎåÄÏãúÎ≥¥Îìú ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
            }, 100);
            
            console.log('Í∞ïÏ†ú ÏÇ≠Ï†ú Î∞è UI ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
            alert('Í±∞ÎûòÏ≤òÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        }

        // Í±∞ÎûòÏ≤ò ÏÇ≠Ï†ú
        async function deletePartner(id) {
            const partner = partners.find(p => p.id === id);
            if (!partner) {
                console.error('ÏÇ≠Ï†úÌï† Í±∞ÎûòÏ≤òÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:', id);
                return;
            }
            
            if (!confirm(`${partner.name} Í±∞ÎûòÏ≤òÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n‚ö†Ô∏è Í¥ÄÎ†®Îêú Î™®Îì† Í±∞Îûò Îç∞Ïù¥ÌÑ∞ÎèÑ Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§.`)) {
                return;
            }
            
            console.log('Í±∞ÎûòÏ≤ò ÏÇ≠Ï†ú ÏãúÏûë:', partner.name, id);
            
            try {
                // Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
                const relatedOrders = orders.filter(order => order.partnerId === id);
                const relatedAdvances = advances.filter(advance => advance.partnerId === id);
                const relatedPayments = payments.filter(payment => payment.partnerId === id);
                const relatedReceipts = receipts.filter(receipt => receipt.partnerId === id);
                
                console.log('ÏÇ≠Ï†úÌï† Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞:', {
                    orders: relatedOrders.length,
                    advances: relatedAdvances.length,
                    payments: relatedPayments.length,
                    receipts: relatedReceipts.length
                });
                
                // FirebaseÏóêÏÑú ÏÇ≠Ï†ú (Ïò®ÎùºÏù∏Ïùº ÎïåÎßå)
                if (isOnline && window.firebaseModules) {
                    console.log('FirebaseÏóêÏÑú Í±∞ÎûòÏ≤ò Î∞è Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú ÏãúÏûë');
                    
                    // Í±∞ÎûòÏ≤ò ÏÇ≠Ï†ú
                    await deleteFromFirebase(collections.partners, id);
                    
                    // Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞ÎèÑ FirebaseÏóêÏÑú ÏÇ≠Ï†ú
                    const deletePromises = [
                        ...relatedOrders.map(item => deleteFromFirebase(collections.orders, item.id)),
                        ...relatedAdvances.map(item => deleteFromFirebase(collections.advances, item.id)),
                        ...relatedPayments.map(item => deleteFromFirebase(collections.payments, item.id)),
                        ...relatedReceipts.map(item => deleteFromFirebase(collections.receipts, item.id))
                    ];
                    
                    await Promise.all(deletePromises);
                    console.log('Firebase ÏÇ≠Ï†ú ÏôÑÎ£å');
                } else {
                    console.log('Ïò§ÌîÑÎùºÏù∏ Î™®Îìú - Firebase ÏÇ≠Ï†ú Í±¥ÎÑàÎúÄ');
                }
                
                // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú (Firebase ÏÇ≠Ï†ú ÏÑ±Í≥µ ÌõÑ ÎòêÎäî Ïò§ÌîÑÎùºÏù∏Ïùº Îïå)
                console.log('Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÏÇ≠Ï†ú ÏãúÏûë');
                
                const originalPartnersLength = partners.length;
                const originalOrdersLength = orders.length;
                const originalAdvancesLength = advances.length;
                const originalPaymentsLength = payments.length;
                const originalReceiptsLength = receipts.length;
                
                // Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞ Î®ºÏ†Ä ÏÇ≠Ï†ú
                orders = orders.filter(order => order.partnerId !== id);
                advances = advances.filter(advance => advance.partnerId !== id);
                payments = payments.filter(payment => payment.partnerId !== id);
                receipts = receipts.filter(receipt => receipt.partnerId !== id);
                
                // Í±∞ÎûòÏ≤ò ÏÇ≠Ï†ú
                partners = partners.filter(p => p.id !== id);
                
                console.log('Î°úÏª¨ ÏÇ≠Ï†ú Í≤∞Í≥º:', {
                    partners: `${originalPartnersLength} -> ${partners.length}`,
                    orders: `${originalOrdersLength} -> ${orders.length}`,
                    advances: `${originalAdvancesLength} -> ${advances.length}`,
                    payments: `${originalPaymentsLength} -> ${payments.length}`,
                    receipts: `${originalReceiptsLength} -> ${receipts.length}`
                });
                
                // Î°úÏª¨ Ï†ÄÏû•ÏÜå ÏóÖÎç∞Ïù¥Ìä∏
                saveToLocal();
                console.log('localStorage ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏ (Í∞ÅÍ∞Å Í∞úÎ≥ÑÏ†ÅÏúºÎ°ú Ìò∏Ï∂ú)
                updatePartnersList();
                updateOrdersList();
                updateAdvancesList();
                updatePaymentsList();
                updateReceiptsList();
                updateDashboard();
                updateHistoryList();
                console.log('UI ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
                
                alert('Í±∞ÎûòÏ≤òÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                
            } catch (error) {
                console.error('Í±∞ÎûòÏ≤ò ÏÇ≠Ï†ú Ï§ë Ïò§Î•ò:', error);
                alert(`Í±∞ÎûòÏ≤ò ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n${error.message}\n\nÎã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.`);
            }
        }

        // ÏÑ†Ï£ºÎ¨∏ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updateOrdersList() {
            const container = document.getElementById('ordersList');
            if (!container) return;
            
            container.innerHTML = '<h3>ÏÑ†Ï£ºÎ¨∏ Î™©Î°ù</h3>';
            
            if (orders.length === 0) {
                container.innerHTML += '<p>Îì±Î°ùÎêú ÏÑ†Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            // ÏµúÏã†ÏàúÏúºÎ°ú Ï†ïÎ†¨
            const sortedOrders = [...orders].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            sortedOrders.forEach(order => {
                const partner = partners.find(p => p.id === order.partnerId);
                const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                
                const orderDiv = document.createElement('div');
                orderDiv.className = 'partner-item';
                orderDiv.innerHTML = `
                    <div>
                        <strong>${partnerName}</strong>
                        <br>
                        <small>üìÖ Ï£ºÎ¨∏ÎÇ†Ïßú: ${formatDate(order.orderDate)}</small>
                        <br>
                        <small>ÏàòÎüâ: ${formatNumber(order.quantity)}kg</small>
                        <br>
                        <small>Îã®Í∞Ä: ${formatNumber(order.price)}Ïõê/kg</small>
                        <br>
                        <small>Ï¥ùÏï°: ${formatNumber(order.totalAmount)}Ïõê</small>
                        <br>
                        <small>Î©îÎ™®: ${order.memo || 'ÏóÜÏùå'}</small>
                        <br>
                        <small>Îì±Î°ùÏùº: ${formatDate(order.createdAt)}</small>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deleteOrder('${order.id}')">ÏÇ≠Ï†ú</button>
                    </div>
                `;
                container.appendChild(orderDiv);
            });
        }

        // Ïô∏ÏÉÅ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updateAdvancesList() {
            const container = document.getElementById('advancesList');
            if (!container) return;
            
            container.innerHTML = '<h3>Ïô∏ÏÉÅ Î™©Î°ù</h3>';
            
            if (advances.length === 0) {
                container.innerHTML += '<p>Îì±Î°ùÎêú Ïô∏ÏÉÅÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            // ÏµúÏã†ÏàúÏúºÎ°ú Ï†ïÎ†¨
            const sortedAdvances = [...advances].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            sortedAdvances.forEach(advance => {
                const partner = partners.find(p => p.id === advance.partnerId);
                const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                
                const advanceDiv = document.createElement('div');
                advanceDiv.className = 'partner-item';
                advanceDiv.innerHTML = `
                    <div>
                        <strong>${partnerName}</strong>
                        <br>
                        <small>üìÖ Ïô∏ÏÉÅÎÇ†Ïßú: ${formatDate(advance.advanceDate)}</small>
                        <br>
                        <small>Ïô∏ÏÉÅÍ∏àÏï°: ${formatNumber(advance.amount)}Ïõê</small>
                        <br>
                        <small>Î©îÎ™®: ${advance.memo || 'ÏóÜÏùå'}</small>
                        <br>
                        <small>ÎåÄÏãúÎ≥¥Îìú ÌëúÏãú: ${advance.hidden ? 'Ïà®ÍπÄ' : 'ÌëúÏãú'}</small>
                        <br>
                        <small>Îì±Î°ùÏùº: ${formatDate(advance.createdAt)}</small>
                    </div>
                    <div>
                        <button class="btn" onclick="toggleAdvanceVisibility('${advance.id}')">${advance.hidden ? 'ÌëúÏãú' : 'Ïà®ÍπÄ'}</button>
                        <button class="btn btn-danger" onclick="deleteAdvance('${advance.id}')">ÏÇ≠Ï†ú</button>
                    </div>
                `;
                container.appendChild(advanceDiv);
            });
        }

        // ÏûÖÍ∏à Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updatePaymentsList() {
            const container = document.getElementById('paymentsList');
            if (!container) return;
            
            container.innerHTML = '<h3>ÏûÖÍ∏à Î™©Î°ù</h3>';
            
            if (payments.length === 0) {
                container.innerHTML += '<p>Îì±Î°ùÎêú ÏûÖÍ∏àÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            // ÏµúÏã†ÏàúÏúºÎ°ú Ï†ïÎ†¨
            const sortedPayments = [...payments].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            sortedPayments.forEach(payment => {
                const partner = partners.find(p => p.id === payment.partnerId);
                const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                
                const paymentDiv = document.createElement('div');
                paymentDiv.className = 'partner-item';
                paymentDiv.innerHTML = `
                    <div>
                        <strong>${partnerName}</strong>
                        <br>
                        <small>üìÖ ÏûÖÍ∏àÎÇ†Ïßú: ${formatDate(payment.paymentDate)}</small>
                        <br>
                        <small>ÏûÖÍ∏àÏï°: ${formatNumber(payment.amount)}Ïõê</small>
                        <br>
                        <small>Î©îÎ™®: ${payment.memo || 'ÏóÜÏùå'}</small>
                        <br>
                        <small>Îì±Î°ùÏùº: ${formatDate(payment.createdAt)}</small>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deletePayment('${payment.id}')">ÏÇ≠Ï†ú</button>
                    </div>
                `;
                container.appendChild(paymentDiv);
            });
        }

        // ÏûÖÍ≥† Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updateReceiptsList() {
            const container = document.getElementById('receiptsList');
            if (!container) return;
            
            container.innerHTML = '<h3>ÏûÖÍ≥† Î™©Î°ù</h3>';
            
            if (receipts.length === 0) {
                container.innerHTML += '<p>Îì±Î°ùÎêú ÏûÖÍ≥†Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            // ÏµúÏã†ÏàúÏúºÎ°ú Ï†ïÎ†¨
            const sortedReceipts = [...receipts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            sortedReceipts.forEach(receipt => {
                const partner = partners.find(p => p.id === receipt.partnerId);
                const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                
                const receiptDiv = document.createElement('div');
                receiptDiv.className = 'partner-item';
                receiptDiv.innerHTML = `
                    <div>
                        <strong>${partnerName}</strong>
                        <br>
                        <small>üìÖ ÏûÖÍ≥†ÎÇ†Ïßú: ${formatDate(receipt.receiptDate)}</small>
                        <br>
                        <small>ÏàòÎüâ: ${formatNumber(receipt.quantity)}kg</small>
                        <br>
                        <small>Î©îÎ™®: ${receipt.memo || 'ÏóÜÏùå'}</small>
                        <br>
                        <small>Îì±Î°ùÏùº: ${formatDate(receipt.createdAt)}</small>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deleteReceipt('${receipt.id}')">ÏÇ≠Ï†ú</button>
                    </div>
                `;
                container.appendChild(receiptDiv);
            });
        }

        // Í±∞ÎûòÎÇ¥Ïó≠ ÏóÖÎç∞Ïù¥Ìä∏
        function updateHistoryList() {
            const container = document.getElementById('historyList');
            if (!container) return;
            
            const selectedPartnerId = document.getElementById('historyFilter').value;
            
            container.innerHTML = '<h3>Í±∞ÎûòÎÇ¥Ïó≠</h3>';
            
            // Î™®Îì† Í±∞Îûò Îç∞Ïù¥ÌÑ∞Î•º ÌïòÎÇòÏùò Î∞∞Ïó¥Î°ú ÌÜµÌï©
            let allTransactions = [];
            
            // ÏÑ†Ï£ºÎ¨∏ Ï∂îÍ∞Ä
            orders.forEach(order => {
                const partner = partners.find(p => p.id === order.partnerId);
                if (!selectedPartnerId || order.partnerId === selectedPartnerId) {
                    allTransactions.push({
                        type: 'ÏÑ†Ï£ºÎ¨∏',
                        partner: partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò',
                        amount: order.totalAmount,
                        quantity: order.quantity,
                        price: order.price,
                        memo: order.memo,
                        transactionDate: order.orderDate,
                        date: order.createdAt,
                        icon: 'üì¶'
                    });
                }
            });
            
            // Ïô∏ÏÉÅ Ï∂îÍ∞Ä
            advances.forEach(advance => {
                const partner = partners.find(p => p.id === advance.partnerId);
                if (!selectedPartnerId || advance.partnerId === selectedPartnerId) {
                    allTransactions.push({
                        type: 'Ïô∏ÏÉÅ',
                        partner: partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò',
                        amount: advance.amount,
                        memo: advance.memo,
                        transactionDate: advance.advanceDate,
                        date: advance.createdAt,
                        icon: 'üí≥',
                        hidden: advance.hidden
                    });
                }
            });
            
            // ÏûÖÍ∏à Ï∂îÍ∞Ä
            payments.forEach(payment => {
                const partner = partners.find(p => p.id === payment.partnerId);
                if (!selectedPartnerId || payment.partnerId === selectedPartnerId) {
                    allTransactions.push({
                        type: 'ÏûÖÍ∏à',
                        partner: partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò',
                        amount: payment.amount,
                        memo: payment.memo,
                        transactionDate: payment.paymentDate,
                        date: payment.createdAt,
                        icon: 'üí∞'
                    });
                }
            });
            
            // ÏûÖÍ≥† Ï∂îÍ∞Ä
            receipts.forEach(receipt => {
                const partner = partners.find(p => p.id === receipt.partnerId);
                if (!selectedPartnerId || receipt.partnerId === selectedPartnerId) {
                    allTransactions.push({
                        type: 'ÏûÖÍ≥†',
                        partner: partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò',
                        quantity: receipt.quantity,
                        memo: receipt.memo,
                        transactionDate: receipt.receiptDate,
                        date: receipt.createdAt,
                        icon: 'üì•'
                    });
                }
            });
            
            if (allTransactions.length === 0) {
                container.innerHTML += '<p>Í±∞ÎûòÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            // ÎÇ†ÏßúÏàúÏúºÎ°ú Ï†ïÎ†¨ (ÏµúÏã†Ïàú)
            allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            allTransactions.forEach(transaction => {
                const transactionDiv = document.createElement('div');
                transactionDiv.className = 'partner-item';
                
                let content = `
                    <div>
                        <strong>${transaction.icon} ${transaction.type} - ${transaction.partner}</strong>
                        <br>
                        <small>üìÖ Í±∞ÎûòÎÇ†Ïßú: ${formatDate(transaction.transactionDate)}</small>
                `;
                
                if (transaction.amount) {
                    content += `<br><small>Í∏àÏï°: ${formatNumber(transaction.amount)}Ïõê</small>`;
                }
                
                if (transaction.quantity) {
                    content += `<br><small>ÏàòÎüâ: ${formatNumber(transaction.quantity)}kg</small>`;
                }
                
                if (transaction.price) {
                    content += `<br><small>Îã®Í∞Ä: ${formatNumber(transaction.price)}Ïõê/kg</small>`;
                }
                
                if (transaction.memo) {
                    content += `<br><small>Î©îÎ™®: ${transaction.memo}</small>`;
                }
                
                if (transaction.hidden) {
                    content += `<br><small style="color: #6b7280;">ÎåÄÏãúÎ≥¥Îìú Ïà®ÍπÄ</small>`;
                }
                
                content += `<br><small>Îì±Î°ùÏùº: ${formatDate(transaction.date)}</small>`;
                content += '</div>';
                
                transactionDiv.innerHTML = content;
                container.appendChild(transactionDiv);
            });
        }

        // ÏÑ†Ï£ºÎ¨∏ Ï∂îÍ∞Ä
        async function addOrder() {
            const partnerId = document.getElementById('orderPartner').value;
            const orderDate = document.getElementById('orderDate').value;
            const quantity = parseFloat(document.getElementById('orderQuantity').value);
            const price = parseFloat(document.getElementById('orderPrice').value);
            const memo = document.getElementById('orderMemo').value.trim();

            if (!partnerId) {
                alert('Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }

            if (!orderDate) {
                alert('Ï£ºÎ¨∏ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }

            if (!quantity || quantity <= 0) {
                alert('Ïò¨Î∞îÎ•∏ ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }

            if (!price || price <= 0) {
                alert('Ïò¨Î∞îÎ•∏ Îã®Í∞ÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }

            const order = {
                partnerId: partnerId,
                orderDate: orderDate,
                quantity: quantity,
                price: price,
                totalAmount: quantity * price,
                memo: memo,
                createdAt: new Date().toISOString()
            };

            if (isOnline) {
                const docId = await saveToFirebase(collections.orders, order);
                order.id = docId;
            } else {
                order.id = generateId();
            }

            orders.push(order);
            
            if (!isOnline) {
                saveToLocal();
            }

            // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            document.getElementById('orderPartner').value = '';
            document.getElementById('orderDate').value = '';
            document.getElementById('orderQuantity').value = '';
            document.getElementById('orderPrice').value = '';
            document.getElementById('orderTotal').value = '';
            document.getElementById('orderMemo').value = '';
            
            // Îã¨Î†• Ïà®Í∏∞Í∏∞
            const calendarContainer = document.getElementById('orderPartnerCalendar');
            if (calendarContainer) calendarContainer.style.display = 'none';

            updateOrdersList();
            updateDashboard();
            updateHistoryList();
            alert('ÏÑ†Ï£ºÎ¨∏Ïù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
        }

        // Ïô∏ÏÉÅ Ï∂îÍ∞Ä
        async function addAdvance() {
            const partnerId = document.getElementById('advancePartner').value;
            const advanceDate = document.getElementById('advanceDate').value;
            const amount = parseFloat(document.getElementById('advanceAmount').value);
            const memo = document.getElementById('advanceMemo').value.trim();
            const hidden = document.getElementById('advanceHidden').checked;

            if (!partnerId) {
                alert('Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }

            if (!advanceDate) {
                alert('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }

            if (!amount || amount <= 0) {
                alert('Ïò¨Î∞îÎ•∏ Ïô∏ÏÉÅÍ∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }

            const advance = {
                partnerId: partnerId,
                advanceDate: advanceDate,
                amount: amount,
                memo: memo,
                hidden: hidden,
                createdAt: new Date().toISOString()
            };

            if (isOnline) {
                const docId = await saveToFirebase(collections.advances, advance);
                advance.id = docId;
            } else {
                advance.id = generateId();
            }

            advances.push(advance);
            
            if (!isOnline) {
                saveToLocal();
            }

            // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            document.getElementById('advancePartner').value = '';
            document.getElementById('advanceDate').value = '';
            document.getElementById('advanceAmount').value = '';
            document.getElementById('advanceMemo').value = '';
            document.getElementById('advanceHidden').checked = false;

            updateAdvancesList();
            updateDashboard();
            updateHistoryList();
            alert('Ïô∏ÏÉÅÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
        }

        // ÏûÖÍ∏à Ï∂îÍ∞Ä
        async function addPayment() {
            const partnerId = document.getElementById('paymentPartner').value;
            const paymentDate = document.getElementById('paymentDate').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const memo = document.getElementById('paymentMemo').value.trim();

            if (!partnerId) {
                alert('Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }

            if (!paymentDate) {
                alert('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }

            if (!amount || amount <= 0) {
                alert('Ïò¨Î∞îÎ•∏ ÏûÖÍ∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }

            const payment = {
                partnerId: partnerId,
                paymentDate: paymentDate,
                amount: amount,
                memo: memo,
                createdAt: new Date().toISOString()
            };

            if (isOnline) {
                const docId = await saveToFirebase(collections.payments, payment);
                payment.id = docId;
            } else {
                payment.id = generateId();
            }

            payments.push(payment);
            
            if (!isOnline) {
                saveToLocal();
            }

            // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            document.getElementById('paymentPartner').value = '';
            document.getElementById('paymentDate').value = '';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentMemo').value = '';

            updatePaymentsList();
            updateDashboard();
            updateHistoryList();
            alert('ÏûÖÍ∏àÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
        }

        // ÏûÖÍ≥† Ï∂îÍ∞Ä
        async function addReceipt() {
            const partnerId = document.getElementById('receiptPartner').value;
            const receiptDate = document.getElementById('receiptDate').value;
            const quantity = parseFloat(document.getElementById('receiptQuantity').value);
            const memo = document.getElementById('receiptMemo').value.trim();

            if (!partnerId) {
                alert('Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }

            if (!receiptDate) {
                alert('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }

            if (!quantity || quantity <= 0) {
                alert('Ïò¨Î∞îÎ•∏ ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }

            const receipt = {
                partnerId: partnerId,
                receiptDate: receiptDate,
                quantity: quantity,
                memo: memo,
                createdAt: new Date().toISOString()
            };

            if (isOnline) {
                const docId = await saveToFirebase(collections.receipts, receipt);
                receipt.id = docId;
            } else {
                receipt.id = generateId();
            }

            receipts.push(receipt);
            
            if (!isOnline) {
                saveToLocal();
            }

            // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            document.getElementById('receiptPartner').value = '';
            document.getElementById('receiptDate').value = '';
            document.getElementById('receiptQuantity').value = '';
            document.getElementById('receiptMemo').value = '';

            updateReceiptsList();
            updateDashboard();
            updateHistoryList();
            alert('ÏûÖÍ≥†Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
        }

        // Í±∞ÎûòÏ≤òÎ≥Ñ Ï†ïÎ≥¥ ÌëúÏãú
        function showPartnerInfo(type) {
            let partnerId, infoContainer;
            
            if (type === 'payment') {
                partnerId = document.getElementById('paymentPartner').value;
                infoContainer = document.getElementById('paymentPartnerInfo');
            } else if (type === 'receipt') {
                partnerId = document.getElementById('receiptPartner').value;
                infoContainer = document.getElementById('receiptPartnerInfo');
            }
            
            if (!partnerId || !infoContainer) {
                if (infoContainer) infoContainer.style.display = 'none';
                return;
            }
            
            const partner = partners.find(p => p.id === partnerId);
            if (!partner) {
                infoContainer.style.display = 'none';
                return;
            }
            
            // Í±∞ÎûòÏ≤ò Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞ (ÏßÄÎ∂àÍ¥ÄÎ¶¨ÏóêÏÑúÎäî Ïà®Í≤®ÏßÑ Ïô∏ÏÉÅÎèÑ Ìè¨Ìï®)
            const partnerAdvances = advances.filter(a => a.partnerId === partnerId);
            const totalAdvanceAmount = partnerAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
            const hiddenAdvances = partnerAdvances.filter(a => a.hidden === true);
            const visibleAdvances = partnerAdvances.filter(a => a.hidden !== true);
            
            const partnerOrders = orders.filter(o => o.partnerId === partnerId);
            const totalOrderAmount = partnerOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
            const totalOrderQuantity = partnerOrders.reduce((sum, o) => sum + (o.quantity || 0), 0);
            
            const partnerPayments = payments.filter(p => p.partnerId === partnerId);
            const totalPaymentAmount = partnerPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            
            const partnerReceipts = receipts.filter(r => r.partnerId === partnerId);
            const totalReceiptQuantity = partnerReceipts.reduce((sum, r) => sum + (r.quantity || 0), 0);
            
            // Ïã§Ï†ú Î∞õÏùÑ Í∏àÏï°Í≥º Î∞õÏùÑ Ïû•Ïñ¥
            const actualReceivable = totalOrderAmount + totalAdvanceAmount - totalPaymentAmount;
            const pendingEelQuantity = totalOrderQuantity - totalReceiptQuantity;
            
            let infoHTML = `<strong>${partner.name} Í±∞ÎûòÏ≤ò ÌòÑÌô©</strong><br><br>`;
            
            if (type === 'payment') {
                const hiddenAmount = hiddenAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
                const visibleAmount = visibleAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
                
                infoHTML += `
                    üí∞ <strong>Ï¥ù Ï§Ñ Îèà: ${formatNumber(actualReceivable)}Ïõê</strong><br><br>
                    üí≥ <strong style="color: #dc2626;">Ï¥ù Ïô∏ÏÉÅÍ∏àÏï°: ${formatNumber(totalAdvanceAmount)}Ïõê</strong><br>
                    ${visibleAmount > 0 ? `„ÄÄ‚îî ÌëúÏãúÎêú Ïô∏ÏÉÅ: ${formatNumber(visibleAmount)}Ïõê (${visibleAdvances.length}Í±¥)<br>` : ''}
                    ${hiddenAmount > 0 ? `„ÄÄ‚îî <span style="color: #6b7280;">Ïà®Í≤®ÏßÑ Ïô∏ÏÉÅ: ${formatNumber(hiddenAmount)}Ïõê (${hiddenAdvances.length}Í±¥)</span><br>` : ''}
                    üì¶ ÏÑ†Ï£ºÎ¨∏Í∏àÏï°: ${formatNumber(totalOrderAmount)}Ïõê<br>
                    üí∏ Í∏∞ÏßÄÎ∂àÍ∏àÏï°: ${formatNumber(totalPaymentAmount)}Ïõê<br><br>
                    <small>* ÏßÄÎ∂àÍ¥ÄÎ¶¨ÏóêÏÑúÎäî Î™®Îì† Ïô∏ÏÉÅ(Ïà®ÍπÄ Ìè¨Ìï®)Ïù¥ Í≥ÑÏÇ∞Ïóê Î∞òÏòÅÎê©ÎãàÎã§</small>
                `;
            } else if (type === 'receipt') {
                infoHTML += `
                    üêç <strong>Î∞õÏùÑ Ïû•Ïñ¥: ${formatNumber(pendingEelQuantity)}kg</strong><br>
                    üì¶ ÏÑ†Ï£ºÎ¨∏: ${formatNumber(totalOrderQuantity)}kg<br>
                    üì• Í∏∞ÏûÖÍ≥†: ${formatNumber(totalReceiptQuantity)}kg<br>
                    üí∞ Ï¥ùÏ£ºÎ¨∏Í∏àÏï°: ${formatNumber(totalOrderAmount)}Ïõê
                `;
            }
            
            infoContainer.innerHTML = infoHTML;
            infoContainer.style.display = 'block';
        }

        // Í±∞ÎûòÏ≤òÎ≥Ñ Îã¨Î†• ÌëúÏãú
        function showPartnerCalendar(type) {
            const partnerId = document.getElementById('orderPartner').value;
            const calendarContainer = document.getElementById('orderPartnerCalendar');
            
            if (!partnerId || !calendarContainer) {
                if (calendarContainer) calendarContainer.style.display = 'none';
                return;
            }
            
            const partner = partners.find(p => p.id === partnerId);
            if (!partner) {
                calendarContainer.style.display = 'none';
                return;
            }
            
            renderPartnerCalendar(partnerId, partner.name, calendarContainer);
            calendarContainer.style.display = 'block';
        }

        // Í±∞ÎûòÏ≤òÎ≥Ñ Îã¨Î†• Î†åÎçîÎßÅ
        function renderPartnerCalendar(partnerId, partnerName, container) {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            
            let calendarHTML = `
                <div class="partner-calendar-header">
                    ${partnerName} - ${year}ÎÖÑ ${month + 1}Ïõî Í∞ÄÍ≤© Îã¨Î†•
                </div>
                <div class="partner-calendar-grid">
            `;
            
            // ÏöîÏùº Ìó§Îçî
            const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
            days.forEach(day => {
                calendarHTML += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Îã¨Î†• ÎÇ†ÏßúÎì§
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + (week * 7) + day);
                    
                    const isCurrentMonth = cellDate.getMonth() === month;
                    const dateKey = formatDateKey(cellDate);
                    const priceKey = `${partnerId}_${dateKey}`;
                    const priceInfo = partnerPrices[priceKey];
                    
                    let cellClass = 'partner-calendar-cell';
                    if (!isCurrentMonth) cellClass += ' other-month';
                    if (priceInfo) cellClass += ' has-price';
                    
                    const priceBadge = priceInfo ? 
                        `<div class="calendar-price-badge">${formatNumber(priceInfo.price)}Ïõê</div>` : '';
                    
                    calendarHTML += `
                        <div class="${cellClass}" onclick="selectPartnerCalendarDate('${partnerId}', '${dateKey}', this)">
                            <div>${cellDate.getDate()}</div>
                            ${priceBadge}
                        </div>
                    `;
                }
            }
            
            calendarHTML += `</div>`;
            
            // Í∞ÄÍ≤© ÏûÖÎ†• ÏÑπÏÖò
            calendarHTML += `
                <div class="price-input-section" id="partnerPriceInput_${partnerId}" style="display: none;">
                    <h4>üìÖ <span id="selectedPartnerDate_${partnerId}">ÎÇ†Ïßú ÏÑ†ÌÉù</span> Í∞ÄÍ≤© ÏÑ§Ï†ï</h4>
                    <div class="price-input-group">
                        <input type="number" id="partnerPrice_${partnerId}" placeholder="Îã®Í∞Ä (Ïõê/kg)" min="0" step="100">
                        <input type="text" id="partnerPriceNote_${partnerId}" placeholder="Î©îÎ™® (ÏÑ†ÌÉù)" maxlength="50">
                        <button class="btn" onclick="setPartnerPrice('${partnerId}')">Í∞ÄÍ≤© ÏÑ§Ï†ï</button>
                        <button class="btn btn-danger" onclick="clearPartnerPrice('${partnerId}')">Í∞ÄÍ≤© ÏÇ≠Ï†ú</button>
                    </div>
                </div>
            `;
            
            container.innerHTML = calendarHTML;
        }

        // Í±∞ÎûòÏ≤ò Îã¨Î†• ÎÇ†Ïßú ÏÑ†ÌÉù
        function selectPartnerCalendarDate(partnerId, dateKey, element) {
            // Ïù¥Ï†Ñ ÏÑ†ÌÉù Ï†úÍ±∞
            const container = element.closest('.partner-calendar');
            container.querySelectorAll('.partner-calendar-cell.selected').forEach(cell => {
                cell.classList.remove('selected');
            });
            
            // ÏÉà ÏÑ†ÌÉù Ï∂îÍ∞Ä
            element.classList.add('selected');
            
            // Í∞ÄÍ≤© ÏûÖÎ†• ÏÑπÏÖò ÌëúÏãú
            const priceInputSection = document.getElementById(`partnerPriceInput_${partnerId}`);
            const selectedDateSpan = document.getElementById(`selectedPartnerDate_${partnerId}`);
            const priceInput = document.getElementById(`partnerPrice_${partnerId}`);
            const priceNoteInput = document.getElementById(`partnerPriceNote_${partnerId}`);
            
            const [year, month, day] = dateKey.split('-');
            const selectedDate = new Date(year, month - 1, day);
            selectedDateSpan.textContent = formatDate(selectedDate.toISOString());
            priceInputSection.style.display = 'block';
            
            // Í∏∞Ï°¥ Í∞ÄÍ≤© Ï†ïÎ≥¥ Î°úÎìú
            const priceKey = `${partnerId}_${dateKey}`;
            const priceInfo = partnerPrices[priceKey];
            if (priceInfo) {
                priceInput.value = priceInfo.price;
                priceNoteInput.value = priceInfo.note || '';
            } else {
                priceInput.value = '';
                priceNoteInput.value = '';
            }
            
            // ÏÑ†ÌÉùÌïú Í∞ÄÍ≤©ÏùÑ Îã®Í∞Ä ÌïÑÎìúÏóê ÏûêÎèô ÏûÖÎ†•
            if (priceInfo && priceInfo.price) {
                document.getElementById('orderPrice').value = priceInfo.price;
                // Ï¥ùÏï° Í≥ÑÏÇ∞
                const quantity = parseFloat(document.getElementById('orderQuantity').value) || 0;
                const total = quantity * priceInfo.price;
                document.getElementById('orderTotal').value = total > 0 ? formatNumber(total) + 'Ïõê' : '';
            }
        }

        // Í±∞ÎûòÏ≤òÎ≥Ñ Í∞ÄÍ≤© ÏÑ§Ï†ï
        async function setPartnerPrice(partnerId) {
            const selectedCell = document.querySelector('.partner-calendar-cell.selected');
            if (!selectedCell) {
                alert('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const dateKey = selectedCell.onclick.toString().match(/'([^']+)'/g)[1].replace(/'/g, '');
            const price = parseFloat(document.getElementById(`partnerPrice_${partnerId}`).value);
            const note = document.getElementById(`partnerPriceNote_${partnerId}`).value.trim();
            
            if (!price || price <= 0) {
                alert('Ïò¨Î∞îÎ•∏ Îã®Í∞ÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const priceKey = `${partnerId}_${dateKey}`;
            const priceData = {
                price: price,
                note: note,
                updatedAt: new Date().toISOString()
            };
            
            partnerPrices[priceKey] = priceData;
            
            if (isOnline) {
                await saveToFirebase(collections.partnerPrices, priceData, priceKey);
            } else {
                saveToLocal();
            }
            
            showPartnerCalendar('order'); // Îã¨Î†• Ïû¨Î†åÎçîÎßÅ
            alert('Í∞ÄÍ≤©Ïù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§.');
        }

        // Í±∞ÎûòÏ≤òÎ≥Ñ Í∞ÄÍ≤© ÏÇ≠Ï†ú
        async function clearPartnerPrice(partnerId) {
            const selectedCell = document.querySelector('.partner-calendar-cell.selected');
            if (!selectedCell) {
                alert('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const dateKey = selectedCell.onclick.toString().match(/'([^']+)'/g)[1].replace(/'/g, '');
            const priceKey = `${partnerId}_${dateKey}`;
            
            if (!partnerPrices[priceKey]) {
                alert('ÏÑ§Ï†ïÎêú Í∞ÄÍ≤©Ïù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            if (confirm('Ïù¥ ÎÇ†ÏßúÏùò Í∞ÄÍ≤© Ï†ïÎ≥¥Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                delete partnerPrices[priceKey];
                
                if (isOnline) {
                    await deleteFromFirebase(collections.partnerPrices, priceKey);
                } else {
                    saveToLocal();
                }
                
                showPartnerCalendar('order'); // Îã¨Î†• Ïû¨Î†åÎçîÎßÅ
                alert('Í∞ÄÍ≤©Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            }
        }

        // Ïô∏ÏÉÅ ÌëúÏãú/Ïà®ÍπÄ ÌÜ†Í∏Ä
        async function toggleAdvanceVisibility(id) {
            const advance = advances.find(a => a.id === id);
            if (!advance) return;
            
            advance.hidden = !advance.hidden;
            
            if (isOnline) {
                await saveToFirebase(collections.advances, advance, id);
            } else {
                saveToLocal();
            }
            
            updateAdvancesList();
            updateDashboard();
        }

        // ÏÇ≠Ï†ú Ìï®ÏàòÎì§
        async function deleteOrder(id) {
            if (!confirm('ÏÑ†Ï£ºÎ¨∏ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            if (isOnline) {
                await deleteFromFirebase(collections.orders, id);
            }
            
            orders = orders.filter(o => o.id !== id);
            
            // Ìï≠ÏÉÅ Î°úÏª¨ Ï†ÄÏû•ÏÜåÏóêÎèÑ Ï†ÄÏû• (FirebaseÏôÄ ÎèôÍ∏∞Ìôî)
            saveToLocal();
            
            updateOrdersList();
            updateDashboard();
            updateHistoryList();
            alert('ÏÑ†Ï£ºÎ¨∏Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        }

        async function deleteAdvance(id) {
            if (!confirm('Ïô∏ÏÉÅÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            if (isOnline) {
                await deleteFromFirebase(collections.advances, id);
            }
            
            advances = advances.filter(a => a.id !== id);
            
            // Ìï≠ÏÉÅ Î°úÏª¨ Ï†ÄÏû•ÏÜåÏóêÎèÑ Ï†ÄÏû• (FirebaseÏôÄ ÎèôÍ∏∞Ìôî)
            saveToLocal();
            
            updateAdvancesList();
            updateDashboard();
            updateHistoryList();
            alert('Ïô∏ÏÉÅÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        }

        async function deletePayment(id) {
            if (!confirm('ÏûÖÍ∏àÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            if (isOnline) {
                await deleteFromFirebase(collections.payments, id);
            }
            
            payments = payments.filter(p => p.id !== id);
            
            // Ìï≠ÏÉÅ Î°úÏª¨ Ï†ÄÏû•ÏÜåÏóêÎèÑ Ï†ÄÏû• (FirebaseÏôÄ ÎèôÍ∏∞Ìôî)
            saveToLocal();
            
            updatePaymentsList();
            updateDashboard();
            updateHistoryList();
            alert('ÏûÖÍ∏àÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        }

        async function deleteReceipt(id) {
            if (!confirm('ÏûÖÍ≥†Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            if (isOnline) {
                await deleteFromFirebase(collections.receipts, id);
            }
            
            receipts = receipts.filter(r => r.id !== id);
            
            // Ìï≠ÏÉÅ Î°úÏª¨ Ï†ÄÏû•ÏÜåÏóêÎèÑ Ï†ÄÏû• (FirebaseÏôÄ ÎèôÍ∏∞Ìôî)
            saveToLocal();
            
            updateReceiptsList();
            updateDashboard();
            updateHistoryList();
            alert('ÏûÖÍ≥†Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        }

        // ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä Ìï®Ïàò
        function addSampleData() {
            console.log('ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± Ï§ë...');
            
            // ÏÉòÌîå Í±∞ÎûòÏ≤ò Ï∂îÍ∞Ä
            const samplePartner = {
                id: generateId(),
                name: 'ÌÖåÏä§Ìä∏ Í±∞ÎûòÏ≤ò',
                phone: '010-1234-5678',
                address: 'ÏÑúÏö∏Ïãú Í∞ïÎÇ®Íµ¨',
                memo: 'ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ÏûÖÎãàÎã§',
                createdAt: new Date().toISOString()
            };
            
            partners.push(samplePartner);
            
            // ÏÉòÌîå Ï£ºÎ¨∏ Ï∂îÍ∞Ä
            const sampleOrder = {
                id: generateId(),
                partnerId: samplePartner.id,
                date: new Date().toISOString().split('T')[0],
                quantity: 100,
                price: 30000,
                totalAmount: 3000000,
                createdAt: new Date().toISOString()
            };
            
            orders.push(sampleOrder);
            
            // ÏÉòÌîå Ïô∏ÏÉÅ Ï∂îÍ∞Ä
            const sampleAdvance = {
                id: generateId(),
                partnerId: samplePartner.id,
                date: new Date().toISOString().split('T')[0],
                amount: 500000,
                memo: 'ÏÉòÌîå Ïô∏ÏÉÅ',
                createdAt: new Date().toISOString()
            };
            
            advances.push(sampleAdvance);
            
            // Î°úÏª¨ Ï†ÄÏû•
            saveToLocal();
            console.log('ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± ÏôÑÎ£å');
        }

        // Ï£ºÎ¨∏ Í≥ÑÏÇ∞Í∏∞
        document.addEventListener('DOMContentLoaded', function() {
            const quantityInput = document.getElementById('orderQuantity');
            const priceInput = document.getElementById('orderPrice');
            const totalInput = document.getElementById('orderTotal');

            function calculateTotal() {
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const total = quantity * price;
                totalInput.value = total > 0 ? formatNumber(total) + 'Ïõê' : '';
            }

            if (quantityInput) quantityInput.addEventListener('input', calculateTotal);
            if (priceInput) priceInput.addEventListener('input', calculateTotal);

            // ÎÇ†Ïßú Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = ['orderDate', 'advanceDate', 'paymentDate', 'receiptDate'];
            dateInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) input.value = today;
            });

            // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Î°úÏª¨ Î®ºÏ†Ä, Í∑∏Îã§Ïùå Firebase)
            console.log('ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å - Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî ÏãúÏûë');
            
            // Ïó∞Í≤∞ ÏÉÅÌÉú ÌëúÏãú
            const statusElement = document.querySelector('.connection-status span');
            if (statusElement) {
                statusElement.textContent = 'Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë...';
            }
            
            // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ Î®ºÏ†Ä Î°úÎìú
            loadLocalData();
            console.log('Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÌõÑ partners Ïàò:', partners.length);
            
            // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± (Í∞úÎ∞ú/ÌÖåÏä§Ìä∏Ïö©)
            if (partners.length === 0 && orders.length === 0) {
                console.log('Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùå - ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä');
                addSampleData();
            }
            
            // UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
            updateAllLists();
            
            // Firebase Îç∞Ïù¥ÌÑ∞ Î°úÎìú (ÎπÑÎèôÍ∏∞)
            loadFirebaseData().then(() => {
                console.log('Firebase Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî ÏôÑÎ£å');
                if (statusElement) {
                    statusElement.textContent = isOnline ? 'Firebase Ïó∞Í≤∞Îê®' : 'Ïò§ÌîÑÎùºÏù∏ Î™®Îìú';
                }
            }).catch((error) => {
                console.error('Firebase ÎèôÍ∏∞Ìôî Ïã§Ìå®:', error);
                if (statusElement) {
                    statusElement.textContent = 'Ïò§ÌîÑÎùºÏù∏ Î™®Îìú (Firebase Ïó∞Í≤∞ Ïã§Ìå®)';
                }
            });
        });
    </script>
</body>
</html>