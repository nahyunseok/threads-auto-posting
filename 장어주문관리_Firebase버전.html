<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ ì¥ì–´ ì£¼ë¬¸ê´€ë¦¬ ì‹œìŠ¤í…œ - Firebase í´ë¼ìš°ë“œ ë²„ì „</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #e8f5e8 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .connection-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }

        .status-connected {
            background: #dcfce7;
            color: #166534;
        }

        .status-disconnected {
            background: #fee2e2;
            color: #dc2626;
        }

        .status-loading {
            background: #fef3c7;
            color: #92400e;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab.active {
            background: #3b82f6;
            color: white;
        }

        .tab:hover:not(.active) {
            background: #f3f4f6;
        }

        .content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }

        .content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            font-size: 14px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .btn {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .grid {
            display: grid;
            gap: 20px;
        }

        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #10b981;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .partner-item {
            background: #f8fafc;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .partner-info {
            background: #e0f2fe;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #0ea5e9;
        }

        .quick-price-input {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }

        .dashboard-calendar {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            display: none;
        }

        .dashboard-calendar-header {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 8px;
            background: #3b82f6;
            color: white;
            border-radius: 5px;
            font-size: 12px;
        }

        .dashboard-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .dashboard-calendar-cell {
            padding: 6px;
            text-align: center;
            border: 1px solid #e5e7eb;
            font-size: 10px;
            min-height: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .dashboard-calendar-cell.has-price {
            background: #dcfce7;
        }

        .dashboard-calendar-cell.other-month {
            color: #9ca3af;
            background: #f9fafb;
        }

        .dashboard-price-badge {
            font-size: 8px;
            background: #10b981;
            color: white;
            padding: 1px 2px;
            border-radius: 2px;
            margin-top: 1px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .partner-calendar {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-top: 15px;
            overflow: hidden;
        }

        .partner-calendar-header {
            background: #10b981;
            color: white;
            padding: 10px 15px;
            font-weight: 600;
        }

        .partner-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day-header {
            background: #f8fafc;
            padding: 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #e5e7eb;
            font-size: 12px;
        }

        .partner-calendar-cell {
            padding: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            min-height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .partner-calendar-cell:hover {
            background: #f3f4f6;
        }

        .partner-calendar-cell.selected {
            background: #10b981;
            color: white;
        }

        .partner-calendar-cell.has-price {
            background: #dcfce7;
        }

        .partner-calendar-cell.has-price.selected {
            background: #10b981;
            color: white;
        }

        .partner-calendar-cell.other-month {
            color: #9ca3af;
            background: #f9fafb;
        }

        .calendar-price-badge {
            font-size: 9px;
            background: #10b981;
            color: white;
            padding: 1px 3px;
            border-radius: 2px;
            margin-top: 1px;
        }

        .partner-calendar-cell.selected .calendar-price-badge {
            background: rgba(255,255,255,0.3);
        }

        .price-input-section {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 10px;
            margin: 10px;
        }

        .price-input-section h4 {
            color: #0369a1;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .price-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .price-input-group input {
            flex: 1;
            min-width: 100px;
        }

        .price-input-group .btn {
            margin: 0;
            padding: 8px 12px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .price-input-group {
                flex-direction: column;
            }

            .price-input-group input,
            .price-input-group .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="connectionStatus" class="connection-status status-loading">
                ğŸ”„ Firebase ì—°ê²° í™•ì¸ ì¤‘...
            </div>
            <h1>ğŸ ì¥ì–´ ì£¼ë¬¸ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <p>Firebase í´ë¼ìš°ë“œ ë™ê¸°í™” ë²„ì „ - ëª¨ë“  ê¸°ê¸°ì—ì„œ ë™ì¼í•œ ë°ì´í„°</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
            <button class="tab" onclick="showTab('partners')">ğŸ‘¥ ê±°ë˜ì²˜ ê´€ë¦¬</button>
            <button class="tab" onclick="showTab('orders')">ğŸ“¦ ì„ ì£¼ë¬¸</button>
            <button class="tab" onclick="showTab('advances')">ğŸ’³ ì™¸ìƒê´€ë¦¬</button>
            <button class="tab" onclick="showTab('payments')">ğŸ’° ì…ê¸ˆ</button>
            <button class="tab" onclick="showTab('receipts')">ğŸ“¥ ì…ê³ </button>
            <button class="tab" onclick="showTab('history')">ğŸ“‹ ê±°ë˜ë‚´ì—­</button>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ -->
        <div id="dashboard" class="content active">
            <h2>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>
            <div id="dashboardStats" class="stats-grid">
                <div class="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            </div>
            <div id="dashboardContent">
                <div class="loading">ê±°ë˜ì²˜ ì •ë³´ ë¡œë”© ì¤‘...</div>
            </div>
        </div>

        <!-- ê±°ë˜ì²˜ ê´€ë¦¬ -->
        <div id="partners" class="content">
            <h2>ğŸ‘¥ ê±°ë˜ì²˜ ê´€ë¦¬</h2>
            <div class="grid grid-2">
                <div>
                    <h3>ìƒˆ ê±°ë˜ì²˜ ì¶”ê°€</h3>
                    <div class="form-group">
                        <label>ê±°ë˜ì²˜ëª…</label>
                        <input type="text" id="partnerName" placeholder="ê±°ë˜ì²˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="form-group">
                        <label>ì—°ë½ì²˜</label>
                        <input type="text" id="partnerPhone" placeholder="ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="form-group">
                        <label>ì£¼ì†Œ</label>
                        <textarea id="partnerAddress" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ë©”ëª¨</label>
                        <textarea id="partnerMemo" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </div>
                    <button class="btn" onclick="addPartner()">ê±°ë˜ì²˜ ì¶”ê°€</button>
                </div>
                <div id="partnersList">
                    <div class="loading">ê±°ë˜ì²˜ ëª©ë¡ ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- ì„ ì£¼ë¬¸ -->
        <div id="orders" class="content">
            <h2>ğŸ“¦ ì„ ì£¼ë¬¸ ê´€ë¦¬</h2>
            <div class="grid grid-2">
                <div>
                    <h3>ìƒˆ ì„ ì£¼ë¬¸ ì¶”ê°€</h3>
                    <div class="form-group">
                        <label>ê±°ë˜ì²˜</label>
                        <select id="orderPartner" onchange="showPartnerCalendar('order')">
                            <option value="">ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì£¼ë¬¸ë‚ ì§œ</label>
                        <input type="date" id="orderDate">
                    </div>
                    <div class="form-group">
                        <label>ìˆ˜ëŸ‰ (kg)</label>
                        <input type="number" id="orderQuantity" placeholder="ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="form-group">
                        <label>ë‹¨ê°€ (ì›/kg)</label>
                        <input type="number" id="orderPrice" placeholder="ë‹¨ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="form-group">
                        <label>ì´ì•¡</label>
                        <input type="text" id="orderTotal" readonly>
                    </div>
                    <div class="form-group">
                        <label>ë©”ëª¨</label>
                        <textarea id="orderMemo" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </div>
                    <button class="btn" onclick="addOrder()">ì„ ì£¼ë¬¸ ì¶”ê°€</button>
                    <div id="orderPartnerCalendar" class="partner-calendar" style="display: none;">
                        <!-- ê±°ë˜ì²˜ë³„ ë‹¬ë ¥ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
                <div id="ordersList">
                    <div class="loading">ì„ ì£¼ë¬¸ ëª©ë¡ ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- ì™¸ìƒê´€ë¦¬ -->
        <div id="advances" class="content">
            <h2>ğŸ’³ ì™¸ìƒê´€ë¦¬</h2>
            <div class="grid grid-2">
                <div>
                    <h3>ìƒˆ ì™¸ìƒ ì¶”ê°€</h3>
                    <div class="form-group">
                        <label>ê±°ë˜ì²˜</label>
                        <select id="advancePartner">
                            <option value="">ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ë‚ ì§œ</label>
                        <input type="date" id="advanceDate">
                    </div>
                    <div class="form-group">
                        <label>ì™¸ìƒê¸ˆì•¡ (ì›)</label>
                        <input type="number" id="advanceAmount" placeholder="ì™¸ìƒê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="form-group">
                        <label>ë©”ëª¨</label>
                        <textarea id="advanceMemo" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="advanceHidden"> ëŒ€ì‹œë³´ë“œì—ì„œ ìˆ¨ê¸°ê¸°
                        </label>
                    </div>
                    <button class="btn" onclick="addAdvance()">ì™¸ìƒ ì¶”ê°€</button>
                </div>
                <div id="advancesList">
                    <div class="loading">ì™¸ìƒ ëª©ë¡ ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- ì…ê¸ˆ -->
        <div id="payments" class="content">
            <h2>ğŸ’° ì…ê¸ˆ ê´€ë¦¬</h2>
            <div class="grid grid-2">
                <div>
                    <h3>ìƒˆ ì…ê¸ˆ ì¶”ê°€</h3>
                    <div class="form-group">
                        <label>ê±°ë˜ì²˜</label>
                        <select id="paymentPartner" onchange="showPartnerInfo('payment')">
                            <option value="">ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div id="paymentPartnerInfo" class="partner-info" style="display: none;">
                        <!-- ê±°ë˜ì²˜ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    <div class="form-group">
                        <label>ë‚ ì§œ</label>
                        <input type="date" id="paymentDate">
                    </div>
                    <div class="form-group">
                        <label>ì…ê¸ˆì•¡ (ì›)</label>
                        <input type="number" id="paymentAmount" placeholder="ì…ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="form-group">
                        <label>ë©”ëª¨</label>
                        <textarea id="paymentMemo" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </div>
                    <button class="btn" onclick="addPayment()">ì…ê¸ˆ ì¶”ê°€</button>
                </div>
                <div id="paymentsList">
                    <div class="loading">ì…ê¸ˆ ëª©ë¡ ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- ì…ê³  ê´€ë¦¬ -->
        <div id="receipts" class="content">
            <h2>ğŸ“¥ ì…ê³  ê´€ë¦¬</h2>
            <div class="grid grid-2">
                <div>
                    <h3>ìƒˆ ì…ê³  ì¶”ê°€</h3>
                    <div class="form-group">
                        <label>ê±°ë˜ì²˜</label>
                        <select id="receiptPartner" onchange="showPartnerInfo('receipt')">
                            <option value="">ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div id="receiptPartnerInfo" class="partner-info" style="display: none;">
                        <!-- ê±°ë˜ì²˜ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    <div class="form-group">
                        <label>ë‚ ì§œ</label>
                        <input type="date" id="receiptDate">
                    </div>
                    <div class="form-group">
                        <label>ìˆ˜ëŸ‰ (kg)</label>
                        <input type="number" id="receiptQuantity" placeholder="ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="form-group">
                        <label>ë©”ëª¨</label>
                        <textarea id="receiptMemo" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </div>
                    <button class="btn" onclick="addReceipt()">ì…ê³  ì¶”ê°€</button>
                </div>
                <div id="receiptsList">
                    <div class="loading">ì…ê³  ëª©ë¡ ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- ê±°ë˜ë‚´ì—­ -->
        <div id="history" class="content">
            <h2>ğŸ“‹ ê±°ë˜ë‚´ì—­</h2>
            <div class="form-group">
                <label>ê±°ë˜ì²˜ í•„í„°</label>
                <select id="historyFilter" onchange="updateHistoryList()">
                    <option value="">ì „ì²´ ê±°ë˜ì²˜</option>
                </select>
            </div>
            <div id="historyList">
                <div class="loading">ê±°ë˜ë‚´ì—­ ë¡œë”© ì¤‘...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (ëª¨ë“ˆ ë°©ì‹) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase ì„¤ì • (ì‹¤ì œ jangeo-trade í”„ë¡œì íŠ¸ ì„¤ì •)
        const firebaseConfig = {
            apiKey: "AIzaSyCXjZ8Gi5fDBUDzqM29V-BtLluiTECcUQM",
            authDomain: "jangeo-trade.firebaseapp.com",
            projectId: "jangeo-trade",
            storageBucket: "jangeo-trade.firebasestorage.app",
            messagingSenderId: "783900173125",
            appId: "1:783900173125:web:d57cbfe31e178d0ba8d42c"
        };

        // Firebase ì´ˆê¸°í™”
        let app, db;
        let isOnline = false;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            isOnline = true;
            updateConnectionStatus(true);
            console.log('Firebase ì´ˆê¸°í™” ì„±ê³µ');
            
            // ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì •
            window.db = db;
            window.isOnline = isOnline;
            window.firebaseModules = { collection, addDoc, getDocs, doc, setDoc, deleteDoc };
            
            // ë°ì´í„° ë¡œë“œ
            loadFirebaseData();
        } catch (error) {
            console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            updateConnectionStatus(false);
            initLocalStorage();
        }
    </script>

    <script>
        // ì „ì—­ ë³€ìˆ˜ë“¤ (ëª¨ë“ˆì—ì„œ ì„¤ì •ë¨)
        let db = window.db;
        let isOnline = window.isOnline || false;

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.className = 'connection-status status-connected';
                statusElement.textContent = 'ğŸŒ Firebase í´ë¼ìš°ë“œ ì—°ê²°ë¨ - ì‹¤ì‹œê°„ ë™ê¸°í™” í™œì„±';
                isOnline = true;
            } else {
                statusElement.className = 'connection-status status-disconnected';
                statusElement.textContent = 'ğŸ”´ Firebase ì—°ê²° ì‹¤íŒ¨ - ë¡œì»¬ ì €ì¥ì†Œ ì‚¬ìš©';
                isOnline = false;
            }
        }

        // ì „ì—­ ë°ì´í„° ë³€ìˆ˜ë“¤
        let partners = [];
        let orders = [];
        let advances = [];
        let payments = [];
        let receipts = [];
        let partnerPrices = {};

        // ì»¬ë ‰ì…˜ ì°¸ì¡°
        const collections = {
            partners: 'partners',
            orders: 'orders',
            advances: 'advances',
            payments: 'payments',
            receipts: 'receipts',
            partnerPrices: 'partnerPrices'
        };

        // Firebase ë°ì´í„° ë¡œë“œ
        async function loadFirebaseData() {
            if (!isOnline || !window.firebaseModules) {
                console.log('ì˜¤í”„ë¼ì¸ ëª¨ë“œ - ë¡œì»¬ ë°ì´í„° ë¡œë“œ');
                loadLocalData();
                return;
            }

            try {
                console.log('Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
                const { collection, getDocs } = window.firebaseModules;
                
                // ëª¨ë“  ì»¬ë ‰ì…˜ ë³‘ë ¬ ë¡œë“œ
                const [
                    partnersSnapshot,
                    ordersSnapshot,
                    advancesSnapshot,
                    paymentsSnapshot,
                    receiptsSnapshot,
                    pricesSnapshot
                ] = await Promise.all([
                    getDocs(collection(db, collections.partners)),
                    getDocs(collection(db, collections.orders)),
                    getDocs(collection(db, collections.advances)),
                    getDocs(collection(db, collections.payments)),
                    getDocs(collection(db, collections.receipts)),
                    getDocs(collection(db, collections.partnerPrices))
                ]);

                // Firebase ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë³€í™˜
                const firebasePartners = partnersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const firebaseOrders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const firebaseAdvances = advancesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const firebasePayments = paymentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const firebaseReceipts = receiptsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // ê°€ê²© ë°ì´í„°ëŠ” ê°ì²´ë¡œ ë³€í™˜
                const firebasePrices = {};
                pricesSnapshot.docs.forEach(doc => {
                    firebasePrices[doc.id] = doc.data();
                });

                console.log('Firebaseì—ì„œ ë¡œë“œëœ ë°ì´í„°:', {
                    partners: firebasePartners.length,
                    orders: firebaseOrders.length,
                    advances: firebaseAdvances.length,
                    payments: firebasePayments.length,
                    receipts: receipts.length,
                    prices: Object.keys(firebasePrices).length
                });

                // ë¡œì»¬ ë°ì´í„°ì™€ ë³‘í•© (Firebase ë°ì´í„° ìš°ì„ )
                partners = firebasePartners.length > 0 ? firebasePartners : partners;
                orders = firebaseOrders.length > 0 ? firebaseOrders : orders;
                advances = firebaseAdvances.length > 0 ? firebaseAdvances : advances;
                payments = firebasePayments.length > 0 ? firebasePayments : payments;
                receipts = firebaseReceipts.length > 0 ? firebaseReceipts : receipts;
                partnerPrices = Object.keys(firebasePrices).length > 0 ? firebasePrices : partnerPrices;

                // ë³‘í•©ëœ ë°ì´í„°ë¥¼ ë¡œì»¬ì—ë„ ì €ì¥ (ë™ê¸°í™”)
                saveToLocal();

                console.log('ìµœì¢… ë°ì´í„° (Firebase ìš°ì„  ë³‘í•©):', {
                    partners: partners.length,
                    orders: orders.length,
                    advances: advances.length,
                    payments: payments.length,
                    receipts: receipts.length,
                    prices: Object.keys(partnerPrices).length
                });

                updateAllLists();
                
            } catch (error) {
                console.error('Firebase ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                // Firebase ì‹¤íŒ¨ ì‹œ localStorageë¡œ í´ë°±
                console.log('Firebase ì‹¤íŒ¨ - ë¡œì»¬ ë°ì´í„°ë¡œ í´ë°±');
                loadLocalData();
            }
        }

        // Firestoreì— ë°ì´í„° ì €ì¥
        async function saveToFirebase(collectionName, data, docId = null) {
            if (!isOnline || !window.firebaseModules) {
                return saveToLocal();
            }

            try {
                const { collection, addDoc, doc, setDoc } = window.firebaseModules;
                
                if (docId) {
                    await setDoc(doc(db, collectionName, docId), data);
                } else {
                    const docRef = await addDoc(collection(db, collectionName), data);
                    return docRef.id;
                }
            } catch (error) {
                console.error(`${collectionName} ì €ì¥ ì‹¤íŒ¨:`, error);
                // Firebase ì‹¤íŒ¨ ì‹œ localStorageì— ì €ì¥
                saveToLocal();
            }
        }

        // Firestoreì—ì„œ ë°ì´í„° ì‚­ì œ
        async function deleteFromFirebase(collectionName, docId) {
            if (!isOnline || !window.firebaseModules) {
                console.log('ì˜¤í”„ë¼ì¸ ëª¨ë“œ ë˜ëŠ” Firebase ì—†ìŒ - ë¡œì»¬ì—ì„œë§Œ ì²˜ë¦¬');
                return; // ì˜¤í”„ë¼ì¸ì¼ ë•ŒëŠ” ì—ëŸ¬ê°€ ì•„ë‹˜
            }

            try {
                const { doc, deleteDoc } = window.firebaseModules;
                console.log(`Firebaseì—ì„œ ${collectionName} ì‚­ì œ ì¤‘:`, docId);
                await deleteDoc(doc(db, collectionName, docId));
                console.log(`Firebase ${collectionName} ì‚­ì œ ì™„ë£Œ:`, docId);
            } catch (error) {
                console.error(`${collectionName} Firebase ì‚­ì œ ì‹¤íŒ¨:`, error);
                // Firebase ì‚­ì œ ì‹¤íŒ¨ì‹œ ì—ëŸ¬ë¥¼ ë‹¤ì‹œ throwí•˜ì—¬ ìƒìœ„ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬
                throw new Error(`Firebaseì—ì„œ ${collectionName} ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // localStorage í´ë°± í•¨ìˆ˜ë“¤
        function initLocalStorage() {
            loadLocalData();
        }

        function loadLocalData() {
            partners = JSON.parse(localStorage.getItem('eel_partners') || '[]');
            orders = JSON.parse(localStorage.getItem('eel_orders') || '[]');
            advances = JSON.parse(localStorage.getItem('eel_advances') || '[]');
            payments = JSON.parse(localStorage.getItem('eel_payments') || '[]');
            receipts = JSON.parse(localStorage.getItem('eel_receipts') || '[]');
            partnerPrices = JSON.parse(localStorage.getItem('eel_partnerPrices') || '{}');
            
            updateAllLists();
        }

        function saveToLocal() {
            localStorage.setItem('eel_partners', JSON.stringify(partners));
            localStorage.setItem('eel_orders', JSON.stringify(orders));
            localStorage.setItem('eel_advances', JSON.stringify(advances));
            localStorage.setItem('eel_payments', JSON.stringify(payments));
            localStorage.setItem('eel_receipts', JSON.stringify(receipts));
            localStorage.setItem('eel_partnerPrices', JSON.stringify(partnerPrices));
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        function formatNumber(number) {
            return Number(number).toLocaleString('ko-KR');
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        function formatDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        // íƒ­ ì „í™˜
        function showTab(tabName) {
            // ëª¨ë“  íƒ­ê³¼ ì½˜í…ì¸  ë¹„í™œì„±í™”
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            
            // ì„ íƒëœ íƒ­ê³¼ ì½˜í…ì¸  í™œì„±í™”
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // ê±°ë˜ì²˜ ì¶”ê°€
        async function addPartner() {
            const name = document.getElementById('partnerName').value.trim();
            const phone = document.getElementById('partnerPhone').value.trim();
            const address = document.getElementById('partnerAddress').value.trim();
            const memo = document.getElementById('partnerMemo').value.trim();

            if (!name) {
                alert('ê±°ë˜ì²˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            console.log('ê±°ë˜ì²˜ ì¶”ê°€ ì‹œì‘:', name);

            const partner = {
                name: name,
                phone: phone,
                address: address,
                memo: memo,
                createdAt: new Date().toISOString()
            };

            try {
                // Firebaseì— ì €ì¥ ì‹œë„ (ì˜¨ë¼ì¸ì¼ ë•Œ)
                if (isOnline && window.firebaseModules) {
                    console.log('Firebaseì— ê±°ë˜ì²˜ ì €ì¥ ì¤‘...');
                    const docId = await saveToFirebase(collections.partners, partner);
                    partner.id = docId;
                    console.log('Firebase ì €ì¥ ì™„ë£Œ, ID:', docId);
                } else {
                    console.log('ì˜¤í”„ë¼ì¸ ëª¨ë“œ - ë¡œì»¬ ID ìƒì„±');
                    partner.id = generateId();
                }

                // ë¡œì»¬ ë°°ì—´ì— ì¶”ê°€
                partners.push(partner);
                console.log('ê±°ë˜ì²˜ ë°°ì—´ì— ì¶”ê°€ ì™„ë£Œ, ì´ ê°œìˆ˜:', partners.length);
                
                // í•­ìƒ ë¡œì»¬ ì €ì¥ì†Œì—ë„ ì €ì¥ (ë™ê¸°í™” ë³´ì¥)
                saveToLocal();
                console.log('ë¡œì»¬ ì €ì¥ì†Œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');

            } catch (error) {
                console.error('ê±°ë˜ì²˜ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜:', error);
                // Firebase ì‹¤íŒ¨ì‹œ ë¡œì»¬ì—ë§Œ ì €ì¥
                partner.id = generateId();
                partners.push(partner);
                saveToLocal();
                console.log('Firebase ì‹¤íŒ¨ - ë¡œì»¬ì—ë§Œ ì €ì¥');
            }

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('partnerName').value = '';
            document.getElementById('partnerPhone').value = '';
            document.getElementById('partnerAddress').value = '';
            document.getElementById('partnerMemo').value = '';

            updatePartnersList();
            updateSelects();
            updateDashboard();
            alert('ê±°ë˜ì²˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ëª¨ë“  ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateAllLists() {
            updateDashboard();
            updatePartnersList();
            updateOrdersList();
            updateAdvancesList();
            updatePaymentsList();
            updateReceiptsList();
            updateHistoryList();
            updateSelects();
        }

        // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        function updateDashboard() {
            updateDashboardStats();
            updateDashboardContent();
        }

        function updateDashboardStats() {
            const statsContainer = document.getElementById('dashboardStats');
            
            // ëŒ€ì‹œë³´ë“œìš© ì™¸ìƒ (ìˆ¨ê²¨ì§„ ê²ƒ ì œì™¸)
            const visibleAdvances = advances.filter(a => a.hidden !== true);
            const totalAdvanceAmount = visibleAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
            
            // ì´ ì£¼ë¬¸ ê¸ˆì•¡ê³¼ ìˆ˜ëŸ‰
            const totalOrderAmount = orders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
            const totalOrderQuantity = orders.reduce((sum, o) => sum + (o.quantity || 0), 0);
            
            // ì´ ì…ê¸ˆ ê¸ˆì•¡
            const totalPaymentAmount = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
            
            // ì´ ì…ê³  ìˆ˜ëŸ‰
            const totalReceiptQuantity = receipts.reduce((sum, r) => sum + (r.quantity || 0), 0);
            
            // ì‹¤ì œ ì¤„ ëˆê³¼ ë°›ì„ ì¥ì–´
            const totalAmountToPay = totalOrderAmount + totalAdvanceAmount - totalPaymentAmount;
            const totalEelToReceive = totalOrderQuantity - totalReceiptQuantity;
            
            statsContainer.innerHTML = `
                <div class="stat-card" style="border-left-color: #ef4444;">
                    <div class="stat-number" style="color: #ef4444;">${formatNumber(totalAmountToPay)}ì›</div>
                    <div>ğŸ’° ì´ ì¤„ ëˆ</div>
                </div>
                <div class="stat-card" style="border-left-color: #10b981;">
                    <div class="stat-number" style="color: #10b981;">${formatNumber(totalEelToReceive)}kg</div>
                    <div>ğŸ ì´ ë°›ì„ ì¥ì–´</div>
                </div>
                <div class="stat-card" style="border-left-color: #f59e0b;">
                    <div class="stat-number" style="color: #f59e0b;">${partners.length}ê°œ</div>
                    <div>ğŸ‘¥ ê±°ë˜ì²˜</div>
                </div>
                <div class="stat-card" style="border-left-color: #8b5cf6;">
                    <div class="stat-number" style="color: #8b5cf6;">${orders.length}ê±´</div>
                    <div>ğŸ“¦ ì„ ì£¼ë¬¸</div>
                </div>
            `;
        }

        function updateDashboardContent() {
            const container = document.getElementById('dashboardContent');
            
            if (partners.length === 0) {
                container.innerHTML = '<p>ë“±ë¡ëœ ê±°ë˜ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤. ê±°ë˜ì²˜ë¥¼ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            // ê±°ë˜ì²˜ë³„ ë°ì´í„° ê³„ì‚°
            const partnerData = partners.map(partner => {
                // ëŒ€ì‹œë³´ë“œì—ì„œëŠ” ìˆ¨ê²¨ì§„ ì™¸ìƒ ì œì™¸
                const partnerAdvances = advances.filter(a => a.partnerId === partner.id && a.hidden !== true);
                const totalAdvanceAmount = partnerAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
                
                const partnerOrders = orders.filter(o => o.partnerId === partner.id);
                const totalOrderAmount = partnerOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
                const totalOrderQuantity = partnerOrders.reduce((sum, o) => sum + (o.quantity || 0), 0);
                
                const partnerPayments = payments.filter(p => p.partnerId === partner.id);
                const totalPaymentAmount = partnerPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
                
                const partnerReceipts = receipts.filter(r => r.partnerId === partner.id);
                const totalReceiptQuantity = partnerReceipts.reduce((sum, r) => sum + (r.quantity || 0), 0);
                
                // ì‹¤ì œ ì¤„ ëˆê³¼ ë°›ì„ ì¥ì–´
                const amountToPay = totalOrderAmount + totalAdvanceAmount - totalPaymentAmount;
                const eelToReceive = totalOrderQuantity - totalReceiptQuantity;
                
                return {
                    partner,
                    amountToPay,
                    eelToReceive,
                    hasData: amountToPay !== 0 || eelToReceive !== 0
                };
            }).filter(data => data.hasData); // ê±°ë˜ê°€ ìˆëŠ” ê±°ë˜ì²˜ë§Œ í‘œì‹œ

            let contentHTML = '<h3>ğŸ¢ ì£¼ìš” ê±°ë˜ì²˜ í˜„í™©</h3>';
            
            if (partnerData.length === 0) {
                contentHTML += '<p>ê±°ë˜ ë‚´ì—­ì´ ìˆëŠ” ê±°ë˜ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                partnerData.forEach(data => {
                    const statusColor = data.amountToPay > 0 ? '#ef4444' : '#10b981';
                    const eelColor = data.eelToReceive > 0 ? '#10b981' : '#6b7280';
                    
                    contentHTML += `
                        <div class="partner-item">
                            <div>
                                <strong style="font-size: 16px;">${data.partner.name}</strong>
                                <div style="margin-top: 8px;">
                                    <span style="color: ${statusColor}; font-weight: bold;">ğŸ’° ${formatNumber(data.amountToPay)}ì›</span>
                                    <span style="margin-left: 15px; color: ${eelColor}; font-weight: bold;">ğŸ ${formatNumber(data.eelToReceive)}kg</span>
                                </div>
                                <div class="quick-price-input">
                                    <input type="number" id="quickPrice_${data.partner.id}" placeholder="ë‹¨ê°€" style="width: 70px; padding: 4px 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px;">
                                    <button class="btn" onclick="setQuickPrice('${data.partner.id}')" style="padding: 4px 8px; font-size: 11px; background: #10b981;">ì €ì¥</button>
                                    <button class="btn" onclick="toggleQuickCalendar('${data.partner.id}')" style="padding: 4px 8px; font-size: 11px; background: #3b82f6;">ğŸ“… ë‹¬ë ¥</button>
                                </div>
                                <div id="quickCalendar_${data.partner.id}" class="dashboard-calendar" style="display: none;">
                                    <!-- ë‹¬ë ¥ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = contentHTML;
        }

        // ë¹ ë¥¸ ë‹¨ê°€ ì €ì¥
        async function setQuickPrice(partnerId) {
            const priceInput = document.getElementById(`quickPrice_${partnerId}`);
            const price = parseFloat(priceInput.value);
            
            if (!price || price <= 0) {
                alert('ì˜¬ë°”ë¥¸ ë‹¨ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            const today = new Date();
            const dateKey = formatDateKey(today);
            const priceKey = `${partnerId}_${dateKey}`;
            
            const priceData = {
                price: price,
                note: 'ëŒ€ì‹œë³´ë“œì—ì„œ ë¹ ë¥¸ ì…ë ¥',
                updatedAt: new Date().toISOString()
            };
            
            partnerPrices[priceKey] = priceData;
            
            if (isOnline) {
                await saveToFirebase(collections.partnerPrices, priceData, priceKey);
            } else {
                saveToLocal();
            }
            
            priceInput.value = '';
            renderQuickCalendar(partnerId);
            alert('ì˜¤ëŠ˜ ë‹¨ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ë¹ ë¥¸ ë‹¬ë ¥ í† ê¸€
        function toggleQuickCalendar(partnerId) {
            const calendar = document.getElementById(`quickCalendar_${partnerId}`);
            if (!calendar) return;
            
            if (calendar.style.display === 'none' || calendar.style.display === '') {
                calendar.style.display = 'block';
                setTimeout(() => renderQuickCalendar(partnerId), 10);
            } else {
                calendar.style.display = 'none';
            }
        }

        // ë¹ ë¥¸ ë‹¬ë ¥ ë Œë”ë§
        function renderQuickCalendar(partnerId) {
            const calendar = document.getElementById(`quickCalendar_${partnerId}`);
            if (!calendar) return;
            
            const partner = partners.find(p => p.id === partnerId);
            if (!partner) return;
            
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            
            let calendarHTML = `
                <div class="dashboard-calendar-header">
                    ${partner.name} - ${year}ë…„ ${month + 1}ì›”
                </div>
                <div class="dashboard-calendar-grid">
            `;
            
            // ìš”ì¼ í—¤ë”
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            days.forEach(day => {
                calendarHTML += `<div style="background: #f8fafc; padding: 3px; text-align: center; font-weight: 600; border: 1px solid #e5e7eb; font-size: 9px;">${day}</div>`;
            });
            
            // ë‹¬ë ¥ ë‚ ì§œë“¤
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + (week * 7) + day);
                    
                    const isCurrentMonth = cellDate.getMonth() === month;
                    const dateKey = formatDateKey(cellDate);
                    const priceKey = `${partnerId}_${dateKey}`;
                    const priceInfo = partnerPrices[priceKey];
                    
                    let cellClass = 'dashboard-calendar-cell';
                    if (!isCurrentMonth) cellClass += ' other-month';
                    if (priceInfo) cellClass += ' has-price';
                    
                    const priceBadge = priceInfo ? 
                        `<div class="dashboard-price-badge">${formatNumber(priceInfo.price)}</div>` : '';
                    
                    calendarHTML += `
                        <div class="${cellClass}" style="min-height: 25px; padding: 2px;">
                            <div style="font-size: 9px;">${cellDate.getDate()}</div>
                            ${priceBadge}
                        </div>
                    `;
                }
            }
            
            calendarHTML += `</div>`;
            calendar.innerHTML = calendarHTML;
        }

        // select ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateSelects() {
            const selects = ['orderPartner', 'advancePartner', 'paymentPartner', 'receiptPartner', 'historyFilter'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                const isHistoryFilter = selectId === 'historyFilter';
                
                select.innerHTML = isHistoryFilter ? 
                    '<option value="">ì „ì²´ ê±°ë˜ì²˜</option>' : 
                    '<option value="">ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                
                partners.forEach(partner => {
                    const option = document.createElement('option');
                    option.value = partner.id;
                    option.textContent = partner.name;
                    if (currentValue === partner.id) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });
        }

        // ê±°ë˜ì²˜ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updatePartnersList() {
            const container = document.getElementById('partnersList');
            if (!container) return;
            
            container.innerHTML = '<h3>ê±°ë˜ì²˜ ëª©ë¡</h3>';
            
            if (partners.length === 0) {
                container.innerHTML += '<p>ë“±ë¡ëœ ê±°ë˜ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            partners.forEach(partner => {
                const partnerDiv = document.createElement('div');
                partnerDiv.className = 'partner-item';
                partnerDiv.innerHTML = `
                    <div>
                        <strong>${partner.name}</strong>
                        <br>
                        <small>ğŸ“ ${partner.phone || 'ì—†ìŒ'}</small>
                        <br>
                        <small>ğŸ“ ${partner.address || 'ì—†ìŒ'}</small>
                        <br>
                        <small>ğŸ“ ${partner.memo || 'ì—†ìŒ'}</small>
                        <br>
                        <small>ë“±ë¡ì¼: ${formatDate(partner.createdAt)}</small>
                    </div>
                    <div>
                        <button class="btn" onclick="editPartner('${partner.id}')">ìˆ˜ì •</button>
                        <button class="btn btn-danger" onclick="immediateDeletePartner('${partner.id}', '${partner.name}')">ì‚­ì œ</button>
                    </div>
                `;
                container.appendChild(partnerDiv);
            });
        }

        // ê±°ë˜ì²˜ ìˆ˜ì •
        async function editPartner(id) {
            const partner = partners.find(p => p.id === id);
            if (!partner) return;
            
            const newName = prompt('ê±°ë˜ì²˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', partner.name);
            if (newName === null) return;
            
            if (!newName.trim()) {
                alert('ê±°ë˜ì²˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            const newContact = prompt('ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', partner.contact || '');
            const newMemo = prompt('ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', partner.memo || '');
            
            // íŒŒíŠ¸ë„ˆ ì •ë³´ ì—…ë°ì´íŠ¸
            partner.name = newName.trim();
            partner.contact = newContact ? newContact.trim() : '';
            partner.memo = newMemo ? newMemo.trim() : '';
            partner.updatedAt = new Date().toISOString();
            
            try {
                // Firebaseì— ì—…ë°ì´íŠ¸
                if (isOnline) {
                    await saveToFirebase(collections.partners, partner, id);
                }
                
                // ë¡œì»¬ ì €ì¥ì†Œì—ë„ ì €ì¥
                saveToLocal();
                
                // UI ì—…ë°ì´íŠ¸
                updatePartnersList();
                updateSelects();
                
                alert('ê±°ë˜ì²˜ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ê±°ë˜ì²˜ ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert('ê±°ë˜ì²˜ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¦‰ì‹œ ì‚­ì œ í•¨ìˆ˜ (ë””ë²„ê¹… ê°•í™”)
        function immediateDeletePartner(id, name) {
            console.log('=== ì‚­ì œ í•¨ìˆ˜ í˜¸ì¶œë¨ ===', id, name);
            
            if (!id) {
                console.error('IDê°€ ì—†ìŠµë‹ˆë‹¤!');
                alert('ì˜¤ë¥˜: ê±°ë˜ì²˜ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm(`${name} ê±°ë˜ì²˜ë¥¼ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                console.log('ì‚¬ìš©ìê°€ ì‚­ì œë¥¼ ì·¨ì†Œí•¨');
                return;
            }
            
            console.log('=== ì¦‰ì‹œ ì‚­ì œ ì‹œì‘ ===', name, id);
            console.log('ì‚­ì œ ì „ partners ë°°ì—´:', partners);
            console.log('ì‚­ì œí•  IDë¡œ ê²€ìƒ‰í•œ ê±°ë˜ì²˜:', partners.find(p => p.id === id));
            
            // 1. ë°°ì—´ì—ì„œ ì¦‰ì‹œ ì œê±° (ID íƒ€ì… ë¬¸ì œ í•´ê²°)
            const beforeCount = partners.length;
            const originalPartners = [...partners];
            
            // ë¬¸ìì—´ê³¼ ìˆ«ì ID ëª¨ë‘ ì²˜ë¦¬
            partners = partners.filter(p => {
                const match = (String(p.id) === String(id));
                if (match) {
                    console.log('ì‚­ì œë˜ëŠ” ê±°ë˜ì²˜:', p);
                }
                return !match;
            });
            
            orders = orders.filter(o => String(o.partnerId) !== String(id));
            advances = advances.filter(a => String(a.partnerId) !== String(id));
            payments = payments.filter(p => String(p.partnerId) !== String(id));
            receipts = receipts.filter(r => String(r.partnerId) !== String(id));
            
            console.log(`ê±°ë˜ì²˜ ìˆ˜: ${beforeCount} -> ${partners.length}`);
            console.log('ì‚­ì œ í›„ partners ë°°ì—´:', partners);
            
            if (beforeCount === partners.length) {
                console.error('âŒ ì‚­ì œê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
                alert('ì‚­ì œ ì‹¤íŒ¨: ê±°ë˜ì²˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // 2. ë¡œì»¬ ì €ì¥
            try {
                localStorage.setItem('eel_partners', JSON.stringify(partners));
                localStorage.setItem('eel_orders', JSON.stringify(orders));
                localStorage.setItem('eel_advances', JSON.stringify(advances));
                localStorage.setItem('eel_payments', JSON.stringify(payments));
                localStorage.setItem('eel_receipts', JSON.stringify(receipts));
                console.log('âœ… localStorage ì €ì¥ ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ localStorage ì €ì¥ ì‹¤íŒ¨:', error);
            }
            
            // 3. Firebaseì—ì„œë„ ì‚­ì œ ì‹œë„
            if (isOnline && window.firebaseModules) {
                try {
                    deleteFromFirebase(collections.partners, id);
                    console.log('Firebase ì‚­ì œ ìš”ì²­ ì „ì†¡');
                } catch (error) {
                    console.warn('Firebase ì‚­ì œ ì‹¤íŒ¨:', error);
                }
            }
            
            // 4. UI ê°•ì œ ì—…ë°ì´íŠ¸
            console.log('UI ì—…ë°ì´íŠ¸ ì‹œì‘...');
            try {
                updatePartnersList();
                console.log('âœ… updatePartnersList ì™„ë£Œ');
                updateDashboardStats();
                console.log('âœ… updateDashboardStats ì™„ë£Œ');
                updateDashboardContent();
                console.log('âœ… updateDashboardContent ì™„ë£Œ');
                updateSelects();
                console.log('âœ… updateSelects ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ UI ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
            
            console.log('=== ì¦‰ì‹œ ì‚­ì œ ì™„ë£Œ ===');
            alert('ê±°ë˜ì²˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ê°„ë‹¨í•œ ê±°ë˜ì²˜ ì‚­ì œ (ê°•ì œ ì‹¤í–‰)
        async function forceDeletePartner(id) {
            const partner = partners.find(p => p.id === id);
            if (!partner) {
                alert('ê±°ë˜ì²˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm(`${partner.name} ê±°ë˜ì²˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            console.log('ê°•ì œ ì‚­ì œ ì‹œì‘:', partner.name, 'ID:', id);
            console.log('ì‚­ì œ ì „ ê±°ë˜ì²˜ ìˆ˜:', partners.length);
            
            // ë¡œì»¬ ë°°ì—´ì—ì„œ ì¦‰ì‹œ ì œê±°
            const originalCount = partners.length;
            partners = partners.filter(p => p.id !== id);
            orders = orders.filter(o => o.partnerId !== id);
            advances = advances.filter(a => a.partnerId !== id);
            payments = payments.filter(p => p.partnerId !== id);
            receipts = receipts.filter(r => r.partnerId !== id);
            
            console.log('ì‚­ì œ í›„ ê±°ë˜ì²˜ ìˆ˜:', partners.length, '(', originalCount, '->', partners.length, ')');
            
            // ë¡œì»¬ ì €ì¥
            saveToLocal();
            console.log('ë¡œì»¬ ì €ì¥ ì™„ë£Œ');
            
            // Firebaseì—ì„œë„ ì¦‰ì‹œ ì‚­ì œ ì‹œë„
            if (isOnline && window.firebaseModules) {
                try {
                    console.log('Firebaseì—ì„œ ê±°ë˜ì²˜ ì‚­ì œ ì¤‘...');
                    await deleteFromFirebase(collections.partners, id);
                    console.log('Firebase ì‚­ì œ ì™„ë£Œ');
                } catch (error) {
                    console.warn('Firebase ì‚­ì œ ì‹¤íŒ¨ (ë¡œì»¬ì—ì„œëŠ” ì‚­ì œë¨):', error);
                }
            }
            
            // UI ê°•ì œ ì—…ë°ì´íŠ¸ - DOM ì§ì ‘ ì¡°ì‘
            console.log('UI ì—…ë°ì´íŠ¸ ì‹œì‘');
            
            // ê±°ë˜ì²˜ ëª©ë¡ ì™„ì „íˆ ì¬êµ¬ì„±
            const container = document.getElementById('partnersList');
            if (container) {
                container.innerHTML = '<h3>ê±°ë˜ì²˜ ëª©ë¡</h3>';
                if (partners.length === 0) {
                    container.innerHTML += '<p>ë“±ë¡ëœ ê±°ë˜ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    partners.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'partner-item';
                        div.innerHTML = `
                            <div>
                                <strong>${p.name}</strong><br>
                                <small>ğŸ“ ${p.phone || 'ì—†ìŒ'}</small><br>
                                <small>ğŸ“ ${p.address || 'ì—†ìŒ'}</small><br>
                                <small>ë“±ë¡ì¼: ${formatDate(p.createdAt)}</small>
                            </div>
                            <div>
                                <button class="btn" onclick="editPartner('${p.id}')">ìˆ˜ì •</button>
                                <button class="btn btn-danger" onclick="immediateDeletePartner('${p.id}', '${p.name}')">ì‚­ì œ</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
                console.log('ê±°ë˜ì²˜ ëª©ë¡ DOM ì—…ë°ì´íŠ¸ ì™„ë£Œ');
            }
            
            // ëŒ€ì‹œë³´ë“œ í†µê³„ ê°•ì œ ì¬ê³„ì‚° ë° ì—…ë°ì´íŠ¸
            setTimeout(() => {
                // ëŒ€ì‹œë³´ë“œ í†µê³„ ê°•ì œ ì¬ì‘ì„±
                const statsContainer = document.getElementById('dashboardStats');
                if (statsContainer) {
                    const visibleAdvances = advances.filter(a => a.hidden !== true);
                    const totalAdvanceAmount = visibleAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
                    const totalOrderAmount = orders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
                    const totalOrderQuantity = orders.reduce((sum, o) => sum + (o.quantity || 0), 0);
                    const totalPaymentAmount = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
                    const totalReceiptQuantity = receipts.reduce((sum, r) => sum + (r.quantity || 0), 0);
                    const totalAmountToPay = totalOrderAmount + totalAdvanceAmount - totalPaymentAmount;
                    const totalEelToReceive = totalOrderQuantity - totalReceiptQuantity;
                    
                    statsContainer.innerHTML = `
                        <div class="stat-card" style="border-left-color: #ef4444;">
                            <div class="stat-number" style="color: #ef4444;">${formatNumber(totalAmountToPay)}ì›</div>
                            <div>ğŸ’° ì´ ì¤„ ëˆ</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #10b981;">
                            <div class="stat-number" style="color: #10b981;">${formatNumber(totalEelToReceive)}kg</div>
                            <div>ğŸ ì´ ë°›ì„ ì¥ì–´</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #f59e0b;">
                            <div class="stat-number" style="color: #f59e0b;">${partners.length}ê°œ</div>
                            <div>ğŸ‘¥ ê±°ë˜ì²˜</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #8b5cf6;">
                            <div class="stat-number" style="color: #8b5cf6;">${visibleAdvances.length}ê±´</div>
                            <div>ğŸ¥„ ì„ ì£¼ë¬¸</div>
                        </div>
                    `;
                    console.log('ëŒ€ì‹œë³´ë“œ í†µê³„ ê°•ì œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                }
                
                updateDashboardContent();
                updateSelects();
                console.log('ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
            }, 100);
            
            console.log('ê°•ì œ ì‚­ì œ ë° UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
            alert('ê±°ë˜ì²˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ê±°ë˜ì²˜ ì‚­ì œ
        async function deletePartner(id) {
            const partner = partners.find(p => p.id === id);
            if (!partner) {
                console.error('ì‚­ì œí•  ê±°ë˜ì²˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', id);
                return;
            }
            
            if (!confirm(`${partner.name} ê±°ë˜ì²˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ê´€ë ¨ëœ ëª¨ë“  ê±°ë˜ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                return;
            }
            
            console.log('ê±°ë˜ì²˜ ì‚­ì œ ì‹œì‘:', partner.name, id);
            
            try {
                // ê´€ë ¨ ë°ì´í„° í™•ì¸
                const relatedOrders = orders.filter(order => order.partnerId === id);
                const relatedAdvances = advances.filter(advance => advance.partnerId === id);
                const relatedPayments = payments.filter(payment => payment.partnerId === id);
                const relatedReceipts = receipts.filter(receipt => receipt.partnerId === id);
                
                console.log('ì‚­ì œí•  ê´€ë ¨ ë°ì´í„°:', {
                    orders: relatedOrders.length,
                    advances: relatedAdvances.length,
                    payments: relatedPayments.length,
                    receipts: relatedReceipts.length
                });
                
                // Firebaseì—ì„œ ì‚­ì œ (ì˜¨ë¼ì¸ì¼ ë•Œë§Œ)
                if (isOnline && window.firebaseModules) {
                    console.log('Firebaseì—ì„œ ê±°ë˜ì²˜ ë° ê´€ë ¨ ë°ì´í„° ì‚­ì œ ì‹œì‘');
                    
                    // ê±°ë˜ì²˜ ì‚­ì œ
                    await deleteFromFirebase(collections.partners, id);
                    
                    // ê´€ë ¨ ë°ì´í„°ë„ Firebaseì—ì„œ ì‚­ì œ
                    const deletePromises = [
                        ...relatedOrders.map(item => deleteFromFirebase(collections.orders, item.id)),
                        ...relatedAdvances.map(item => deleteFromFirebase(collections.advances, item.id)),
                        ...relatedPayments.map(item => deleteFromFirebase(collections.payments, item.id)),
                        ...relatedReceipts.map(item => deleteFromFirebase(collections.receipts, item.id))
                    ];
                    
                    await Promise.all(deletePromises);
                    console.log('Firebase ì‚­ì œ ì™„ë£Œ');
                } else {
                    console.log('ì˜¤í”„ë¼ì¸ ëª¨ë“œ - Firebase ì‚­ì œ ê±´ë„ˆëœ€');
                }
                
                // ë¡œì»¬ ë°ì´í„° ì‚­ì œ (Firebase ì‚­ì œ ì„±ê³µ í›„ ë˜ëŠ” ì˜¤í”„ë¼ì¸ì¼ ë•Œ)
                console.log('ë¡œì»¬ ë°ì´í„°ì—ì„œ ì‚­ì œ ì‹œì‘');
                
                const originalPartnersLength = partners.length;
                const originalOrdersLength = orders.length;
                const originalAdvancesLength = advances.length;
                const originalPaymentsLength = payments.length;
                const originalReceiptsLength = receipts.length;
                
                // ê´€ë ¨ ë°ì´í„° ë¨¼ì € ì‚­ì œ
                orders = orders.filter(order => order.partnerId !== id);
                advances = advances.filter(advance => advance.partnerId !== id);
                payments = payments.filter(payment => payment.partnerId !== id);
                receipts = receipts.filter(receipt => receipt.partnerId !== id);
                
                // ê±°ë˜ì²˜ ì‚­ì œ
                partners = partners.filter(p => p.id !== id);
                
                console.log('ë¡œì»¬ ì‚­ì œ ê²°ê³¼:', {
                    partners: `${originalPartnersLength} -> ${partners.length}`,
                    orders: `${originalOrdersLength} -> ${orders.length}`,
                    advances: `${originalAdvancesLength} -> ${advances.length}`,
                    payments: `${originalPaymentsLength} -> ${payments.length}`,
                    receipts: `${originalReceiptsLength} -> ${receipts.length}`
                });
                
                // ë¡œì»¬ ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
                saveToLocal();
                console.log('localStorage ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                
                // UI ì—…ë°ì´íŠ¸ (ê°ê° ê°œë³„ì ìœ¼ë¡œ í˜¸ì¶œ)
                updatePartnersList();
                updateOrdersList();
                updateAdvancesList();
                updatePaymentsList();
                updateReceiptsList();
                updateDashboard();
                updateHistoryList();
                console.log('UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                
                alert('ê±°ë˜ì²˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                
            } catch (error) {
                console.error('ê±°ë˜ì²˜ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                alert(`ê±°ë˜ì²˜ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}\n\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
            }
        }

        // ì„ ì£¼ë¬¸ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateOrdersList() {
            const container = document.getElementById('ordersList');
            if (!container) return;
            
            container.innerHTML = '<h3>ì„ ì£¼ë¬¸ ëª©ë¡</h3>';
            
            if (orders.length === 0) {
                container.innerHTML += '<p>ë“±ë¡ëœ ì„ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
            const sortedOrders = [...orders].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            sortedOrders.forEach(order => {
                const partner = partners.find(p => p.id === order.partnerId);
                const partnerName = partner ? partner.name : 'ì‚­ì œëœ ê±°ë˜ì²˜';
                
                const orderDiv = document.createElement('div');
                orderDiv.className = 'partner-item';
                orderDiv.innerHTML = `
                    <div>
                        <strong>${partnerName}</strong>
                        <br>
                        <small>ğŸ“… ì£¼ë¬¸ë‚ ì§œ: ${formatDate(order.orderDate)}</small>
                        <br>
                        <small>ìˆ˜ëŸ‰: ${formatNumber(order.quantity)}kg</small>
                        <br>
                        <small>ë‹¨ê°€: ${formatNumber(order.price)}ì›/kg</small>
                        <br>
                        <small>ì´ì•¡: ${formatNumber(order.totalAmount)}ì›</small>
                        <br>
                        <small>ë©”ëª¨: ${order.memo || 'ì—†ìŒ'}</small>
                        <br>
                        <small>ë“±ë¡ì¼: ${formatDate(order.createdAt)}</small>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deleteOrder('${order.id}')">ì‚­ì œ</button>
                    </div>
                `;
                container.appendChild(orderDiv);
            });
        }

        // ì™¸ìƒ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateAdvancesList() {
            const container = document.getElementById('advancesList');
            if (!container) return;
            
            container.innerHTML = '<h3>ì™¸ìƒ ëª©ë¡</h3>';
            
            if (advances.length === 0) {
                container.innerHTML += '<p>ë“±ë¡ëœ ì™¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
            const sortedAdvances = [...advances].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            sortedAdvances.forEach(advance => {
                const partner = partners.find(p => p.id === advance.partnerId);
                const partnerName = partner ? partner.name : 'ì‚­ì œëœ ê±°ë˜ì²˜';
                
                const advanceDiv = document.createElement('div');
                advanceDiv.className = 'partner-item';
                advanceDiv.innerHTML = `
                    <div>
                        <strong>${partnerName}</strong>
                        <br>
                        <small>ğŸ“… ì™¸ìƒë‚ ì§œ: ${formatDate(advance.advanceDate)}</small>
                        <br>
                        <small>ì™¸ìƒê¸ˆì•¡: ${formatNumber(advance.amount)}ì›</small>
                        <br>
                        <small>ë©”ëª¨: ${advance.memo || 'ì—†ìŒ'}</small>
                        <br>
                        <small>ëŒ€ì‹œë³´ë“œ í‘œì‹œ: ${advance.hidden ? 'ìˆ¨ê¹€' : 'í‘œì‹œ'}</small>
                        <br>
                        <small>ë“±ë¡ì¼: ${formatDate(advance.createdAt)}</small>
                    </div>
                    <div>
                        <button class="btn" onclick="toggleAdvanceVisibility('${advance.id}')">${advance.hidden ? 'í‘œì‹œ' : 'ìˆ¨ê¹€'}</button>
                        <button class="btn btn-danger" onclick="deleteAdvance('${advance.id}')">ì‚­ì œ</button>
                    </div>
                `;
                container.appendChild(advanceDiv);
            });
        }

        // ì…ê¸ˆ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updatePaymentsList() {
            const container = document.getElementById('paymentsList');
            if (!container) return;
            
            container.innerHTML = '<h3>ì…ê¸ˆ ëª©ë¡</h3>';
            
            if (payments.length === 0) {
                container.innerHTML += '<p>ë“±ë¡ëœ ì…ê¸ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
            const sortedPayments = [...payments].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            sortedPayments.forEach(payment => {
                const partner = partners.find(p => p.id === payment.partnerId);
                const partnerName = partner ? partner.name : 'ì‚­ì œëœ ê±°ë˜ì²˜';
                
                const paymentDiv = document.createElement('div');
                paymentDiv.className = 'partner-item';
                paymentDiv.innerHTML = `
                    <div>
                        <strong>${partnerName}</strong>
                        <br>
                        <small>ğŸ“… ì…ê¸ˆë‚ ì§œ: ${formatDate(payment.paymentDate)}</small>
                        <br>
                        <small>ì…ê¸ˆì•¡: ${formatNumber(payment.amount)}ì›</small>
                        <br>
                        <small>ë©”ëª¨: ${payment.memo || 'ì—†ìŒ'}</small>
                        <br>
                        <small>ë“±ë¡ì¼: ${formatDate(payment.createdAt)}</small>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deletePayment('${payment.id}')">ì‚­ì œ</button>
                    </div>
                `;
                container.appendChild(paymentDiv);
            });
        }

        // ì…ê³  ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateReceiptsList() {
            const container = document.getElementById('receiptsList');
            if (!container) return;
            
            container.innerHTML = '<h3>ì…ê³  ëª©ë¡</h3>';
            
            if (receipts.length === 0) {
                container.innerHTML += '<p>ë“±ë¡ëœ ì…ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
            const sortedReceipts = [...receipts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            sortedReceipts.forEach(receipt => {
                const partner = partners.find(p => p.id === receipt.partnerId);
                const partnerName = partner ? partner.name : 'ì‚­ì œëœ ê±°ë˜ì²˜';
                
                const receiptDiv = document.createElement('div');
                receiptDiv.className = 'partner-item';
                receiptDiv.innerHTML = `
                    <div>
                        <strong>${partnerName}</strong>
                        <br>
                        <small>ğŸ“… ì…ê³ ë‚ ì§œ: ${formatDate(receipt.receiptDate)}</small>
                        <br>
                        <small>ìˆ˜ëŸ‰: ${formatNumber(receipt.quantity)}kg</small>
                        <br>
                        <small>ë©”ëª¨: ${receipt.memo || 'ì—†ìŒ'}</small>
                        <br>
                        <small>ë“±ë¡ì¼: ${formatDate(receipt.createdAt)}</small>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deleteReceipt('${receipt.id}')">ì‚­ì œ</button>
                    </div>
                `;
                container.appendChild(receiptDiv);
            });
        }

        // ê±°ë˜ë‚´ì—­ ì—…ë°ì´íŠ¸
        function updateHistoryList() {
            const container = document.getElementById('historyList');
            if (!container) return;
            
            const selectedPartnerId = document.getElementById('historyFilter').value;
            
            container.innerHTML = '<h3>ê±°ë˜ë‚´ì—­</h3>';
            
            // ëª¨ë“  ê±°ë˜ ë°ì´í„°ë¥¼ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ í†µí•©
            let allTransactions = [];
            
            // ì„ ì£¼ë¬¸ ì¶”ê°€
            orders.forEach(order => {
                const partner = partners.find(p => p.id === order.partnerId);
                if (!selectedPartnerId || order.partnerId === selectedPartnerId) {
                    allTransactions.push({
                        type: 'ì„ ì£¼ë¬¸',
                        partner: partner ? partner.name : 'ì‚­ì œëœ ê±°ë˜ì²˜',
                        amount: order.totalAmount,
                        quantity: order.quantity,
                        price: order.price,
                        memo: order.memo,
                        transactionDate: order.orderDate,
                        date: order.createdAt,
                        icon: 'ğŸ“¦'
                    });
                }
            });
            
            // ì™¸ìƒ ì¶”ê°€
            advances.forEach(advance => {
                const partner = partners.find(p => p.id === advance.partnerId);
                if (!selectedPartnerId || advance.partnerId === selectedPartnerId) {
                    allTransactions.push({
                        type: 'ì™¸ìƒ',
                        partner: partner ? partner.name : 'ì‚­ì œëœ ê±°ë˜ì²˜',
                        amount: advance.amount,
                        memo: advance.memo,
                        transactionDate: advance.advanceDate,
                        date: advance.createdAt,
                        icon: 'ğŸ’³',
                        hidden: advance.hidden
                    });
                }
            });
            
            // ì…ê¸ˆ ì¶”ê°€
            payments.forEach(payment => {
                const partner = partners.find(p => p.id === payment.partnerId);
                if (!selectedPartnerId || payment.partnerId === selectedPartnerId) {
                    allTransactions.push({
                        type: 'ì…ê¸ˆ',
                        partner: partner ? partner.name : 'ì‚­ì œëœ ê±°ë˜ì²˜',
                        amount: payment.amount,
                        memo: payment.memo,
                        transactionDate: payment.paymentDate,
                        date: payment.createdAt,
                        icon: 'ğŸ’°'
                    });
                }
            });
            
            // ì…ê³  ì¶”ê°€
            receipts.forEach(receipt => {
                const partner = partners.find(p => p.id === receipt.partnerId);
                if (!selectedPartnerId || receipt.partnerId === selectedPartnerId) {
                    allTransactions.push({
                        type: 'ì…ê³ ',
                        partner: partner ? partner.name : 'ì‚­ì œëœ ê±°ë˜ì²˜',
                        quantity: receipt.quantity,
                        memo: receipt.memo,
                        transactionDate: receipt.receiptDate,
                        date: receipt.createdAt,
                        icon: 'ğŸ“¥'
                    });
                }
            });
            
            if (allTransactions.length === 0) {
                container.innerHTML += '<p>ê±°ë˜ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            // ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
            allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            allTransactions.forEach(transaction => {
                const transactionDiv = document.createElement('div');
                transactionDiv.className = 'partner-item';
                
                let content = `
                    <div>
                        <strong>${transaction.icon} ${transaction.type} - ${transaction.partner}</strong>
                        <br>
                        <small>ğŸ“… ê±°ë˜ë‚ ì§œ: ${formatDate(transaction.transactionDate)}</small>
                `;
                
                if (transaction.amount) {
                    content += `<br><small>ê¸ˆì•¡: ${formatNumber(transaction.amount)}ì›</small>`;
                }
                
                if (transaction.quantity) {
                    content += `<br><small>ìˆ˜ëŸ‰: ${formatNumber(transaction.quantity)}kg</small>`;
                }
                
                if (transaction.price) {
                    content += `<br><small>ë‹¨ê°€: ${formatNumber(transaction.price)}ì›/kg</small>`;
                }
                
                if (transaction.memo) {
                    content += `<br><small>ë©”ëª¨: ${transaction.memo}</small>`;
                }
                
                if (transaction.hidden) {
                    content += `<br><small style="color: #6b7280;">ëŒ€ì‹œë³´ë“œ ìˆ¨ê¹€</small>`;
                }
                
                content += `<br><small>ë“±ë¡ì¼: ${formatDate(transaction.date)}</small>`;
                content += '</div>';
                
                transactionDiv.innerHTML = content;
                container.appendChild(transactionDiv);
            });
        }

        // ì„ ì£¼ë¬¸ ì¶”ê°€
        async function addOrder() {
            const partnerId = document.getElementById('orderPartner').value;
            const orderDate = document.getElementById('orderDate').value;
            const quantity = parseFloat(document.getElementById('orderQuantity').value);
            const price = parseFloat(document.getElementById('orderPrice').value);
            const memo = document.getElementById('orderMemo').value.trim();

            if (!partnerId) {
                alert('ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            if (!orderDate) {
                alert('ì£¼ë¬¸ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            if (!quantity || quantity <= 0) {
                alert('ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            if (!price || price <= 0) {
                alert('ì˜¬ë°”ë¥¸ ë‹¨ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            const order = {
                partnerId: partnerId,
                orderDate: orderDate,
                quantity: quantity,
                price: price,
                totalAmount: quantity * price,
                memo: memo,
                createdAt: new Date().toISOString()
            };

            if (isOnline) {
                const docId = await saveToFirebase(collections.orders, order);
                order.id = docId;
            } else {
                order.id = generateId();
            }

            orders.push(order);
            
            if (!isOnline) {
                saveToLocal();
            }

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('orderPartner').value = '';
            document.getElementById('orderDate').value = '';
            document.getElementById('orderQuantity').value = '';
            document.getElementById('orderPrice').value = '';
            document.getElementById('orderTotal').value = '';
            document.getElementById('orderMemo').value = '';
            
            // ë‹¬ë ¥ ìˆ¨ê¸°ê¸°
            const calendarContainer = document.getElementById('orderPartnerCalendar');
            if (calendarContainer) calendarContainer.style.display = 'none';

            updateOrdersList();
            updateDashboard();
            updateHistoryList();
            alert('ì„ ì£¼ë¬¸ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì™¸ìƒ ì¶”ê°€
        async function addAdvance() {
            const partnerId = document.getElementById('advancePartner').value;
            const advanceDate = document.getElementById('advanceDate').value;
            const amount = parseFloat(document.getElementById('advanceAmount').value);
            const memo = document.getElementById('advanceMemo').value.trim();
            const hidden = document.getElementById('advanceHidden').checked;

            if (!partnerId) {
                alert('ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            if (!advanceDate) {
                alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            if (!amount || amount <= 0) {
                alert('ì˜¬ë°”ë¥¸ ì™¸ìƒê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            const advance = {
                partnerId: partnerId,
                advanceDate: advanceDate,
                amount: amount,
                memo: memo,
                hidden: hidden,
                createdAt: new Date().toISOString()
            };

            if (isOnline) {
                const docId = await saveToFirebase(collections.advances, advance);
                advance.id = docId;
            } else {
                advance.id = generateId();
            }

            advances.push(advance);
            
            if (!isOnline) {
                saveToLocal();
            }

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('advancePartner').value = '';
            document.getElementById('advanceDate').value = '';
            document.getElementById('advanceAmount').value = '';
            document.getElementById('advanceMemo').value = '';
            document.getElementById('advanceHidden').checked = false;

            updateAdvancesList();
            updateDashboard();
            updateHistoryList();
            alert('ì™¸ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì…ê¸ˆ ì¶”ê°€
        async function addPayment() {
            const partnerId = document.getElementById('paymentPartner').value;
            const paymentDate = document.getElementById('paymentDate').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const memo = document.getElementById('paymentMemo').value.trim();

            if (!partnerId) {
                alert('ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            if (!paymentDate) {
                alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            if (!amount || amount <= 0) {
                alert('ì˜¬ë°”ë¥¸ ì…ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            const payment = {
                partnerId: partnerId,
                paymentDate: paymentDate,
                amount: amount,
                memo: memo,
                createdAt: new Date().toISOString()
            };

            if (isOnline) {
                const docId = await saveToFirebase(collections.payments, payment);
                payment.id = docId;
            } else {
                payment.id = generateId();
            }

            payments.push(payment);
            
            if (!isOnline) {
                saveToLocal();
            }

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('paymentPartner').value = '';
            document.getElementById('paymentDate').value = '';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentMemo').value = '';

            updatePaymentsList();
            updateDashboard();
            updateHistoryList();
            alert('ì…ê¸ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì…ê³  ì¶”ê°€
        async function addReceipt() {
            const partnerId = document.getElementById('receiptPartner').value;
            const receiptDate = document.getElementById('receiptDate').value;
            const quantity = parseFloat(document.getElementById('receiptQuantity').value);
            const memo = document.getElementById('receiptMemo').value.trim();

            if (!partnerId) {
                alert('ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            if (!receiptDate) {
                alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            if (!quantity || quantity <= 0) {
                alert('ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            const receipt = {
                partnerId: partnerId,
                receiptDate: receiptDate,
                quantity: quantity,
                memo: memo,
                createdAt: new Date().toISOString()
            };

            if (isOnline) {
                const docId = await saveToFirebase(collections.receipts, receipt);
                receipt.id = docId;
            } else {
                receipt.id = generateId();
            }

            receipts.push(receipt);
            
            if (!isOnline) {
                saveToLocal();
            }

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('receiptPartner').value = '';
            document.getElementById('receiptDate').value = '';
            document.getElementById('receiptQuantity').value = '';
            document.getElementById('receiptMemo').value = '';

            updateReceiptsList();
            updateDashboard();
            updateHistoryList();
            alert('ì…ê³ ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ê±°ë˜ì²˜ë³„ ì •ë³´ í‘œì‹œ
        function showPartnerInfo(type) {
            let partnerId, infoContainer;
            
            if (type === 'payment') {
                partnerId = document.getElementById('paymentPartner').value;
                infoContainer = document.getElementById('paymentPartnerInfo');
            } else if (type === 'receipt') {
                partnerId = document.getElementById('receiptPartner').value;
                infoContainer = document.getElementById('receiptPartnerInfo');
            }
            
            if (!partnerId || !infoContainer) {
                if (infoContainer) infoContainer.style.display = 'none';
                return;
            }
            
            const partner = partners.find(p => p.id === partnerId);
            if (!partner) {
                infoContainer.style.display = 'none';
                return;
            }
            
            // ê±°ë˜ì²˜ ë°ì´í„° ê³„ì‚° (ì§€ë¶ˆê´€ë¦¬ì—ì„œëŠ” ìˆ¨ê²¨ì§„ ì™¸ìƒë„ í¬í•¨)
            const partnerAdvances = advances.filter(a => a.partnerId === partnerId);
            const totalAdvanceAmount = partnerAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
            const hiddenAdvances = partnerAdvances.filter(a => a.hidden === true);
            const visibleAdvances = partnerAdvances.filter(a => a.hidden !== true);
            
            const partnerOrders = orders.filter(o => o.partnerId === partnerId);
            const totalOrderAmount = partnerOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
            const totalOrderQuantity = partnerOrders.reduce((sum, o) => sum + (o.quantity || 0), 0);
            
            const partnerPayments = payments.filter(p => p.partnerId === partnerId);
            const totalPaymentAmount = partnerPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            
            const partnerReceipts = receipts.filter(r => r.partnerId === partnerId);
            const totalReceiptQuantity = partnerReceipts.reduce((sum, r) => sum + (r.quantity || 0), 0);
            
            // ì‹¤ì œ ë°›ì„ ê¸ˆì•¡ê³¼ ë°›ì„ ì¥ì–´
            const actualReceivable = totalOrderAmount + totalAdvanceAmount - totalPaymentAmount;
            const pendingEelQuantity = totalOrderQuantity - totalReceiptQuantity;
            
            let infoHTML = `<strong>${partner.name} ê±°ë˜ì²˜ í˜„í™©</strong><br><br>`;
            
            if (type === 'payment') {
                const hiddenAmount = hiddenAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
                const visibleAmount = visibleAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
                
                infoHTML += `
                    ğŸ’° <strong>ì´ ì¤„ ëˆ: ${formatNumber(actualReceivable)}ì›</strong><br><br>
                    ğŸ’³ <strong style="color: #dc2626;">ì´ ì™¸ìƒê¸ˆì•¡: ${formatNumber(totalAdvanceAmount)}ì›</strong><br>
                    ${visibleAmount > 0 ? `ã€€â”” í‘œì‹œëœ ì™¸ìƒ: ${formatNumber(visibleAmount)}ì› (${visibleAdvances.length}ê±´)<br>` : ''}
                    ${hiddenAmount > 0 ? `ã€€â”” <span style="color: #6b7280;">ìˆ¨ê²¨ì§„ ì™¸ìƒ: ${formatNumber(hiddenAmount)}ì› (${hiddenAdvances.length}ê±´)</span><br>` : ''}
                    ğŸ“¦ ì„ ì£¼ë¬¸ê¸ˆì•¡: ${formatNumber(totalOrderAmount)}ì›<br>
                    ğŸ’¸ ê¸°ì§€ë¶ˆê¸ˆì•¡: ${formatNumber(totalPaymentAmount)}ì›<br><br>
                    <small>* ì§€ë¶ˆê´€ë¦¬ì—ì„œëŠ” ëª¨ë“  ì™¸ìƒ(ìˆ¨ê¹€ í¬í•¨)ì´ ê³„ì‚°ì— ë°˜ì˜ë©ë‹ˆë‹¤</small>
                `;
            } else if (type === 'receipt') {
                infoHTML += `
                    ğŸ <strong>ë°›ì„ ì¥ì–´: ${formatNumber(pendingEelQuantity)}kg</strong><br>
                    ğŸ“¦ ì„ ì£¼ë¬¸: ${formatNumber(totalOrderQuantity)}kg<br>
                    ğŸ“¥ ê¸°ì…ê³ : ${formatNumber(totalReceiptQuantity)}kg<br>
                    ğŸ’° ì´ì£¼ë¬¸ê¸ˆì•¡: ${formatNumber(totalOrderAmount)}ì›
                `;
            }
            
            infoContainer.innerHTML = infoHTML;
            infoContainer.style.display = 'block';
        }

        // ê±°ë˜ì²˜ë³„ ë‹¬ë ¥ í‘œì‹œ
        function showPartnerCalendar(type) {
            const partnerId = document.getElementById('orderPartner').value;
            const calendarContainer = document.getElementById('orderPartnerCalendar');
            
            if (!partnerId || !calendarContainer) {
                if (calendarContainer) calendarContainer.style.display = 'none';
                return;
            }
            
            const partner = partners.find(p => p.id === partnerId);
            if (!partner) {
                calendarContainer.style.display = 'none';
                return;
            }
            
            renderPartnerCalendar(partnerId, partner.name, calendarContainer);
            calendarContainer.style.display = 'block';
        }

        // ê±°ë˜ì²˜ë³„ ë‹¬ë ¥ ë Œë”ë§
        function renderPartnerCalendar(partnerId, partnerName, container) {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            
            let calendarHTML = `
                <div class="partner-calendar-header">
                    ${partnerName} - ${year}ë…„ ${month + 1}ì›” ê°€ê²© ë‹¬ë ¥
                </div>
                <div class="partner-calendar-grid">
            `;
            
            // ìš”ì¼ í—¤ë”
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            days.forEach(day => {
                calendarHTML += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // ë‹¬ë ¥ ë‚ ì§œë“¤
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + (week * 7) + day);
                    
                    const isCurrentMonth = cellDate.getMonth() === month;
                    const dateKey = formatDateKey(cellDate);
                    const priceKey = `${partnerId}_${dateKey}`;
                    const priceInfo = partnerPrices[priceKey];
                    
                    let cellClass = 'partner-calendar-cell';
                    if (!isCurrentMonth) cellClass += ' other-month';
                    if (priceInfo) cellClass += ' has-price';
                    
                    const priceBadge = priceInfo ? 
                        `<div class="calendar-price-badge">${formatNumber(priceInfo.price)}ì›</div>` : '';
                    
                    calendarHTML += `
                        <div class="${cellClass}" onclick="selectPartnerCalendarDate('${partnerId}', '${dateKey}', this)">
                            <div>${cellDate.getDate()}</div>
                            ${priceBadge}
                        </div>
                    `;
                }
            }
            
            calendarHTML += `</div>`;
            
            // ê°€ê²© ì…ë ¥ ì„¹ì…˜
            calendarHTML += `
                <div class="price-input-section" id="partnerPriceInput_${partnerId}" style="display: none;">
                    <h4>ğŸ“… <span id="selectedPartnerDate_${partnerId}">ë‚ ì§œ ì„ íƒ</span> ê°€ê²© ì„¤ì •</h4>
                    <div class="price-input-group">
                        <input type="number" id="partnerPrice_${partnerId}" placeholder="ë‹¨ê°€ (ì›/kg)" min="0" step="100">
                        <input type="text" id="partnerPriceNote_${partnerId}" placeholder="ë©”ëª¨ (ì„ íƒ)" maxlength="50">
                        <button class="btn" onclick="setPartnerPrice('${partnerId}')">ê°€ê²© ì„¤ì •</button>
                        <button class="btn btn-danger" onclick="clearPartnerPrice('${partnerId}')">ê°€ê²© ì‚­ì œ</button>
                    </div>
                </div>
            `;
            
            container.innerHTML = calendarHTML;
        }

        // ê±°ë˜ì²˜ ë‹¬ë ¥ ë‚ ì§œ ì„ íƒ
        function selectPartnerCalendarDate(partnerId, dateKey, element) {
            // ì´ì „ ì„ íƒ ì œê±°
            const container = element.closest('.partner-calendar');
            container.querySelectorAll('.partner-calendar-cell.selected').forEach(cell => {
                cell.classList.remove('selected');
            });
            
            // ìƒˆ ì„ íƒ ì¶”ê°€
            element.classList.add('selected');
            
            // ê°€ê²© ì…ë ¥ ì„¹ì…˜ í‘œì‹œ
            const priceInputSection = document.getElementById(`partnerPriceInput_${partnerId}`);
            const selectedDateSpan = document.getElementById(`selectedPartnerDate_${partnerId}`);
            const priceInput = document.getElementById(`partnerPrice_${partnerId}`);
            const priceNoteInput = document.getElementById(`partnerPriceNote_${partnerId}`);
            
            const [year, month, day] = dateKey.split('-');
            const selectedDate = new Date(year, month - 1, day);
            selectedDateSpan.textContent = formatDate(selectedDate.toISOString());
            priceInputSection.style.display = 'block';
            
            // ê¸°ì¡´ ê°€ê²© ì •ë³´ ë¡œë“œ
            const priceKey = `${partnerId}_${dateKey}`;
            const priceInfo = partnerPrices[priceKey];
            if (priceInfo) {
                priceInput.value = priceInfo.price;
                priceNoteInput.value = priceInfo.note || '';
            } else {
                priceInput.value = '';
                priceNoteInput.value = '';
            }
            
            // ì„ íƒí•œ ê°€ê²©ì„ ë‹¨ê°€ í•„ë“œì— ìë™ ì…ë ¥
            if (priceInfo && priceInfo.price) {
                document.getElementById('orderPrice').value = priceInfo.price;
                // ì´ì•¡ ê³„ì‚°
                const quantity = parseFloat(document.getElementById('orderQuantity').value) || 0;
                const total = quantity * priceInfo.price;
                document.getElementById('orderTotal').value = total > 0 ? formatNumber(total) + 'ì›' : '';
            }
        }

        // ê±°ë˜ì²˜ë³„ ê°€ê²© ì„¤ì •
        async function setPartnerPrice(partnerId) {
            const selectedCell = document.querySelector('.partner-calendar-cell.selected');
            if (!selectedCell) {
                alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }
            
            const dateKey = selectedCell.onclick.toString().match(/'([^']+)'/g)[1].replace(/'/g, '');
            const price = parseFloat(document.getElementById(`partnerPrice_${partnerId}`).value);
            const note = document.getElementById(`partnerPriceNote_${partnerId}`).value.trim();
            
            if (!price || price <= 0) {
                alert('ì˜¬ë°”ë¥¸ ë‹¨ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            const priceKey = `${partnerId}_${dateKey}`;
            const priceData = {
                price: price,
                note: note,
                updatedAt: new Date().toISOString()
            };
            
            partnerPrices[priceKey] = priceData;
            
            if (isOnline) {
                await saveToFirebase(collections.partnerPrices, priceData, priceKey);
            } else {
                saveToLocal();
            }
            
            showPartnerCalendar('order'); // ë‹¬ë ¥ ì¬ë Œë”ë§
            alert('ê°€ê²©ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ê±°ë˜ì²˜ë³„ ê°€ê²© ì‚­ì œ
        async function clearPartnerPrice(partnerId) {
            const selectedCell = document.querySelector('.partner-calendar-cell.selected');
            if (!selectedCell) {
                alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }
            
            const dateKey = selectedCell.onclick.toString().match(/'([^']+)'/g)[1].replace(/'/g, '');
            const priceKey = `${partnerId}_${dateKey}`;
            
            if (!partnerPrices[priceKey]) {
                alert('ì„¤ì •ëœ ê°€ê²©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('ì´ ë‚ ì§œì˜ ê°€ê²© ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                delete partnerPrices[priceKey];
                
                if (isOnline) {
                    await deleteFromFirebase(collections.partnerPrices, priceKey);
                } else {
                    saveToLocal();
                }
                
                showPartnerCalendar('order'); // ë‹¬ë ¥ ì¬ë Œë”ë§
                alert('ê°€ê²©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì™¸ìƒ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
        async function toggleAdvanceVisibility(id) {
            const advance = advances.find(a => a.id === id);
            if (!advance) return;
            
            advance.hidden = !advance.hidden;
            
            if (isOnline) {
                await saveToFirebase(collections.advances, advance, id);
            } else {
                saveToLocal();
            }
            
            updateAdvancesList();
            updateDashboard();
        }

        // ì‚­ì œ í•¨ìˆ˜ë“¤
        async function deleteOrder(id) {
            if (!confirm('ì„ ì£¼ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            if (isOnline) {
                await deleteFromFirebase(collections.orders, id);
            }
            
            orders = orders.filter(o => o.id !== id);
            
            // í•­ìƒ ë¡œì»¬ ì €ì¥ì†Œì—ë„ ì €ì¥ (Firebaseì™€ ë™ê¸°í™”)
            saveToLocal();
            
            updateOrdersList();
            updateDashboard();
            updateHistoryList();
            alert('ì„ ì£¼ë¬¸ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        async function deleteAdvance(id) {
            if (!confirm('ì™¸ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            if (isOnline) {
                await deleteFromFirebase(collections.advances, id);
            }
            
            advances = advances.filter(a => a.id !== id);
            
            // í•­ìƒ ë¡œì»¬ ì €ì¥ì†Œì—ë„ ì €ì¥ (Firebaseì™€ ë™ê¸°í™”)
            saveToLocal();
            
            updateAdvancesList();
            updateDashboard();
            updateHistoryList();
            alert('ì™¸ìƒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        async function deletePayment(id) {
            if (!confirm('ì…ê¸ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            if (isOnline) {
                await deleteFromFirebase(collections.payments, id);
            }
            
            payments = payments.filter(p => p.id !== id);
            
            // í•­ìƒ ë¡œì»¬ ì €ì¥ì†Œì—ë„ ì €ì¥ (Firebaseì™€ ë™ê¸°í™”)
            saveToLocal();
            
            updatePaymentsList();
            updateDashboard();
            updateHistoryList();
            alert('ì…ê¸ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        async function deleteReceipt(id) {
            if (!confirm('ì…ê³ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            if (isOnline) {
                await deleteFromFirebase(collections.receipts, id);
            }
            
            receipts = receipts.filter(r => r.id !== id);
            
            // í•­ìƒ ë¡œì»¬ ì €ì¥ì†Œì—ë„ ì €ì¥ (Firebaseì™€ ë™ê¸°í™”)
            saveToLocal();
            
            updateReceiptsList();
            updateDashboard();
            updateHistoryList();
            alert('ì…ê³ ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€ í•¨ìˆ˜
        function addSampleData() {
            console.log('ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì¤‘...');
            
            // ìƒ˜í”Œ ê±°ë˜ì²˜ ì¶”ê°€
            const samplePartner = {
                id: generateId(),
                name: 'í…ŒìŠ¤íŠ¸ ê±°ë˜ì²˜',
                phone: '010-1234-5678',
                address: 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬',
                memo: 'ìƒ˜í”Œ ë°ì´í„°ì…ë‹ˆë‹¤',
                createdAt: new Date().toISOString()
            };
            
            partners.push(samplePartner);
            
            // ìƒ˜í”Œ ì£¼ë¬¸ ì¶”ê°€
            const sampleOrder = {
                id: generateId(),
                partnerId: samplePartner.id,
                date: new Date().toISOString().split('T')[0],
                quantity: 100,
                price: 30000,
                totalAmount: 3000000,
                createdAt: new Date().toISOString()
            };
            
            orders.push(sampleOrder);
            
            // ìƒ˜í”Œ ì™¸ìƒ ì¶”ê°€
            const sampleAdvance = {
                id: generateId(),
                partnerId: samplePartner.id,
                date: new Date().toISOString().split('T')[0],
                amount: 500000,
                memo: 'ìƒ˜í”Œ ì™¸ìƒ',
                createdAt: new Date().toISOString()
            };
            
            advances.push(sampleAdvance);
            
            // ë¡œì»¬ ì €ì¥
            saveToLocal();
            console.log('ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì™„ë£Œ');
        }

        // ì£¼ë¬¸ ê³„ì‚°ê¸°
        document.addEventListener('DOMContentLoaded', function() {
            const quantityInput = document.getElementById('orderQuantity');
            const priceInput = document.getElementById('orderPrice');
            const totalInput = document.getElementById('orderTotal');

            function calculateTotal() {
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const total = quantity * price;
                totalInput.value = total > 0 ? formatNumber(total) + 'ì›' : '';
            }

            if (quantityInput) quantityInput.addEventListener('input', calculateTotal);
            if (priceInput) priceInput.addEventListener('input', calculateTotal);

            // ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = ['orderDate', 'advanceDate', 'paymentDate', 'receiptDate'];
            dateInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) input.value = today;
            });

            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ (ë¡œì»¬ ë¨¼ì €, ê·¸ë‹¤ìŒ Firebase)
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - ë°ì´í„° ì´ˆê¸°í™” ì‹œì‘');
            
            // ì—°ê²° ìƒíƒœ í‘œì‹œ
            const statusElement = document.querySelector('.connection-status span');
            if (statusElement) {
                statusElement.textContent = 'ë°ì´í„° ë¡œë“œ ì¤‘...';
            }
            
            // ë¡œì»¬ ë°ì´í„° ë¨¼ì € ë¡œë“œ
            loadLocalData();
            console.log('ë¡œì»¬ ë°ì´í„° ë¡œë“œ í›„ partners ìˆ˜:', partners.length);
            
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± (ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©)
            if (partners.length === 0 && orders.length === 0) {
                console.log('ë°ì´í„°ê°€ ì—†ìŒ - ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€');
                addSampleData();
            }
            
            // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            updateAllLists();
            
            // Firebase ë°ì´í„° ë¡œë“œ (ë¹„ë™ê¸°)
            loadFirebaseData().then(() => {
                console.log('Firebase ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ');
                if (statusElement) {
                    statusElement.textContent = isOnline ? 'Firebase ì—°ê²°ë¨' : 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ';
                }
            }).catch((error) => {
                console.error('Firebase ë™ê¸°í™” ì‹¤íŒ¨:', error);
                if (statusElement) {
                    statusElement.textContent = 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ (Firebase ì—°ê²° ì‹¤íŒ¨)';
                }
            });
        });
    </script>
</body>
</html>