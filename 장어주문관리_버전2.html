<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêç Ïû•Ïñ¥ Ï£ºÎ¨∏Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú - Î≤ÑÏ†Ñ2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #e8f5e8 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab.active {
            background: #3b82f6;
            color: white;
        }

        .tab:hover:not(.active) {
            background: #f3f4f6;
        }

        .content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }

        .content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            font-size: 14px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        .btn:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .grid {
            display: grid;
            gap: 15px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #10b981;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #10b981;
        }

        .partner-list {
            margin-top: 20px;
        }

        .partner-item {
            background: #f8fafc;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .calendar-header {
            background: #3b82f6;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-nav {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
        }

        .calendar-nav:hover {
            background: rgba(255,255,255,0.2);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day-header {
            background: #f8fafc;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #e5e7eb;
            font-size: 12px;
            color: #666;
        }

        .calendar-cell {
            padding: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            position: relative;
        }

        .calendar-cell:hover {
            background: #f3f4f6;
        }

        .calendar-cell.selected {
            background: #3b82f6;
            color: white;
        }

        .calendar-cell.today {
            background: #fbbf24;
            color: white;
        }

        .calendar-cell.other-month {
            color: #9ca3af;
            background: #f9fafb;
        }

        .calendar-cell.has-price {
            background: #dcfce7;
        }

        .calendar-cell.has-price.selected {
            background: #3b82f6;
            color: white;
        }

        .price-badge {
            font-size: 10px;
            background: #10b981;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            margin-top: 2px;
        }

        .calendar-cell.selected .price-badge {
            background: rgba(255,255,255,0.3);
        }

        .price-input-section {
            padding: 20px;
            background: #f8fafc;
            border-top: 1px solid #e5e7eb;
        }

        .partner-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .partner-calendar {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-top: 15px;
            overflow: hidden;
        }

        .partner-calendar-header {
            background: #10b981;
            color: white;
            padding: 10px 15px;
            font-weight: 600;
        }

        .partner-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .partner-calendar-cell {
            padding: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            min-height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .partner-calendar-cell:hover {
            background: #f3f4f6;
        }

        .partner-calendar-cell.selected {
            background: #10b981;
            color: white;
        }

        .partner-calendar-cell.has-price {
            background: #dcfce7;
        }

        .partner-calendar-cell.has-price.selected {
            background: #10b981;
            color: white;
        }

        .calendar-price-badge {
            font-size: 9px;
            background: #10b981;
            color: white;
            padding: 1px 3px;
            border-radius: 2px;
            margin-top: 1px;
        }

        .partner-calendar-cell.selected .calendar-price-badge {
            background: rgba(255,255,255,0.3);
        }

        .partner-price-input {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }

        .partner-price-input h4 {
            color: #0369a1;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .price-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .price-input-group input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 12px;
        }

        .price-input-group .btn {
            padding: 6px 12px;
            font-size: 12px;
        }

        .dashboard-calendar {
            margin-top: 10px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            max-height: 300px;
            overflow-y: auto;
        }

        .dashboard-calendar-header {
            background: #10b981;
            color: white;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 12px;
        }

        .dashboard-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .dashboard-calendar-cell {
            padding: 6px;
            text-align: center;
            border: 1px solid #e5e7eb;
            font-size: 10px;
            min-height: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .dashboard-calendar-cell.has-price {
            background: #dcfce7;
        }

        .dashboard-calendar-cell.other-month {
            color: #9ca3af;
            background: #f9fafb;
        }

        .dashboard-price-badge {
            font-size: 8px;
            background: #10b981;
            color: white;
            padding: 1px 2px;
            border-radius: 2px;
            margin-top: 1px;
        }

        .hide {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêç Ïû•Ïñ¥ Ï£ºÎ¨∏Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú Î≤ÑÏ†Ñ2</h1>
            <p>Ìö®Ïú®Ï†ÅÏù∏ Ïû•Ïñ¥ Í±∞Îûò Í¥ÄÎ¶¨Î•º ÏúÑÌïú ÌÜµÌï© ÏÜîÎ£®ÏÖò - Í∞úÏÑ†Îêú ÏßÅÍ¥ÄÏ†Å Ïù∏ÌÑ∞ÌéòÏù¥Ïä§</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä ÎåÄÏãúÎ≥¥Îìú</button>
            <button class="tab" onclick="showTab('partners')">üë• Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨</button>
            <button class="tab" onclick="showTab('orders')">üì¶ ÏÑ†Ï£ºÎ¨∏ Í¥ÄÎ¶¨</button>
            <button class="tab" onclick="showTab('advances')">üí≥ Ïô∏ÏÉÅ Í¥ÄÎ¶¨</button>
            <button class="tab" onclick="showTab('payments')">üí∞ ÏßÄÎ∂à Í¥ÄÎ¶¨</button>
            <button class="tab" onclick="showTab('receipts')">üì• ÏûÖÍ≥† Í¥ÄÎ¶¨</button>
            <button class="tab" onclick="showTab('history')">üìã Í±∞ÎûòÎÇ¥Ïó≠ÌôïÏù∏</button>
        </div>

        <!-- ÎåÄÏãúÎ≥¥Îìú -->
        <div id="dashboard" class="content active">
            <div class="stats-grid" id="statsGrid">
                <!-- ÌÜµÍ≥ÑÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
            </div>
            <div id="partnersList">
                <!-- Í±∞ÎûòÏ≤ò ÌòÑÌô©Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
            </div>
        </div>

        <!-- Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨ -->
        <div id="partners" class="content">
            <h2>Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨</h2>
            <div class="grid grid-2">
                <div>
                    <h3>ÏÉà Í±∞ÎûòÏ≤ò Ï∂îÍ∞Ä</h3>
                    <div class="form-group">
                        <label>Í±∞ÎûòÏ≤òÎ™Ö</label>
                        <input type="text" id="partnerName" placeholder="Í±∞ÎûòÏ≤òÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <div class="form-group">
                        <label>Ïó∞ÎùΩÏ≤ò</label>
                        <input type="text" id="partnerContact" placeholder="Ïó∞ÎùΩÏ≤òÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <button class="btn" onclick="addPartner()">Í±∞ÎûòÏ≤ò Ï∂îÍ∞Ä</button>
                </div>
                <div id="partnerManagementList">
                    <!-- Í±∞ÎûòÏ≤ò Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
            </div>
        </div>

        <!-- ÏÑ†Ï£ºÎ¨∏ Í¥ÄÎ¶¨ -->
        <div id="orders" class="content">
            <h2>ÏÑ†Ï£ºÎ¨∏ Í¥ÄÎ¶¨</h2>
            <div class="grid grid-2">
                <div>
                    <h3>ÏÉà ÏÑ†Ï£ºÎ¨∏ Ï∂îÍ∞Ä</h3>
                    <div class="form-group">
                        <label>Í±∞ÎûòÏ≤ò</label>
                        <select id="orderPartner" onchange="showPartnerCalendar('order')">
                            <option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ÎÇ†Ïßú</label>
                        <input type="date" id="orderDate" value="">
                    </div>
                    <div class="form-group">
                        <label>ÏàòÎüâ (kg)</label>
                        <input type="number" id="orderQuantity" placeholder="ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" oninput="calculateOrderTotal()">
                    </div>
                    <div class="form-group">
                        <label>Îã®Í∞Ä (Ïõê/kg)</label>
                        <input type="number" id="orderPrice" placeholder="Îã®Í∞ÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" oninput="calculateOrderTotal()">
                    </div>
                    <div class="form-group">
                        <label>Ï¥ùÏï°</label>
                        <input type="text" id="orderTotal" readonly style="background-color: #f3f4f6; font-weight: bold;" placeholder="ÏàòÎüâÍ≥º Îã®Í∞ÄÎ•º ÏûÖÎ†•ÌïòÎ©¥ ÏûêÎèô Í≥ÑÏÇ∞Îê©ÎãàÎã§">
                    </div>
                    <div class="form-group">
                        <label>Î©îÎ™®</label>
                        <textarea id="orderMemo" placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                    </div>
                    <button class="btn" onclick="addOrder()">ÏÑ†Ï£ºÎ¨∏ Ï∂îÍ∞Ä</button>
                    <div id="orderPartnerCalendar" class="partner-calendar" style="display: none;">
                        <!-- Í±∞ÎûòÏ≤òÎ≥Ñ Îã¨Î†•Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>
                <div id="ordersList">
                    <!-- ÏÑ†Ï£ºÎ¨∏ Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
            </div>
        </div>

        <!-- Ïô∏ÏÉÅ Í¥ÄÎ¶¨ -->
        <div id="advances" class="content">
            <h2>Ïô∏ÏÉÅ Í¥ÄÎ¶¨</h2>
            <div class="grid grid-2">
                <div>
                    <h3>ÏÉà Ïô∏ÏÉÅ Ï∂îÍ∞Ä</h3>
                    <div class="form-group">
                        <label>Í±∞ÎûòÏ≤ò</label>
                        <select id="advancePartner">
                            <option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ÎÇ†Ïßú</label>
                        <input type="date" id="advanceDate" value="">
                    </div>
                    <div class="form-group">
                        <label>Ïô∏ÏÉÅÍ∏àÏï° (Ïõê)</label>
                        <input type="number" id="advanceAmount" placeholder="Ïô∏ÏÉÅÍ∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <div class="form-group">
                        <label>Î©îÎ™®</label>
                        <textarea id="advanceMemo" placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="advanceHidden"> ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú Ïà®Í∏∞Í∏∞
                        </label>
                    </div>
                    <button class="btn" onclick="addAdvance()">Ïô∏ÏÉÅ Ï∂îÍ∞Ä</button>
                </div>
                <div id="advancesList">
                    <!-- Ïô∏ÏÉÅ Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
            </div>
        </div>

        <!-- ÏßÄÎ∂à Í¥ÄÎ¶¨ -->
        <div id="payments" class="content">
            <h2>ÏßÄÎ∂à Í¥ÄÎ¶¨</h2>
            <div class="grid grid-2">
                <div>
                    <h3>ÏÉà ÏßÄÎ∂à Ï∂îÍ∞Ä</h3>
                    <div class="form-group">
                        <label>Í±∞ÎûòÏ≤ò</label>
                        <select id="paymentPartner" onchange="showPartnerInfo('payment')">
                            <option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                        </select>
                    </div>
                    <div id="paymentPartnerInfo" class="partner-info" style="display: none;">
                        <!-- Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                    <div class="form-group">
                        <label>ÎÇ†Ïßú</label>
                        <input type="date" id="paymentDate" value="">
                    </div>
                    <div class="form-group">
                        <label>ÏûÖÍ∏àÏï° (Ïõê)</label>
                        <input type="number" id="paymentAmount" placeholder="ÏûÖÍ∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <div class="form-group">
                        <label>Î©îÎ™®</label>
                        <textarea id="paymentMemo" placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                    </div>
                    <button class="btn" onclick="addPayment()">ÏûÖÍ∏à Ï∂îÍ∞Ä</button>
                </div>
                <div id="paymentsList">
                    <!-- ÏûÖÍ∏à Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
            </div>
        </div>

        <!-- ÏûÖÍ≥† Í¥ÄÎ¶¨ -->
        <div id="receipts" class="content">
            <h2>ÏûÖÍ≥† Í¥ÄÎ¶¨</h2>
            <div class="grid grid-2">
                <div>
                    <h3>ÏÉà ÏûÖÍ≥† Ï∂îÍ∞Ä</h3>
                    <div class="form-group">
                        <label>Í±∞ÎûòÏ≤ò</label>
                        <select id="receiptPartner" onchange="showPartnerInfo('receipt')">
                            <option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                        </select>
                    </div>
                    <div id="receiptPartnerInfo" class="partner-info" style="display: none;">
                        <!-- Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                    <div class="form-group">
                        <label>ÎÇ†Ïßú</label>
                        <input type="date" id="receiptDate" value="">
                    </div>
                    <div class="form-group">
                        <label>ÏàòÎüâ (kg)</label>
                        <input type="number" id="receiptQuantity" placeholder="ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <div class="form-group">
                        <label>Î©îÎ™®</label>
                        <textarea id="receiptMemo" placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                    </div>
                    <button class="btn" onclick="addReceipt()">ÏûÖÍ≥† Ï∂îÍ∞Ä</button>
                </div>
                <div id="receiptsList">
                    <!-- ÏûÖÍ≥† Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
            </div>
        </div>

        <!-- Í±∞ÎûòÎÇ¥Ïó≠ ÌôïÏù∏ -->
        <div id="history" class="content">
            <h2>Í±∞ÎûòÎÇ¥Ïó≠ ÌôïÏù∏</h2>
            <div class="form-group">
                <label>Í±∞ÎûòÏ≤ò ÌïÑÌÑ∞</label>
                <select id="historyFilter">
                    <option value="">Ï†ÑÏ≤¥ Í±∞ÎûòÏ≤ò</option>
                </select>
            </div>
            <button class="btn" onclick="exportData()">Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
            <div id="historyList">
                <!-- Í±∞ÎûòÎÇ¥Ïó≠Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
            </div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let partners = JSON.parse(localStorage.getItem('eelData_partners') || '[]');
        let orders = JSON.parse(localStorage.getItem('eelData_orders') || '[]');
        let advances = JSON.parse(localStorage.getItem('eelData_advances') || '[]');
        let payments = JSON.parse(localStorage.getItem('eelData_payments') || '[]');
        let receipts = JSON.parse(localStorage.getItem('eelData_receipts') || '[]');
        let partnerPrices = JSON.parse(localStorage.getItem('eelData_partnerPrices') || '{}');

        // Îã¨Î†• Í¥ÄÎ†® Î≥ÄÏàò
        let currentCalendarDate = new Date();
        let selectedCalendarDate = new Date();
        let currentCalendarPartner = null;

        // ÌÉ≠ Ï†ÑÌôò
        function showTab(tabName) {
            // Î™®Îì† ÌÉ≠Í≥º ÏΩòÌÖêÏ∏† ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            
            // ÏÑ†ÌÉùÎêú ÌÉ≠Í≥º ÏΩòÌÖêÏ∏† ÌôúÏÑ±Ìôî
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Ìï¥Îãπ ÌÉ≠Ïùò Îç∞Ïù¥ÌÑ∞ Í∞±Ïã†
            if (tabName === 'dashboard') updateDashboard();
            else if (tabName === 'partners') updatePartnersList();
            else if (tabName === 'orders') updateOrdersList();
            else if (tabName === 'advances') updateAdvancesList();
            else if (tabName === 'payments') updatePaymentsList();
            else if (tabName === 'receipts') updateReceiptsList();
            else if (tabName === 'history') updateHistoryList();
            
            // ÏÖÄÎ†âÌä∏ Î∞ïÏä§ ÏóÖÎç∞Ïù¥Ìä∏
            updateSelects();
        }

        // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        function saveData() {
            localStorage.setItem('eelData_partners', JSON.stringify(partners));
            localStorage.setItem('eelData_orders', JSON.stringify(orders));
            localStorage.setItem('eelData_advances', JSON.stringify(advances));
            localStorage.setItem('eelData_payments', JSON.stringify(payments));
            localStorage.setItem('eelData_receipts', JSON.stringify(receipts));
            localStorage.setItem('eelData_partnerPrices', JSON.stringify(partnerPrices));
        }

        // ID ÏÉùÏÑ±
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // ÎÇ†Ïßú Ìè¨Îß∑ÌåÖ
        function formatDate(date) {
            return new Date(date).toLocaleDateString('ko-KR');
        }

        // Ïà´Ïûê Ìè¨Îß∑ÌåÖ
        function formatNumber(num) {
            return new Intl.NumberFormat('ko-KR').format(num);
        }

        // Ï¥ùÏï° ÏûêÎèô Í≥ÑÏÇ∞ (ÏÑ†Ï£ºÎ¨∏)
        function calculateOrderTotal() {
            const quantity = parseFloat(document.getElementById('orderQuantity').value) || 0;
            const price = parseFloat(document.getElementById('orderPrice').value) || 0;
            const total = quantity * price;
            
            const totalField = document.getElementById('orderTotal');
            if (total > 0) {
                totalField.value = formatNumber(total) + 'Ïõê';
            } else {
                totalField.value = '';
            }
        }

        // Í±∞ÎûòÏ≤ò Ï∂îÍ∞Ä
        function addPartner() {
            const name = document.getElementById('partnerName').value.trim();
            const contact = document.getElementById('partnerContact').value.trim();
            
            if (!name) {
                alert('Í±∞ÎûòÏ≤òÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const partner = {
                id: generateId(),
                name: name,
                contact: contact,
                createdAt: new Date().toISOString()
            };
            
            partners.push(partner);
            saveData();
            
            // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            document.getElementById('partnerName').value = '';
            document.getElementById('partnerContact').value = '';
            
            updatePartnersList();
            updateSelects();
            updateDashboard();
            alert('Í±∞ÎûòÏ≤òÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
        }

        // Ï¥àÍ∏∞ Î°úÎìú
        document.addEventListener('DOMContentLoaded', function() {
            // ÎÇ†Ïßú ÌïÑÎìú Ï¥àÍ∏∞Ìôî (Ïò§Îäò ÎÇ†ÏßúÎ°ú ÏÑ§Ï†ï)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('orderDate').value = today;
            document.getElementById('advanceDate').value = today;
            document.getElementById('paymentDate').value = today;
            document.getElementById('receiptDate').value = today;
            
            updateDashboard();
            updateSelects();
        });

        // ÏûÑÏãú ÏóÖÎç∞Ïù¥Ìä∏ Ìï®ÏàòÎì§ (Ï∂îÌõÑ Íµ¨ÌòÑ)
        function updateDashboard() {
            updateStats();
            updatePartnersDashboard();
        }
        
        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats() {
            const statsContainer = document.getElementById('statsGrid');
            if (!statsContainer) return;
            
            // Í∏∞Î≥∏ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
            const totalPartners = partners.length;
            const totalOrders = orders.length;
            const totalPayments = payments.length;
            const totalReceipts = receipts.length;
            
            // ÌëúÏãúÎêòÎäî Ïô∏ÏÉÅÎßå Í≥ÑÏÇ∞ (hiddenÏù¥ falseÏù¥Í±∞ÎÇò undefinedÏù∏ Í≤ÉÎì§)
            const visibleAdvances = advances.filter(a => a.hidden !== true);
            const totalVisibleAdvances = visibleAdvances.length;
            const totalAdvanceAmount = visibleAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
            
            // Ï¥ù ÏÑ†Ï£ºÎ¨∏ Í∏àÏï°
            const totalOrderAmount = orders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
            
            // Ï¥ù ÏßÄÎ∂à Í∏àÏï° (ÎÇ¥Í∞Ä ÏßÄÎ∂àÌïú Îèà)
            const totalPaymentAmount = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
            
            // Ï¥ù ÏûÖÍ≥† ÏàòÎüâ (ÎÇ¥Í∞Ä Î∞õÏùÄ Ïû•Ïñ¥)
            const totalReceiptQuantity = receipts.reduce((sum, r) => sum + (r.quantity || 0), 0);
            
            // Ï¥ù Ï§Ñ Îèà (ÎÇ¥Í∞Ä ÏßÄÎ∂àÌï¥Ïïº Ìï† Îèà: ÏÑ†Ï£ºÎ¨∏ + Ïô∏ÏÉÅ - ÏßÄÎ∂àÏôÑÎ£å)
            const totalAmountToPay = totalOrderAmount + totalAdvanceAmount - totalPaymentAmount;
            
            // Ï¥ù Î∞õÏùÑ Ïû•Ïñ¥ (ÎÇ¥Í∞Ä Î∞õÏïÑÏïº Ìï† Ïû•Ïñ¥: ÏÑ†Ï£ºÎ¨∏ ÏàòÎüâ - ÏûÖÍ≥†ÏôÑÎ£å)
            const totalOrderQuantity = orders.reduce((sum, o) => sum + (o.quantity || 0), 0);
            const totalEelToReceive = totalOrderQuantity - totalReceiptQuantity;
            
            console.log('ÎåÄÏãúÎ≥¥Îìú ÌÜµÍ≥Ñ:', {
                totalPartners,
                totalOrders,
                totalVisibleAdvances,
                totalAdvanceAmount,
                totalOrderAmount,
                totalPaymentAmount,
                totalReceiptQuantity,
                totalAmountToPay,
                totalEelToReceive
            });
            
            statsContainer.innerHTML = `
                <div class="stat-card" style="border-left-color: #ef4444;">
                    <div class="stat-number" style="color: #ef4444;">${formatNumber(totalAmountToPay)}Ïõê</div>
                    <div>üí∞ Ï¥ù Ï§Ñ Îèà</div>
                </div>
                <div class="stat-card" style="border-left-color: #10b981;">
                    <div class="stat-number" style="color: #10b981;">${formatNumber(totalEelToReceive)}kg</div>
                    <div>üêç Ï¥ù Î∞õÏùÑ Ïû•Ïñ¥</div>
                </div>
                <div class="stat-card" style="border-left-color: #f59e0b;">
                    <div class="stat-number" style="color: #f59e0b;">${formatNumber(totalAdvanceAmount)}Ïõê</div>
                    <div>‚ö†Ô∏è Ï¥ù Ïô∏ÏÉÅ (${totalVisibleAdvances}Í±¥)</div>
                </div>
                <div class="stat-card" style="border-left-color: #3b82f6;">
                    <div class="stat-number" style="color: #3b82f6;">${totalPartners}</div>
                    <div>üë• Ï¥ù Í±∞ÎûòÏ≤ò</div>
                </div>
            `;
        }
        
        // ÎåÄÏãúÎ≥¥Îìú Í±∞ÎûòÏ≤ò ÌòÑÌô©
        function updatePartnersDashboard() {
            const container = document.getElementById('partnersList');
            if (!container) return;
            
            container.innerHTML = '<h3>üè¢ Ï£ºÏöî Í±∞ÎûòÏ≤ò ÌòÑÌô©</h3>';
            
            if (partners.length === 0) {
                container.innerHTML += '<p>Îì±Î°ùÎêú Í±∞ÎûòÏ≤òÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            // Í±∞ÎûòÏ≤òÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞ Î∞è Ï†ïÎ†¨
            const partnerData = partners.map(partner => {
                // Ìï¥Îãπ Í±∞ÎûòÏ≤òÏùò ÌëúÏãúÎêòÎäî Ïô∏ÏÉÅÍ∏àÏï° Í≥ÑÏÇ∞
                const partnerAdvances = advances.filter(a => a.partnerId === partner.id && a.hidden !== true);
                const totalAdvanceAmount = partnerAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
                
                // Ìï¥Îãπ Í±∞ÎûòÏ≤òÏùò ÏÑ†Ï£ºÎ¨∏ Í∏àÏï° Î∞è ÏàòÎüâ (ÎÇ¥Í∞Ä Ï§Ñ Îèà, ÎÇ¥Í∞Ä Î∞õÏùÑ Ïû•Ïñ¥)
                const partnerOrders = orders.filter(o => o.partnerId === partner.id);
                const totalOrderAmount = partnerOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
                const totalOrderQuantity = partnerOrders.reduce((sum, o) => sum + (o.quantity || 0), 0);
                
                // Ìï¥Îãπ Í±∞ÎûòÏ≤òÏùò ÏûÖÍ∏à Í∏àÏï° (ÎÇ¥Í∞Ä ÏßÄÎ∂àÌïú Îèà)
                const partnerPayments = payments.filter(p => p.partnerId === partner.id);
                const totalPaymentAmount = partnerPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
                
                // Ìï¥Îãπ Í±∞ÎûòÏ≤òÏùò ÏûÖÍ≥† ÏàòÎüâ (ÎÇ¥Í∞Ä Î∞õÏùÄ Ïû•Ïñ¥)
                const partnerReceipts = receipts.filter(r => r.partnerId === partner.id);
                const totalReceiptQuantity = partnerReceipts.reduce((sum, r) => sum + (r.quantity || 0), 0);
                
                // ÎÇ¥Í∞Ä Ï§Ñ Îèà (ÏÑ†Ï£ºÎ¨∏ + Ïô∏ÏÉÅ - ÏûÖÍ∏à)
                const amountToPay = totalOrderAmount + totalAdvanceAmount - totalPaymentAmount;
                
                // ÎÇ¥Í∞Ä Î∞õÏùÑ Ïû•Ïñ¥ (ÏÑ†Ï£ºÎ¨∏ - ÏûÖÍ≥†)
                const eelToReceive = totalOrderQuantity - totalReceiptQuantity;
                
                // ÏµúÍ∑º Í±∞Îûò Í∞ÄÍ≤© Ï∞æÍ∏∞
                let latestPrice = 0;
                if (partnerOrders.length > 0) {
                    const sortedOrders = partnerOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    latestPrice = sortedOrders[0].price;
                }
                
                const totalAmount = totalAdvanceAmount + totalOrderAmount;
                
                return {
                    partner,
                    totalAdvanceAmount,
                    totalOrderAmount,
                    totalOrderQuantity,
                    totalPaymentAmount,
                    totalReceiptQuantity,
                    amountToPay,
                    eelToReceive,
                    latestPrice,
                    totalAmount,
                    advanceCount: partnerAdvances.length,
                    orderCount: partnerOrders.length,
                    paymentCount: partnerPayments.length,
                    receiptCount: partnerReceipts.length
                };
            }).filter(data => data.totalAmount > 0 || data.totalPaymentAmount > 0 || data.totalReceiptQuantity > 0) // Í±∞ÎûòÍ∞Ä ÏûàÎäî Í±∞ÎûòÏ≤òÎßå
              .sort((a, b) => Math.abs(b.amountToPay) - Math.abs(a.amountToPay)); // Ï§Ñ Îèà Ï†àÎåìÍ∞í ÎÇ¥Î¶ºÏ∞®Ïàú
            
            if (partnerData.length === 0) {
                container.innerHTML += '<p>Í±∞Îûò ÎÇ¥Ïó≠Ïù¥ ÏûàÎäî Í±∞ÎûòÏ≤òÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            partnerData.forEach(data => {
                const partnerDiv = document.createElement('div');
                partnerDiv.className = 'card';
                
                // ÏÉÅÌÉú ÌëúÏãúÎ•º ÏúÑÌïú ÏÉâÏÉÅ Í≤∞Ï†ï
                let statusColor = '#10b981'; // Í∏∞Î≥∏ ÎÖπÏÉâ (Ï†ïÏÉÅ)
                if (data.amountToPay < 0) {
                    statusColor = '#8b5cf6'; // Ï¥àÍ≥º ÏßÄÎ∂à (Î≥¥ÎùºÏÉâ)
                } else if (data.totalAdvanceAmount > 500000) {
                    statusColor = '#ef4444'; // Ïô∏ÏÉÅÏù¥ 50ÎßåÏõê Ïù¥ÏÉÅÏù¥Î©¥ Îπ®Í∞ÑÏÉâ
                } else if (data.totalAdvanceAmount > 0) {
                    statusColor = '#f59e0b'; // Ïô∏ÏÉÅÏù¥ ÏûàÏúºÎ©¥ Ï£ºÌô©ÏÉâ
                }
                
                partnerDiv.style.borderLeft = `4px solid ${statusColor}`;
                
                // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Ï†ïÎ≥¥ Íµ¨ÏÑ±
                let categoriesHTML = '';
                
                // 1. Ï§Ñ Îèà (ÎÇ¥Í∞Ä ÏßÄÎ∂àÌï¥Ïïº Ìï† Îèà)
                if (data.amountToPay > 0) {
                    categoriesHTML += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span style="color: #ef4444;">üí∞ Ï§Ñ Îèà:</span>
                            <strong style="color: #ef4444;">${formatNumber(data.amountToPay)}Ïõê</strong>
                        </div>
                    `;
                } else if (data.amountToPay < 0) {
                    categoriesHTML += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span style="color: #8b5cf6;">üíú Ï¥àÍ≥ºÏßÄÎ∂à:</span>
                            <strong style="color: #8b5cf6;">${formatNumber(Math.abs(data.amountToPay))}Ïõê</strong>
                        </div>
                    `;
                }
                
                // 2. Î∞õÏùÑ Ïû•Ïñ¥ (ÎÇ¥Í∞Ä Î∞õÏïÑÏïº Ìï† Ïû•Ïñ¥)
                if (data.eelToReceive > 0) {
                    categoriesHTML += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span style="color: #10b981;">üêç Î∞õÏùÑ Ïû•Ïñ¥:</span>
                            <strong style="color: #10b981;">${formatNumber(data.eelToReceive)}kg</strong>
                        </div>
                    `;
                } else if (data.eelToReceive < 0) {
                    categoriesHTML += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span style="color: #06b6d4;">üì¶ Ï¥àÍ≥ºÏûÖÍ≥†:</span>
                            <strong style="color: #06b6d4;">${formatNumber(Math.abs(data.eelToReceive))}kg</strong>
                        </div>
                    `;
                }
                
                // 3. Ïô∏ÏÉÅ
                if (data.totalAdvanceAmount > 0) {
                    categoriesHTML += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span style="color: #f59e0b;">üí≥ Ïô∏ÏÉÅ:</span>
                            <strong style="color: #f59e0b;">${formatNumber(data.totalAdvanceAmount)}Ïõê (${data.advanceCount}Í±¥)</strong>
                        </div>
                    `;
                }
                
                // 4. ÏÑ†Ï£ºÎ¨∏ ÌòÑÌô©
                if (data.totalOrderAmount > 0) {
                    categoriesHTML += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span style="color: #3b82f6;">üì¶ ÏÑ†Ï£ºÎ¨∏:</span>
                            <strong style="color: #3b82f6;">${formatNumber(data.totalOrderAmount)}Ïõê (${formatNumber(data.totalOrderQuantity)}kg)</strong>
                        </div>
                    `;
                }
                
                // 5. ÏßÄÎ∂à ÌòÑÌô© (ÏûÖÍ∏à -> ÏßÄÎ∂àÎ°ú Î≥ÄÍ≤Ω)
                if (data.totalPaymentAmount > 0) {
                    categoriesHTML += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span style="color: #8b5cf6;">üí∏ ÏßÄÎ∂àÏôÑÎ£å:</span>
                            <strong style="color: #8b5cf6;">${formatNumber(data.totalPaymentAmount)}Ïõê (${data.paymentCount}Í±¥)</strong>
                        </div>
                    `;
                }
                
                // 6. ÏûÖÍ≥† ÌòÑÌô©
                if (data.totalReceiptQuantity > 0) {
                    categoriesHTML += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span style="color: #06b6d4;">üì• ÏûÖÍ≥†ÏôÑÎ£å:</span>
                            <strong style="color: #06b6d4;">${formatNumber(data.totalReceiptQuantity)}kg (${data.receiptCount}Í±¥)</strong>
                        </div>
                    `;
                }
                
                // ÏÉÅÌÉú ÌëúÏãú
                let statusText = 'Ï†ïÏÉÅ';
                let statusIcon = '‚úÖ';
                if (data.amountToPay < 0) {
                    statusText = 'Ï¥àÍ≥ºÏßÄÎ∂à';
                    statusIcon = 'üíú';
                } else if (data.totalAdvanceAmount > 500000) {
                    statusText = 'Í≥†Ïï°Ïô∏ÏÉÅ';
                    statusIcon = 'üö®';
                } else if (data.totalAdvanceAmount > 0) {
                    statusText = 'Ïô∏ÏÉÅÏûàÏùå';
                    statusIcon = '‚ö†Ô∏è';
                }
                
                // ÏµúÍ∑º Îã®Í∞Ä ÌëúÏãú
                const priceDisplay = data.latestPrice > 0 ? `(${formatNumber(data.latestPrice)}Ïõê/kg)` : '';
                
                // ÌïµÏã¨ Ï†ïÎ≥¥Îßå ÌÅ¨Í≤å ÌëúÏãú
                let mainInfoHTML = '';
                
                if (data.amountToPay > 0) {
                    mainInfoHTML += `
                        <div style="background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; padding: 10px; margin-bottom: 8px;">
                            <div style="color: #dc2626; font-weight: bold; font-size: 14px;">üí∞ Ï§Ñ Îèà</div>
                            <div style="color: #dc2626; font-size: 18px; font-weight: bold;">${formatNumber(data.amountToPay)}Ïõê</div>
                        </div>
                    `;
                }
                
                if (data.eelToReceive > 0) {
                    mainInfoHTML += `
                        <div style="background: #dcfce7; border: 1px solid #10b981; border-radius: 6px; padding: 10px; margin-bottom: 8px;">
                            <div style="color: #059669; font-weight: bold; font-size: 14px;">üêç Î∞õÏùÑ Ïû•Ïñ¥</div>
                            <div style="color: #059669; font-size: 18px; font-weight: bold;">${formatNumber(data.eelToReceive)}kg</div>
                        </div>
                    `;
                }
                
                // Ïô∏ÏÉÅÏù¥ ÏûàÏúºÎ©¥ Í≤ΩÍ≥† ÌëúÏãú
                if (data.totalAdvanceAmount > 0) {
                    mainInfoHTML += `
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 10px; margin-bottom: 8px;">
                            <div style="color: #d97706; font-weight: bold; font-size: 14px;">‚ö†Ô∏è Ïô∏ÏÉÅ</div>
                            <div style="color: #d97706; font-size: 18px; font-weight: bold;">${formatNumber(data.totalAdvanceAmount)}Ïõê</div>
                        </div>
                    `;
                }
                
                // Ï¥àÍ≥º ÏßÄÎ∂à/ÏûÖÍ≥†Ïù∏ Í≤ΩÏö∞
                if (data.amountToPay < 0) {
                    mainInfoHTML += `
                        <div style="background: #f3e8ff; border: 1px solid #8b5cf6; border-radius: 6px; padding: 10px; margin-bottom: 8px;">
                            <div style="color: #7c3aed; font-weight: bold; font-size: 14px;">üíú Ï¥àÍ≥ºÏßÄÎ∂à</div>
                            <div style="color: #7c3aed; font-size: 18px; font-weight: bold;">${formatNumber(Math.abs(data.amountToPay))}Ïõê</div>
                        </div>
                    `;
                }
                
                if (data.eelToReceive < 0) {
                    mainInfoHTML += `
                        <div style="background: #ecfeff; border: 1px solid #06b6d4; border-radius: 6px; padding: 10px; margin-bottom: 8px;">
                            <div style="color: #0891b2; font-weight: bold; font-size: 14px;">üì¶ Ï¥àÍ≥ºÏûÖÍ≥†</div>
                            <div style="color: #0891b2; font-size: 18px; font-weight: bold;">${formatNumber(Math.abs(data.eelToReceive))}kg</div>
                        </div>
                    `;
                }
                
                // ÏÉÅÏÑ∏ Ï†ïÎ≥¥ (Ï†ëÏùÑ Ïàò ÏûàÍ≤å)
                const detailsHTML = `
                    <details style="margin-top: 10px; font-size: 11px; color: #666;">
                        <summary style="cursor: pointer; font-weight: 600; color: #374151;">ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î≥¥Í∏∞</summary>
                        <div style="margin-top: 8px; padding: 8px; background: #f9fafb; border-radius: 4px;">
                            ${data.totalOrderAmount > 0 ? `üì¶ Ï¥ù ÏÑ†Ï£ºÎ¨∏: ${formatNumber(data.totalOrderAmount)}Ïõê (${formatNumber(data.totalOrderQuantity)}kg)<br>` : ''}
                            ${data.totalPaymentAmount > 0 ? `üí∏ Ï¥ù ÏßÄÎ∂à: ${formatNumber(data.totalPaymentAmount)}Ïõê (${data.paymentCount}Í±¥)<br>` : ''}
                            ${data.totalReceiptQuantity > 0 ? `üì• Ï¥ù ÏûÖÍ≥†: ${formatNumber(data.totalReceiptQuantity)}kg (${data.receiptCount}Í±¥)<br>` : ''}
                            ${data.totalAdvanceAmount > 0 ? `üí≥ Ï¥ù Ïô∏ÏÉÅ: ${formatNumber(data.totalAdvanceAmount)}Ïõê (${data.advanceCount}Í±¥)<br>` : ''}
                        </div>
                    </details>
                `;
                
                // Í∞ÄÍ≤© ÏûÖÎ†• ÏÑπÏÖò
                const priceInputHTML = `
                    <div class="partner-price-input">
                        <h4>üìÖ ${data.partner.name} Ïû•Ïñ¥ Îã®Í∞Ä ÏûÖÎ†•</h4>
                        <div class="price-input-group">
                            <input type="number" id="dashboardPrice_${data.partner.id}" placeholder="Îã®Í∞Ä ÏûÖÎ†•" style="width: 80px;">
                            <span style="font-size: 12px; color: #666;">Ïõê/kg</span>
                            <button class="btn" onclick="setDashboardPrice('${data.partner.id}')">Ïò§Îäò Îã®Í∞Ä Ï†ÄÏû•</button>
                            <button class="btn" onclick="toggleDashboardCalendar('${data.partner.id}')" style="background: #3b82f6;">Îã¨Î†• Î≥¥Í∏∞</button>
                        </div>
                        <div id="dashboardCalendar_${data.partner.id}" class="dashboard-calendar" style="display: none;">
                            <!-- Îã¨Î†•Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                        </div>
                    </div>
                `;
                
                partnerDiv.innerHTML = `
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <strong style="font-size: 16px;">${data.partner.name}</strong>
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <input type="number" id="quickPrice_${data.partner.id}" placeholder="Îã®Í∞Ä" style="width: 70px; padding: 4px 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px;">
                                        <span style="font-size: 11px; color: #666;">Ïõê/kg</span>
                                        <button class="btn" onclick="setQuickPrice('${data.partner.id}')" style="padding: 4px 8px; font-size: 11px; background: #10b981;">Ï†ÄÏû•</button>
                                        <button class="btn" onclick="toggleQuickCalendar('${data.partner.id}')" style="padding: 4px 8px; font-size: 11px; background: #3b82f6;">üìÖ Îã¨Î†•</button>
                                    </div>
                                </div>
                                ${priceDisplay ? `<div style="font-size: 12px; color: #666;">ÏµúÍ∑ºÎã®Í∞Ä: ${priceDisplay}</div>` : ''}
                                <div id="quickCalendar_${data.partner.id}" class="dashboard-calendar" style="display: none;">
                                    <!-- ÏûëÏùÄ Îã¨Î†•Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span style="font-size: 12px;">${statusIcon}</span>
                                <span style="font-size: 11px; color: #666;">${statusText}</span>
                            </div>
                        </div>
                        ${mainInfoHTML || '<div style="color: #999; text-align: center; padding: 20px;">Í±∞Îûò ÎÇ¥Ïó≠ ÏóÜÏùå</div>'}
                        ${detailsHTML}
                    </div>
                `;
                container.appendChild(partnerDiv);
                
                // Îã¨Î†• ÏûêÎèô Î†åÎçîÎßÅ
                setTimeout(() => {
                    renderQuickCalendar(data.partner.id);
                }, 100);
            });
        }

        function updatePartnersList() {
            const container = document.getElementById('partnerManagementList');
            if (!container) return;
            
            container.innerHTML = '<h3>Í±∞ÎûòÏ≤ò Î™©Î°ù</h3>';
            
            if (partners.length === 0) {
                container.innerHTML += '<p>Îì±Î°ùÎêú Í±∞ÎûòÏ≤òÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            partners.forEach(partner => {
                const partnerDiv = document.createElement('div');
                partnerDiv.className = 'partner-item';
                partnerDiv.innerHTML = `
                    <div>
                        <strong>${partner.name}</strong>
                        <br>
                        <small>Ïó∞ÎùΩÏ≤ò: ${partner.contact || 'ÏóÜÏùå'}</small>
                        <br>
                        <small>Îì±Î°ùÏùº: ${formatDate(partner.createdAt)}</small>
                    </div>
                    <div>
                        <button class="btn" onclick="editPartner('${partner.id}')">ÏàòÏ†ï</button>
                        <button class="btn btn-danger" onclick="deletePartner('${partner.id}')">ÏÇ≠Ï†ú</button>
                    </div>
                `;
                container.appendChild(partnerDiv);
            });
        }

        function updateOrdersList() {
            const container = document.getElementById('ordersList');
            if (!container) return;
            
            container.innerHTML = '<h3>ÏÑ†Ï£ºÎ¨∏ Î™©Î°ù</h3>';
            
            if (orders.length === 0) {
                container.innerHTML += '<p>Îì±Î°ùÎêú ÏÑ†Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            orders.reverse().forEach(order => {
                const partner = partners.find(p => p.id === order.partnerId);
                const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                
                const orderDiv = document.createElement('div');
                orderDiv.className = 'partner-item';
                orderDiv.innerHTML = `
                    <div>
                        <strong>${partnerName}</strong>
                        <br>
                        <small>üìÖ Ï£ºÎ¨∏ÎÇ†Ïßú: ${order.orderDate ? formatDate(order.orderDate) : 'ÎÇ†ÏßúÏóÜÏùå'}</small>
                        <br>
                        <small>ÏàòÎüâ: ${formatNumber(order.quantity)}kg</small>
                        <br>
                        <small>Îã®Í∞Ä: ${formatNumber(order.price)}Ïõê/kg</small>
                        <br>
                        <small>Ï¥ùÏï°: ${formatNumber(order.totalAmount)}Ïõê</small>
                        <br>
                        <small>Î©îÎ™®: ${order.memo || 'ÏóÜÏùå'}</small>
                        <br>
                        <small>Îì±Î°ùÏùº: ${formatDate(order.createdAt)}</small>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deleteOrder('${order.id}')">ÏÇ≠Ï†ú</button>
                    </div>
                `;
                container.appendChild(orderDiv);
            });
            orders.reverse(); // ÏõêÎûò ÏàúÏÑúÎ°ú Î≥µÏõê
        }

        function updateAdvancesList() {
            const container = document.getElementById('advancesList');
            if (!container) return;
            
            container.innerHTML = '<h3>Ïô∏ÏÉÅ Î™©Î°ù</h3>';
            
            if (advances.length === 0) {
                container.innerHTML += '<p>Îì±Î°ùÎêú Ïô∏ÏÉÅÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            advances.reverse().forEach(advance => {
                const partner = partners.find(p => p.id === advance.partnerId);
                const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                
                const advanceDiv = document.createElement('div');
                advanceDiv.className = 'partner-item';
                advanceDiv.innerHTML = `
                    <div>
                        <strong>${partnerName}</strong>
                        <br>
                        <small>üìÖ Ïô∏ÏÉÅÎÇ†Ïßú: ${advance.advanceDate ? formatDate(advance.advanceDate) : 'ÎÇ†ÏßúÏóÜÏùå'}</small>
                        <br>
                        <small>Ïô∏ÏÉÅÍ∏àÏï°: ${formatNumber(advance.amount)}Ïõê</small>
                        <br>
                        <small>Î©îÎ™®: ${advance.memo || 'ÏóÜÏùå'}</small>
                        <br>
                        <small>ÎåÄÏãúÎ≥¥Îìú ÌëúÏãú: ${advance.hidden ? 'Ïà®ÍπÄ' : 'ÌëúÏãú'}</small>
                        <br>
                        <small>Îì±Î°ùÏùº: ${formatDate(advance.createdAt)}</small>
                    </div>
                    <div>
                        <button class="btn" onclick="toggleAdvanceVisibility('${advance.id}')">${advance.hidden ? 'ÌëúÏãú' : 'Ïà®ÍπÄ'}</button>
                        <button class="btn btn-danger" onclick="deleteAdvance('${advance.id}')">ÏÇ≠Ï†ú</button>
                    </div>
                `;
                container.appendChild(advanceDiv);
            });
            advances.reverse(); // ÏõêÎûò ÏàúÏÑúÎ°ú Î≥µÏõê
        }

        function updatePaymentsList() {
            const container = document.getElementById('paymentsList');
            if (!container) return;
            
            container.innerHTML = '<h3>ÏûÖÍ∏à Î™©Î°ù</h3>';
            
            if (payments.length === 0) {
                container.innerHTML += '<p>Îì±Î°ùÎêú ÏûÖÍ∏àÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            payments.reverse().forEach(payment => {
                const partner = partners.find(p => p.id === payment.partnerId);
                const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                
                const paymentDiv = document.createElement('div');
                paymentDiv.className = 'partner-item';
                paymentDiv.innerHTML = `
                    <div>
                        <strong>${partnerName}</strong>
                        <br>
                        <small>üìÖ ÏûÖÍ∏àÎÇ†Ïßú: ${payment.paymentDate ? formatDate(payment.paymentDate) : 'ÎÇ†ÏßúÏóÜÏùå'}</small>
                        <br>
                        <small>ÏûÖÍ∏àÏï°: ${formatNumber(payment.amount)}Ïõê</small>
                        <br>
                        <small>Î©îÎ™®: ${payment.memo || 'ÏóÜÏùå'}</small>
                        <br>
                        <small>Îì±Î°ùÏùº: ${formatDate(payment.createdAt)}</small>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deletePayment('${payment.id}')">ÏÇ≠Ï†ú</button>
                    </div>
                `;
                container.appendChild(paymentDiv);
            });
            payments.reverse(); // ÏõêÎûò ÏàúÏÑúÎ°ú Î≥µÏõê
        }

        function updateReceiptsList() {
            const container = document.getElementById('receiptsList');
            if (!container) return;
            
            container.innerHTML = '<h3>ÏûÖÍ≥† Î™©Î°ù</h3>';
            
            if (receipts.length === 0) {
                container.innerHTML += '<p>Îì±Î°ùÎêú ÏûÖÍ≥†Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            receipts.reverse().forEach(receipt => {
                const partner = partners.find(p => p.id === receipt.partnerId);
                const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                
                const receiptDiv = document.createElement('div');
                receiptDiv.className = 'partner-item';
                receiptDiv.innerHTML = `
                    <div>
                        <strong>${partnerName}</strong>
                        <br>
                        <small>üìÖ ÏûÖÍ≥†ÎÇ†Ïßú: ${receipt.receiptDate ? formatDate(receipt.receiptDate) : 'ÎÇ†ÏßúÏóÜÏùå'}</small>
                        <br>
                        <small>ÏàòÎüâ: ${formatNumber(receipt.quantity)}kg</small>
                        <br>
                        <small>Î©îÎ™®: ${receipt.memo || 'ÏóÜÏùå'}</small>
                        <br>
                        <small>Îì±Î°ùÏùº: ${formatDate(receipt.createdAt)}</small>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deleteReceipt('${receipt.id}')">ÏÇ≠Ï†ú</button>
                    </div>
                `;
                container.appendChild(receiptDiv);
            });
            receipts.reverse(); // ÏõêÎûò ÏàúÏÑúÎ°ú Î≥µÏõê
        }

        function updateHistoryList() {
            const container = document.getElementById('historyList');
            if (!container) return;
            
            const selectedPartnerId = document.getElementById('historyFilter').value;
            
            container.innerHTML = '<h3>Í±∞ÎûòÎÇ¥Ïó≠</h3>';
            
            // Î™®Îì† Í±∞Îûò Îç∞Ïù¥ÌÑ∞Î•º ÌïòÎÇòÏùò Î∞∞Ïó¥Î°ú ÌÜµÌï©
            let allTransactions = [];
            
            // ÏÑ†Ï£ºÎ¨∏ Ï∂îÍ∞Ä
            orders.forEach(order => {
                const partner = partners.find(p => p.id === order.partnerId);
                if (!selectedPartnerId || order.partnerId === selectedPartnerId) {
                    allTransactions.push({
                        type: 'ÏÑ†Ï£ºÎ¨∏',
                        partner: partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò',
                        amount: order.totalAmount,
                        quantity: order.quantity,
                        price: order.price,
                        memo: order.memo,
                        transactionDate: order.orderDate,
                        date: order.createdAt,
                        icon: 'üì¶'
                    });
                }
            });
            
            // Ïô∏ÏÉÅ Ï∂îÍ∞Ä
            advances.forEach(advance => {
                const partner = partners.find(p => p.id === advance.partnerId);
                if (!selectedPartnerId || advance.partnerId === selectedPartnerId) {
                    allTransactions.push({
                        type: 'Ïô∏ÏÉÅ',
                        partner: partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò',
                        amount: advance.amount,
                        memo: advance.memo,
                        transactionDate: advance.advanceDate,
                        date: advance.createdAt,
                        icon: 'üí≥',
                        hidden: advance.hidden
                    });
                }
            });
            
            // ÏûÖÍ∏à Ï∂îÍ∞Ä
            payments.forEach(payment => {
                const partner = partners.find(p => p.id === payment.partnerId);
                if (!selectedPartnerId || payment.partnerId === selectedPartnerId) {
                    allTransactions.push({
                        type: 'ÏûÖÍ∏à',
                        partner: partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò',
                        amount: payment.amount,
                        memo: payment.memo,
                        transactionDate: payment.paymentDate,
                        date: payment.createdAt,
                        icon: 'üí∞'
                    });
                }
            });
            
            // ÏûÖÍ≥† Ï∂îÍ∞Ä
            receipts.forEach(receipt => {
                const partner = partners.find(p => p.id === receipt.partnerId);
                if (!selectedPartnerId || receipt.partnerId === selectedPartnerId) {
                    allTransactions.push({
                        type: 'ÏûÖÍ≥†',
                        partner: partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò',
                        quantity: receipt.quantity,
                        memo: receipt.memo,
                        transactionDate: receipt.receiptDate,
                        date: receipt.createdAt,
                        icon: 'üì•'
                    });
                }
            });
            
            if (allTransactions.length === 0) {
                container.innerHTML += '<p>Í±∞ÎûòÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            // ÎÇ†ÏßúÏàúÏúºÎ°ú Ï†ïÎ†¨ (ÏµúÏã†Ïàú)
            allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            allTransactions.forEach(transaction => {
                const transactionDiv = document.createElement('div');
                transactionDiv.className = 'partner-item';
                
                let details = '';
                if (transaction.type === 'ÏÑ†Ï£ºÎ¨∏') {
                    details = `<small>ÏàòÎüâ: ${formatNumber(transaction.quantity)}kg, Îã®Í∞Ä: ${formatNumber(transaction.price)}Ïõê/kg</small><br>`;
                } else if (transaction.type === 'ÏûÖÍ≥†') {
                    details = `<small>ÏàòÎüâ: ${formatNumber(transaction.quantity)}kg</small><br>`;
                }
                
                const amountDisplay = transaction.amount ? `<small>Í∏àÏï°: ${formatNumber(transaction.amount)}Ïõê</small><br>` : '';
                const hiddenStatus = transaction.hidden ? ' <span style="color: #999;">(Ïà®ÍπÄ)</span>' : '';
                
                transactionDiv.innerHTML = `
                    <div>
                        <strong>${transaction.icon} ${transaction.type}${hiddenStatus}</strong>
                        <br>
                        <small>Í±∞ÎûòÏ≤ò: ${transaction.partner}</small>
                        <br>
                        ${transaction.transactionDate ? `<small>üìÖ Í±∞ÎûòÎÇ†Ïßú: ${formatDate(transaction.transactionDate)}</small><br>` : ''}
                        ${details}
                        ${amountDisplay}
                        <small>Î©îÎ™®: ${transaction.memo || 'ÏóÜÏùå'}</small>
                        <br>
                        <small>Îì±Î°ùÏùº: ${formatDate(transaction.date)}</small>
                    </div>
                `;
                container.appendChild(transactionDiv);
            });
        }

        function updateSelects() {
            const selects = ['orderPartner', 'advancePartner', 'paymentPartner', 'receiptPartner', 'historyFilter'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // Í∏∞Ï°¥ ÏòµÏÖò Ï†úÍ±∞ (Ï≤´ Î≤àÏß∏ ÏòµÏÖò Ï†úÏô∏)
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    // Í±∞ÎûòÏ≤ò ÏòµÏÖò Ï∂îÍ∞Ä
                    partners.forEach(partner => {
                        const option = document.createElement('option');
                        option.value = partner.id;
                        option.textContent = partner.name;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Í±∞ÎûòÏ≤ò ÏàòÏ†ï
        function editPartner(id) {
            const partner = partners.find(p => p.id === id);
            if (!partner) return;
            
            const newName = prompt('Í±∞ÎûòÏ≤òÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', partner.name);
            if (newName === null) return;
            
            if (!newName.trim()) {
                alert('Í±∞ÎûòÏ≤òÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const newContact = prompt('Ïó∞ÎùΩÏ≤òÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', partner.contact || '');
            
            partner.name = newName.trim();
            partner.contact = newContact ? newContact.trim() : '';
            partner.updatedAt = new Date().toISOString();
            
            saveData();
            updatePartnersList();
            updateSelects();
            alert('Í±∞ÎûòÏ≤òÍ∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.');
        }
        
        // Í±∞ÎûòÏ≤ò ÏÇ≠Ï†ú
        function deletePartner(id) {
            const partner = partners.find(p => p.id === id);
            if (!partner) return;
            
            if (!confirm(`'${partner.name}' Í±∞ÎûòÏ≤òÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÍ¥ÄÎ†®Îêú Î™®Îì† Í±∞Îûò Îç∞Ïù¥ÌÑ∞ÎèÑ Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§.`)) {
                return;
            }
            
            // Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
            orders = orders.filter(order => order.partnerId !== id);
            advances = advances.filter(advance => advance.partnerId !== id);
            payments = payments.filter(payment => payment.partnerId !== id);
            receipts = receipts.filter(receipt => receipt.partnerId !== id);
            partners = partners.filter(p => p.id !== id);
            
            saveData();
            updatePartnersList();
            updateSelects();
            alert('Í±∞ÎûòÏ≤òÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        }

        // Í±∞ÎûòÏ≤òÎ≥Ñ Ï†ïÎ≥¥ ÌëúÏãú
        function showPartnerInfo(type) {
            let partnerId, infoContainer;
            
            if (type === 'payment') {
                partnerId = document.getElementById('paymentPartner').value;
                infoContainer = document.getElementById('paymentPartnerInfo');
            } else if (type === 'receipt') {
                partnerId = document.getElementById('receiptPartner').value;
                infoContainer = document.getElementById('receiptPartnerInfo');
            }
            
            if (!partnerId || !infoContainer) {
                if (infoContainer) infoContainer.style.display = 'none';
                return;
            }
            
            const partner = partners.find(p => p.id === partnerId);
            if (!partner) {
                infoContainer.style.display = 'none';
                return;
            }
            
            // Í±∞ÎûòÏ≤ò Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞ (ÏßÄÎ∂àÍ¥ÄÎ¶¨ÏóêÏÑúÎäî Ïà®Í≤®ÏßÑ Ïô∏ÏÉÅÎèÑ Ìè¨Ìï®)
            const partnerAdvances = advances.filter(a => a.partnerId === partnerId);
            const totalAdvanceAmount = partnerAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
            const hiddenAdvances = partnerAdvances.filter(a => a.hidden === true);
            const visibleAdvances = partnerAdvances.filter(a => a.hidden !== true);
            
            const partnerOrders = orders.filter(o => o.partnerId === partnerId);
            const totalOrderAmount = partnerOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
            const totalOrderQuantity = partnerOrders.reduce((sum, o) => sum + (o.quantity || 0), 0);
            
            const partnerPayments = payments.filter(p => p.partnerId === partnerId);
            const totalPaymentAmount = partnerPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            
            const partnerReceipts = receipts.filter(r => r.partnerId === partnerId);
            const totalReceiptQuantity = partnerReceipts.reduce((sum, r) => sum + (r.quantity || 0), 0);
            
            // Ïã§Ï†ú Î∞õÏùÑ Í∏àÏï°Í≥º Î∞õÏùÑ Ïû•Ïñ¥
            const actualReceivable = totalOrderAmount + totalAdvanceAmount - totalPaymentAmount;
            const pendingEelQuantity = totalOrderQuantity - totalReceiptQuantity;
            
            let infoHTML = `<strong>${partner.name} Í±∞ÎûòÏ≤ò ÌòÑÌô©</strong><br><br>`;
            
            if (type === 'payment') {
                const hiddenAmount = hiddenAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
                const visibleAmount = visibleAdvances.reduce((sum, a) => sum + (a.amount || 0), 0);
                
                infoHTML += `
                    üí∞ <strong>Ï¥ù Ï§Ñ Îèà: ${formatNumber(actualReceivable)}Ïõê</strong><br><br>
                    üí≥ <strong style="color: #dc2626;">Ï¥ù Ïô∏ÏÉÅÍ∏àÏï°: ${formatNumber(totalAdvanceAmount)}Ïõê</strong><br>
                    ${visibleAmount > 0 ? `„ÄÄ‚îî ÌëúÏãúÎêú Ïô∏ÏÉÅ: ${formatNumber(visibleAmount)}Ïõê (${visibleAdvances.length}Í±¥)<br>` : ''}
                    ${hiddenAmount > 0 ? `„ÄÄ‚îî <span style="color: #6b7280;">Ïà®Í≤®ÏßÑ Ïô∏ÏÉÅ: ${formatNumber(hiddenAmount)}Ïõê (${hiddenAdvances.length}Í±¥)</span><br>` : ''}
                    üì¶ ÏÑ†Ï£ºÎ¨∏Í∏àÏï°: ${formatNumber(totalOrderAmount)}Ïõê<br>
                    üí∏ Í∏∞ÏßÄÎ∂àÍ∏àÏï°: ${formatNumber(totalPaymentAmount)}Ïõê<br><br>
                    <small>* ÏßÄÎ∂àÍ¥ÄÎ¶¨ÏóêÏÑúÎäî Î™®Îì† Ïô∏ÏÉÅ(Ïà®ÍπÄ Ìè¨Ìï®)Ïù¥ Í≥ÑÏÇ∞Ïóê Î∞òÏòÅÎê©ÎãàÎã§</small>
                `;
            } else if (type === 'receipt') {
                infoHTML += `
                    üêç <strong>Î∞õÏùÑ Ïû•Ïñ¥: ${formatNumber(pendingEelQuantity)}kg</strong><br>
                    üì¶ ÏÑ†Ï£ºÎ¨∏: ${formatNumber(totalOrderQuantity)}kg<br>
                    üì• Í∏∞ÏûÖÍ≥†: ${formatNumber(totalReceiptQuantity)}kg<br>
                    üí∞ Ï¥ùÏ£ºÎ¨∏Í∏àÏï°: ${formatNumber(totalOrderAmount)}Ïõê
                `;
            }
            
            infoContainer.innerHTML = infoHTML;
            infoContainer.style.display = 'block';
        }
        
        // Í±∞ÎûòÏ≤òÎ≥Ñ Îã¨Î†• ÌëúÏãú
        function showPartnerCalendar(type) {
            const partnerId = document.getElementById('orderPartner').value;
            const calendarContainer = document.getElementById('orderPartnerCalendar');
            
            if (!partnerId || !calendarContainer) {
                if (calendarContainer) calendarContainer.style.display = 'none';
                return;
            }
            
            const partner = partners.find(p => p.id === partnerId);
            if (!partner) {
                calendarContainer.style.display = 'none';
                return;
            }
            
            renderPartnerCalendar(partnerId, partner.name, calendarContainer);
            calendarContainer.style.display = 'block';
        }
        
        // Í±∞ÎûòÏ≤òÎ≥Ñ Îã¨Î†• Î†åÎçîÎßÅ
        function renderPartnerCalendar(partnerId, partnerName, container) {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            
            let calendarHTML = `
                <div class="partner-calendar-header">
                    ${partnerName} - ${year}ÎÖÑ ${month + 1}Ïõî Í∞ÄÍ≤© Îã¨Î†•
                </div>
                <div class="partner-calendar-grid">
            `;
            
            // ÏöîÏùº Ìó§Îçî
            const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
            days.forEach(day => {
                calendarHTML += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Îã¨Î†• ÎÇ†ÏßúÎì§
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + (week * 7) + day);
                    
                    const isCurrentMonth = cellDate.getMonth() === month;
                    const dateKey = formatDateKey(cellDate);
                    const priceKey = `${partnerId}_${dateKey}`;
                    const priceInfo = partnerPrices[priceKey];
                    
                    let cellClass = 'partner-calendar-cell';
                    if (!isCurrentMonth) cellClass += ' other-month';
                    if (priceInfo) cellClass += ' has-price';
                    
                    const priceBadge = priceInfo ? 
                        `<div class="calendar-price-badge">${formatNumber(priceInfo.price)}Ïõê</div>` : '';
                    
                    calendarHTML += `
                        <div class="${cellClass}" onclick="selectPartnerCalendarDate('${partnerId}', '${dateKey}', this)">
                            <div>${cellDate.getDate()}</div>
                            ${priceBadge}
                        </div>
                    `;
                }
            }
            
            calendarHTML += `</div>`;
            
            // Í∞ÄÍ≤© ÏûÖÎ†• ÏÑπÏÖò
            calendarHTML += `
                <div class="price-input-section" id="partnerPriceInput_${partnerId}" style="display: none;">
                    <h4>Í∞ÄÍ≤© ÏÑ§Ï†ï</h4>
                    <div style="margin-bottom: 10px;">
                        <strong id="selectedPartnerDate_${partnerId}"></strong>
                    </div>
                    <div class="form-group">
                        <label>Ïû•Ïñ¥ Îã®Í∞Ä (Ïõê/kg)</label>
                        <input type="number" id="partnerPrice_${partnerId}" placeholder="Îã®Í∞ÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <div class="form-group">
                        <label>Î©îÎ™®</label>
                        <input type="text" id="partnerPriceNote_${partnerId}" placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <button class="btn" onclick="setPartnerPrice('${partnerId}')">Í∞ÄÍ≤© ÏÑ§Ï†ï</button>
                    <button class="btn btn-danger" onclick="clearPartnerPrice('${partnerId}')">Í∞ÄÍ≤© ÏÇ≠Ï†ú</button>
                </div>
            `;
            
            container.innerHTML = calendarHTML;
        }
        
        // Í±∞ÎûòÏ≤ò Îã¨Î†• ÎÇ†Ïßú ÏÑ†ÌÉù
        function selectPartnerCalendarDate(partnerId, dateKey, element) {
            // Ïù¥Ï†Ñ ÏÑ†ÌÉù Ï†úÍ±∞
            const container = element.closest('.partner-calendar');
            container.querySelectorAll('.partner-calendar-cell.selected').forEach(cell => {
                cell.classList.remove('selected');
            });
            
            // ÏÉà ÏÑ†ÌÉù Ï∂îÍ∞Ä
            element.classList.add('selected');
            
            // Í∞ÄÍ≤© ÏûÖÎ†• ÏÑπÏÖò ÌëúÏãú
            const priceInputSection = document.getElementById(`partnerPriceInput_${partnerId}`);
            const selectedDateSpan = document.getElementById(`selectedPartnerDate_${partnerId}`);
            const priceInput = document.getElementById(`partnerPrice_${partnerId}`);
            const priceNoteInput = document.getElementById(`partnerPriceNote_${partnerId}`);
            
            const [year, month, day] = dateKey.split('-');
            const selectedDate = new Date(year, month - 1, day);
            selectedDateSpan.textContent = formatDate(selectedDate);
            priceInputSection.style.display = 'block';
            
            // Í∏∞Ï°¥ Í∞ÄÍ≤© Ï†ïÎ≥¥ Î°úÎìú
            const priceKey = `${partnerId}_${dateKey}`;
            const priceInfo = partnerPrices[priceKey];
            if (priceInfo) {
                priceInput.value = priceInfo.price;
                priceNoteInput.value = priceInfo.note || '';
            } else {
                priceInput.value = '';
                priceNoteInput.value = '';
            }
            
            // ÏÑ†ÌÉùÌïú Í∞ÄÍ≤©ÏùÑ Îã®Í∞Ä ÌïÑÎìúÏóê ÏûêÎèô ÏûÖÎ†•
            if (priceInfo && document.getElementById('orderPrice')) {
                document.getElementById('orderPrice').value = priceInfo.price;
                calculateOrderTotal(); // Ï¥ùÏï° Ïû¨Í≥ÑÏÇ∞
            }
        }
        
        // Í±∞ÎûòÏ≤òÎ≥Ñ Í∞ÄÍ≤© ÏÑ§Ï†ï
        function setPartnerPrice(partnerId) {
            const selectedCell = document.querySelector('.partner-calendar-cell.selected');
            if (!selectedCell) {
                alert('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const dateKey = selectedCell.onclick.toString().match(/'([^']+)'/g)[1].replace(/'/g, '');
            const price = parseFloat(document.getElementById(`partnerPrice_${partnerId}`).value);
            const note = document.getElementById(`partnerPriceNote_${partnerId}`).value.trim();
            
            if (!price || price <= 0) {
                alert('Ïò¨Î∞îÎ•∏ Îã®Í∞ÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const priceKey = `${partnerId}_${dateKey}`;
            partnerPrices[priceKey] = {
                price: price,
                note: note,
                updatedAt: new Date().toISOString()
            };
            
            saveData();
            showPartnerCalendar('order'); // Îã¨Î†• Ïû¨Î†åÎçîÎßÅ
            alert('Í∞ÄÍ≤©Ïù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§.');
        }
        
        // Í±∞ÎûòÏ≤òÎ≥Ñ Í∞ÄÍ≤© ÏÇ≠Ï†ú
        function clearPartnerPrice(partnerId) {
            const selectedCell = document.querySelector('.partner-calendar-cell.selected');
            if (!selectedCell) {
                alert('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const dateKey = selectedCell.onclick.toString().match(/'([^']+)'/g)[1].replace(/'/g, '');
            const priceKey = `${partnerId}_${dateKey}`;
            
            if (!partnerPrices[priceKey]) {
                alert('ÏÑ§Ï†ïÎêú Í∞ÄÍ≤©Ïù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            if (confirm('Ïù¥ ÎÇ†ÏßúÏùò Í∞ÄÍ≤© Ï†ïÎ≥¥Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                delete partnerPrices[priceKey];
                saveData();
                showPartnerCalendar('order'); // Îã¨Î†• Ïû¨Î†åÎçîÎßÅ
                alert('Í∞ÄÍ≤©Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            }
        }

        // ÏÑ†Ï£ºÎ¨∏ Ï∂îÍ∞Ä
        function addOrder() {
            console.log('addOrder Ìï®Ïàò Ìò∏Ï∂úÎê®');
            
            const partnerId = document.getElementById('orderPartner').value;
            const orderDate = document.getElementById('orderDate').value;
            const quantity = parseFloat(document.getElementById('orderQuantity').value);
            const price = parseFloat(document.getElementById('orderPrice').value);
            const memo = document.getElementById('orderMemo').value.trim();
            
            console.log('ÏûÖÎ†•Í∞í:', {partnerId, orderDate, quantity, price, memo});
            
            if (!partnerId) {
                alert('Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!orderDate) {
                alert('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!quantity || quantity <= 0) {
                alert('Ïò¨Î∞îÎ•∏ ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!price || price <= 0) {
                alert('Ïò¨Î∞îÎ•∏ Îã®Í∞ÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const order = {
                id: generateId(),
                partnerId: partnerId,
                orderDate: orderDate,
                quantity: quantity,
                price: price,
                totalAmount: quantity * price,
                memo: memo,
                createdAt: new Date().toISOString()
            };
            
            orders.push(order);
            saveData();
            
            // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            document.getElementById('orderPartner').value = '';
            document.getElementById('orderQuantity').value = '';
            document.getElementById('orderPrice').value = '';
            document.getElementById('orderTotal').value = '';
            document.getElementById('orderMemo').value = '';
            document.getElementById('orderPartnerCalendar').style.display = 'none';
            
            updateOrdersList();
            updateDashboard();
            alert('ÏÑ†Ï£ºÎ¨∏Ïù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
        }
        
        // ÏÑ†Ï£ºÎ¨∏ ÏÇ≠Ï†ú
        function deleteOrder(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;
            
            const partner = partners.find(p => p.id === order.partnerId);
            const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
            
            if (!confirm(`${partnerName}Ïùò ÏÑ†Ï£ºÎ¨∏ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏàòÎüâ: ${formatNumber(order.quantity)}kg\nÏ¥ùÏï°: ${formatNumber(order.totalAmount)}Ïõê`)) {
                return;
            }
            
            orders = orders.filter(o => o.id !== id);
            saveData();
            updateOrdersList();
            alert('ÏÑ†Ï£ºÎ¨∏Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        }
        // Ïô∏ÏÉÅ Ï∂îÍ∞Ä
        function addAdvance() {
            console.log('addAdvance Ìï®Ïàò Ìò∏Ï∂úÎê®');
            
            const partnerId = document.getElementById('advancePartner').value;
            const advanceDate = document.getElementById('advanceDate').value;
            const amount = parseFloat(document.getElementById('advanceAmount').value);
            const memo = document.getElementById('advanceMemo').value.trim();
            const hidden = document.getElementById('advanceHidden').checked;
            
            console.log('ÏûÖÎ†•Í∞í:', {partnerId, advanceDate, amount, memo, hidden});
            
            if (!partnerId) {
                alert('Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!advanceDate) {
                alert('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('Ïò¨Î∞îÎ•∏ Ïô∏ÏÉÅÍ∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const advance = {
                id: generateId(),
                partnerId: partnerId,
                advanceDate: advanceDate,
                amount: amount,
                memo: memo,
                hidden: hidden,
                createdAt: new Date().toISOString()
            };
            
            advances.push(advance);
            saveData();
            
            // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            document.getElementById('advancePartner').value = '';
            document.getElementById('advanceAmount').value = '';
            document.getElementById('advanceMemo').value = '';
            document.getElementById('advanceHidden').checked = false;
            
            updateAdvancesList();
            updateDashboard(); // ÎåÄÏãúÎ≥¥ÎìúÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
            alert('Ïô∏ÏÉÅÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
        }
        
        // Ïô∏ÏÉÅ ÌëúÏãú/Ïà®ÍπÄ ÌÜ†Í∏Ä
        function toggleAdvanceVisibility(id) {
            const advance = advances.find(a => a.id === id);
            if (!advance) return;
            
            advance.hidden = !advance.hidden;
            saveData();
            updateAdvancesList();
            updateDashboard(); // ÎåÄÏãúÎ≥¥ÎìúÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
            
            const status = advance.hidden ? 'Ïà®ÍπÄ' : 'ÌëúÏãú';
            alert(`Ïô∏ÏÉÅÏù¥ ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú ${status} Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§.`);
        }
        
        // Ïô∏ÏÉÅ ÏÇ≠Ï†ú
        function deleteAdvance(id) {
            const advance = advances.find(a => a.id === id);
            if (!advance) return;
            
            const partner = partners.find(p => p.id === advance.partnerId);
            const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
            
            if (!confirm(`${partnerName}Ïùò Ïô∏ÏÉÅÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏô∏ÏÉÅÍ∏àÏï°: ${formatNumber(advance.amount)}Ïõê`)) {
                return;
            }
            
            advances = advances.filter(a => a.id !== id);
            saveData();
            updateAdvancesList();
            alert('Ïô∏ÏÉÅÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        }
        // ÏûÖÍ∏à Ï∂îÍ∞Ä
        function addPayment() {
            console.log('addPayment Ìï®Ïàò Ìò∏Ï∂úÎê®');
            
            const partnerId = document.getElementById('paymentPartner').value;
            const paymentDate = document.getElementById('paymentDate').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const memo = document.getElementById('paymentMemo').value.trim();
            
            console.log('ÏûÖÎ†•Í∞í:', {partnerId, paymentDate, amount, memo});
            
            if (!partnerId) {
                alert('Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!paymentDate) {
                alert('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('Ïò¨Î∞îÎ•∏ ÏûÖÍ∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const payment = {
                id: generateId(),
                partnerId: partnerId,
                paymentDate: paymentDate,
                amount: amount,
                memo: memo,
                createdAt: new Date().toISOString()
            };
            
            payments.push(payment);
            saveData();
            
            // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            document.getElementById('paymentPartner').value = '';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentMemo').value = '';
            document.getElementById('paymentPartnerInfo').style.display = 'none';
            
            updatePaymentsList();
            updateDashboard();
            alert('ÏûÖÍ∏àÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
        }
        
        // ÏûÖÍ∏à ÏÇ≠Ï†ú
        function deletePayment(id) {
            const payment = payments.find(p => p.id === id);
            if (!payment) return;
            
            const partner = partners.find(p => p.id === payment.partnerId);
            const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
            
            if (!confirm(`${partnerName}Ïùò ÏûÖÍ∏àÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏûÖÍ∏àÏï°: ${formatNumber(payment.amount)}Ïõê`)) {
                return;
            }
            
            payments = payments.filter(p => p.id !== id);
            saveData();
            updatePaymentsList();
            alert('ÏûÖÍ∏àÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        }
        
        // ÏûÖÍ≥† Ï∂îÍ∞Ä
        function addReceipt() {
            console.log('addReceipt Ìï®Ïàò Ìò∏Ï∂úÎê®');
            
            const partnerId = document.getElementById('receiptPartner').value;
            const receiptDate = document.getElementById('receiptDate').value;
            const quantity = parseFloat(document.getElementById('receiptQuantity').value);
            const memo = document.getElementById('receiptMemo').value.trim();
            
            console.log('ÏûÖÎ†•Í∞í:', {partnerId, receiptDate, quantity, memo});
            
            if (!partnerId) {
                alert('Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!receiptDate) {
                alert('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!quantity || quantity <= 0) {
                alert('Ïò¨Î∞îÎ•∏ ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const receipt = {
                id: generateId(),
                partnerId: partnerId,
                receiptDate: receiptDate,
                quantity: quantity,
                memo: memo,
                createdAt: new Date().toISOString()
            };
            
            receipts.push(receipt);
            saveData();
            
            // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            document.getElementById('receiptPartner').value = '';
            document.getElementById('receiptQuantity').value = '';
            document.getElementById('receiptMemo').value = '';
            document.getElementById('receiptPartnerInfo').style.display = 'none';
            
            updateReceiptsList();
            updateDashboard();
            alert('ÏûÖÍ≥†Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
        }
        
        // ÏûÖÍ≥† ÏÇ≠Ï†ú
        function deleteReceipt(id) {
            const receipt = receipts.find(r => r.id === id);
            if (!receipt) return;
            
            const partner = partners.find(p => p.id === receipt.partnerId);
            const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
            
            if (!confirm(`${partnerName}Ïùò ÏûÖÍ≥†Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏàòÎüâ: ${formatNumber(receipt.quantity)}kg`)) {
                return;
            }
            
            receipts = receipts.filter(r => r.id !== id);
            saveData();
            updateReceiptsList();
            alert('ÏûÖÍ≥†Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        }
        
        // Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞
        function exportData() {
            const selectedPartnerId = document.getElementById('historyFilter').value;
            const selectedPartnerName = selectedPartnerId ? 
                partners.find(p => p.id === selectedPartnerId)?.name || 'Ïïå Ïàò ÏóÜÏùå' : 'Ï†ÑÏ≤¥';
            
            let csvContent = "Í±∞ÎûòÏ≤ò,Í±∞ÎûòÏú†Ìòï,Í∏àÏï°,ÏàòÎüâ,Îã®Í∞Ä,Î©îÎ™®,Îì±Î°ùÏùº\n";
            
            // ÏÑ†Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞
            orders.forEach(order => {
                if (!selectedPartnerId || order.partnerId === selectedPartnerId) {
                    const partner = partners.find(p => p.id === order.partnerId);
                    const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                    csvContent += `"${partnerName}","ÏÑ†Ï£ºÎ¨∏","${order.totalAmount}","${order.quantity}","${order.price}","${order.memo || ''}","${formatDate(order.createdAt)}"\n`;
                }
            });
            
            // Ïô∏ÏÉÅ Îç∞Ïù¥ÌÑ∞
            advances.forEach(advance => {
                if (!selectedPartnerId || advance.partnerId === selectedPartnerId) {
                    const partner = partners.find(p => p.id === advance.partnerId);
                    const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                    const hiddenStatus = advance.hidden ? ' (Ïà®ÍπÄ)' : '';
                    csvContent += `"${partnerName}","Ïô∏ÏÉÅ${hiddenStatus}","${advance.amount}","","","${advance.memo || ''}","${formatDate(advance.createdAt)}"\n`;
                }
            });
            
            // ÏûÖÍ∏à Îç∞Ïù¥ÌÑ∞
            payments.forEach(payment => {
                if (!selectedPartnerId || payment.partnerId === selectedPartnerId) {
                    const partner = partners.find(p => p.id === payment.partnerId);
                    const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                    csvContent += `"${partnerName}","ÏûÖÍ∏à","${payment.amount}","","","${payment.memo || ''}","${formatDate(payment.createdAt)}"\n`;
                }
            });
            
            // ÏûÖÍ≥† Îç∞Ïù¥ÌÑ∞
            receipts.forEach(receipt => {
                if (!selectedPartnerId || receipt.partnerId === selectedPartnerId) {
                    const partner = partners.find(p => p.id === receipt.partnerId);
                    const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                    csvContent += `"${partnerName}","ÏûÖÍ≥†","","${receipt.quantity}","","${receipt.memo || ''}","${formatDate(receipt.createdAt)}"\n`;
                }
            });
            
            // ÌååÏùº Îã§Ïö¥Î°úÎìú
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Ïû•Ïñ¥Í±∞ÎûòÎÇ¥Ïó≠_${selectedPartnerName}_${new Date().toISOString().substr(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`${selectedPartnerName} Í±∞ÎûòÎÇ¥Ïó≠Ïù¥ CSV ÌååÏùºÎ°ú ÎÇ¥Î≥¥ÎÇ¥Ï°åÏäµÎãàÎã§.`);
        }

        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú Ïò§Îäò Îã®Í∞Ä Ï†ÄÏû•
        function setDashboardPrice(partnerId) {
            const priceInput = document.getElementById(`dashboardPrice_${partnerId}`);
            const price = parseFloat(priceInput.value);
            
            if (!price || price <= 0) {
                alert('Ïò¨Î∞îÎ•∏ Îã®Í∞ÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const today = new Date();
            const dateKey = formatDateKey(today);
            const priceKey = `${partnerId}_${dateKey}`;
            
            partnerPrices[priceKey] = {
                price: price,
                note: 'ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú ÏûÖÎ†•',
                updatedAt: new Date().toISOString()
            };
            
            saveData();
            priceInput.value = '';
            
            // Îã¨Î†•Ïù¥ Ïó¥Î†§ÏûàÎã§Î©¥ ÏÉàÎ°úÍ≥†Ïπ®
            const calendar = document.getElementById(`dashboardCalendar_${partnerId}`);
            if (calendar && calendar.style.display === 'block') {
                renderDashboardCalendar(partnerId);
            }
            
            // ÎåÄÏãúÎ≥¥Îìú Ï†ÑÏ≤¥ ÏÉàÎ°úÍ≥†Ïπ®
            updateDashboard();
            alert('Ïò§Îäò Îã®Í∞ÄÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
        }

        // ÎåÄÏãúÎ≥¥Îìú Îã¨Î†• ÌÜ†Í∏Ä
        function toggleDashboardCalendar(partnerId) {
            const calendar = document.getElementById(`dashboardCalendar_${partnerId}`);
            
            if (calendar.style.display === 'none') {
                renderDashboardCalendar(partnerId);
                calendar.style.display = 'block';
            } else {
                calendar.style.display = 'none';
            }
        }

        // ÎåÄÏãúÎ≥¥Îìú Îã¨Î†• Î†åÎçîÎßÅ
        function renderDashboardCalendar(partnerId) {
            const calendar = document.getElementById(`dashboardCalendar_${partnerId}`);
            if (!calendar) return;
            
            const partner = partners.find(p => p.id === partnerId);
            if (!partner) return;
            
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            
            let calendarHTML = `
                <div class="dashboard-calendar-header">
                    ${partner.name} - ${year}ÎÖÑ ${month + 1}Ïõî Îã®Í∞Ä ÌòÑÌô©
                </div>
                <div class="dashboard-calendar-grid">
            `;
            
            // ÏöîÏùº Ìó§Îçî
            const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
            days.forEach(day => {
                calendarHTML += `<div style="background: #f8fafc; padding: 4px; text-align: center; font-weight: 600; border: 1px solid #e5e7eb; font-size: 10px;">${day}</div>`;
            });
            
            // Îã¨Î†• ÎÇ†ÏßúÎì§
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + (week * 7) + day);
                    
                    const isCurrentMonth = cellDate.getMonth() === month;
                    const dateKey = formatDateKey(cellDate);
                    const priceKey = `${partnerId}_${dateKey}`;
                    const priceInfo = partnerPrices[priceKey];
                    
                    let cellClass = 'dashboard-calendar-cell';
                    if (!isCurrentMonth) cellClass += ' other-month';
                    if (priceInfo) cellClass += ' has-price';
                    
                    const priceBadge = priceInfo ? 
                        `<div class="dashboard-price-badge">${formatNumber(priceInfo.price)}Ïõê</div>` : '';
                    
                    calendarHTML += `
                        <div class="${cellClass}">
                            <div>${cellDate.getDate()}</div>
                            ${priceBadge}
                        </div>
                    `;
                }
            }
            
            calendarHTML += `</div>`;
            calendar.innerHTML = calendarHTML;
        }

        // Îπ†Î•∏ Îã®Í∞Ä Ï†ÄÏû• (ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú Í±∞ÎûòÏ≤ò Ïù¥Î¶Ñ ÏòÜ ÏûÖÎ†•)
        function setQuickPrice(partnerId) {
            const priceInput = document.getElementById(`quickPrice_${partnerId}`);
            const price = parseFloat(priceInput.value);
            
            if (!price || price <= 0) {
                alert('Ïò¨Î∞îÎ•∏ Îã®Í∞ÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const today = new Date();
            const dateKey = formatDateKey(today);
            const priceKey = `${partnerId}_${dateKey}`;
            
            partnerPrices[priceKey] = {
                price: price,
                note: 'ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú Îπ†Î•∏ ÏûÖÎ†•',
                updatedAt: new Date().toISOString()
            };
            
            saveData();
            priceInput.value = '';
            
            // Îã¨Î†• ÏÉàÎ°úÍ≥†Ïπ®
            renderQuickCalendar(partnerId);
            
            // ÎåÄÏãúÎ≥¥Îìú Ï†ÑÏ≤¥ ÏÉàÎ°úÍ≥†Ïπ® (ÏµúÍ∑º Îã®Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏)
            updateDashboard();
            alert('Ïò§Îäò Îã®Í∞ÄÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
        }

        // Îπ†Î•∏ Îã¨Î†• Î†åÎçîÎßÅ (Í±∞ÎûòÏ≤ò Ïù¥Î¶Ñ ÏïÑÎûò ÏûëÏùÄ Îã¨Î†•)
        function renderQuickCalendar(partnerId) {
            const calendar = document.getElementById(`quickCalendar_${partnerId}`);
            if (!calendar) return;
            
            const partner = partners.find(p => p.id === partnerId);
            if (!partner) return;
            
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            
            let calendarHTML = `
                <div class="dashboard-calendar-header">
                    ${partner.name} - ${year}ÎÖÑ ${month + 1}Ïõî
                </div>
                <div class="dashboard-calendar-grid">
            `;
            
            // ÏöîÏùº Ìó§Îçî
            const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
            days.forEach(day => {
                calendarHTML += `<div style="background: #f8fafc; padding: 3px; text-align: center; font-weight: 600; border: 1px solid #e5e7eb; font-size: 9px;">${day}</div>`;
            });
            
            // Îã¨Î†• ÎÇ†ÏßúÎì§
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + (week * 7) + day);
                    
                    const isCurrentMonth = cellDate.getMonth() === month;
                    const dateKey = formatDateKey(cellDate);
                    const priceKey = `${partnerId}_${dateKey}`;
                    const priceInfo = partnerPrices[priceKey];
                    
                    let cellClass = 'dashboard-calendar-cell';
                    if (!isCurrentMonth) cellClass += ' other-month';
                    if (priceInfo) cellClass += ' has-price';
                    
                    const priceBadge = priceInfo ? 
                        `<div class="dashboard-price-badge">${formatNumber(priceInfo.price)}</div>` : '';
                    
                    calendarHTML += `
                        <div class="${cellClass}" style="min-height: 25px; padding: 2px;">
                            <div style="font-size: 9px;">${cellDate.getDate()}</div>
                            ${priceBadge}
                        </div>
                    `;
                }
            }
            
            calendarHTML += `</div>`;
            calendar.innerHTML = calendarHTML;
        }

        // Îπ†Î•∏ Îã¨Î†• ÌÜ†Í∏Ä (Î≥¥Ïù¥Í∏∞/Ïà®Í∏∞Í∏∞)
        function toggleQuickCalendar(partnerId) {
            const calendar = document.getElementById(`quickCalendar_${partnerId}`);
            if (!calendar) return;
            
            if (calendar.style.display === 'none' || calendar.style.display === '') {
                calendar.style.display = 'block';
                // Îã¨Î†•Ïù¥ Î≥¥Ïùº Îïå Î†åÎçîÎßÅ
                setTimeout(() => renderQuickCalendar(partnerId), 10);
            } else {
                calendar.style.display = 'none';
            }
        }
    </script>
</body>
</html>