<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêç Ïû•Ïñ¥ Ï£ºÎ¨∏Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú (Í∞úÏÑ†Î≤ÑÏ†Ñ v2.1)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #e8f5e8 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        
        h1 {
            color: #1f2937;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .nav-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            margin-right: 10px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .nav-tab.active {
            background: #3b82f6;
            color: white;
        }
        
        .nav-tab:hover {
            background: #e5e7eb;
        }
        
        .nav-tab.active:hover {
            background: #2563eb;
        }
        
        .content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: #2563eb;
        }
        
        .btn-success {
            background: #10b981;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-warning {
            background: #f59e0b;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .grid {
            display: grid;
            gap: 20px;
        }
        
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .stats-card.red {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .stats-card.orange {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .stats-card.green {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .stats-card.purple {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 900;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            line-height: 1.1;
        }
        
        .detail-label {
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .stats-card .detail-label {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 8px;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .partner-card {
            border-left: 4px solid #3b82f6;
            margin-bottom: 15px;
        }
        
        .partner-card.warning {
            border-left-color: #f59e0b;
            background: #fefbf0;
        }
        
        .partner-card.completed {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        
        .partner-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .partner-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1f2937;
        }
        
        .partner-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            text-align: center;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
        }
        
        .detail-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .detail-value {
            font-weight: bold;
            color: #1f2937;
        }
        
        .hide {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-gray {
            color: #6b7280;
        }
        
        .text-red {
            color: #ef4444;
        }
        
        .text-orange {
            color: #f59e0b;
        }
        
        .text-green {
            color: #10b981;
        }
        
        .text-purple {
            color: #8b5cf6;
        }
        
        .delete-btn {
            background: #f3f4f6;
            color: #6b7280;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .delete-btn:hover {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .payment-breakdown {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.875rem;
        }
        
        .advance-indicator {
            background: #fef3c7;
            color: #d97706;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 5px;
        }
        
        /* Ïû•Ïñ¥Îã®Í∞Ä Îã¨Î†• Ïä§ÌÉÄÏùº */
        .price-calendar-container {
            position: relative;
            display: inline-block;
        }
        
        .price-calendar {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 300px;
            padding: 15px;
            display: none;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-nav-btn {
            background: #f3f4f6;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .calendar-nav-btn:hover {
            background: #e5e7eb;
        }
        
        .calendar-month-year {
            font-weight: bold;
            font-size: 16px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            color: #6b7280;
            padding: 8px 4px;
        }
        
        .calendar-day {
            text-align: center;
            padding: 8px 4px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            position: relative;
            min-height: 35px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .calendar-day:hover {
            background: #f3f4f6;
        }
        
        .calendar-day.other-month {
            color: #d1d5db;
        }
        
        .calendar-day.today {
            background: #3b82f6;
            color: white;
            font-weight: bold;
        }
        
        .calendar-day.selected {
            background: #10b981;
            color: white;
        }
        
        .calendar-day .day-price {
            font-size: 9px;
            color: #f59e0b;
            font-weight: bold;
            margin-top: 2px;
        }
        
        .calendar-day.today .day-price,
        .calendar-day.selected .day-price {
            color: #fef3c7;
        }
        
        .calendar-footer {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .calendar-price-input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .calendar-save-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .calendar-save-btn:hover {
            background: #2563eb;
        }
        
        .calendar-save-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .partner-info {
                flex-direction: column;
            }
            
            .partner-details {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .price-calendar {
                min-width: 280px;
                left: -50px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üêç Ïû•Ïñ¥ Ï£ºÎ¨∏Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú (Í∞úÏÑ†Î≤ÑÏ†Ñ)</h1>
            <p class="text-gray" id="currentDate"></p>
        </header>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard', this)">üìä ÎåÄÏãúÎ≥¥Îìú</button>
            <button class="nav-tab" onclick="showTab('partners', this)">üë• Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨</button>
            <button class="nav-tab" onclick="showTab('orders', this)">üì¶ ÏÑ†Ï£ºÎ¨∏ Í¥ÄÎ¶¨</button>
            <button class="nav-tab" onclick="showTab('advance', this)">üí≥ Ïô∏ÏÉÅ Í¥ÄÎ¶¨</button>
            <button class="nav-tab" onclick="showTab('payments', this)">üí∞ ÏûÖÍ∏à Í¥ÄÎ¶¨</button>
            <button class="nav-tab" onclick="showTab('receipts', this)">üì• ÏûÖÍ≥† Í¥ÄÎ¶¨</button>
            <button class="nav-tab" onclick="showTab('dataView', this)">üìã Í±∞ÎûòÎÇ¥Ïó≠ÌôïÏù∏</button>
        </div>
        
        <!-- ÎåÄÏãúÎ≥¥Îìú -->
        <div id="dashboard" class="content">
            <div class="grid grid-4" id="statsCards">
                <!-- ÌÜµÍ≥Ñ Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
            </div>
            
            <div class="grid grid-2" style="margin-top: 30px;">
                <div>
                    <h3 style="margin-bottom: 20px;">Í±∞ÎûòÏ≤ò ÌòÑÌô©</h3>
                    <div id="partnersList">
                        <!-- Î™®Îì† Í±∞ÎûòÏ≤òÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>
                <div>
                    <h3 style="margin-bottom: 20px;">Î©îÎ™® Î™©Î°ù</h3>
                    <div id="memoList">
                        <!-- ÏµúÍ∑º Î©îÎ™®Îì§Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨ -->
        <div id="partners" class="content hide">
            <h3 style="margin-bottom: 20px;" id="partnerFormTitle">Í±∞ÎûòÏ≤ò Îì±Î°ù</h3>
            <div class="grid grid-2">
                <div class="form-group">
                    <label>Í±∞ÎûòÏ≤òÎ™Ö</label>
                    <input type="text" id="partnerName" placeholder="Í±∞ÎûòÏ≤òÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                </div>
                <div class="form-group">
                    <label>Ïó∞ÎùΩÏ≤ò</label>
                    <input type="text" id="partnerContact" placeholder="Ïó∞ÎùΩÏ≤òÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                </div>
            </div>
            <input type="hidden" id="partnerEditId" value="">
            <div id="partnerFormButtons">
                <button class="btn btn-success" onclick="addPartner()">Í±∞ÎûòÏ≤ò Îì±Î°ù</button>
            </div>
            
            <h3 style="margin: 30px 0 20px 0;">Í±∞ÎûòÏ≤ò Î™©Î°ù</h3>
            <div id="partnersListManage">
                <!-- Í±∞ÎûòÏ≤ò Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
            </div>
            
            <div class="history-section">
                <h3 style="margin-bottom: 20px;">üìã Í±∞ÎûòÏ≤òÎ≥Ñ Ï†ÑÏ≤¥ ÎÇ¥Ïó≠</h3>
                <div class="history-filters">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Í±∞ÎûòÏ≤ò ÏÑ†ÌÉù</label>
                            <select id="historyPartnerSelect" onchange="loadPartnerHistory()">
                                <option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Í∏∞Í∞Ñ ÌïÑÌÑ∞</label>
                            <select id="historyPeriodFilter" onchange="loadPartnerHistory()">
                                <option value="all">Ï†ÑÏ≤¥ Í∏∞Í∞Ñ</option>
                                <option value="7">ÏµúÍ∑º 7Ïùº</option>
                                <option value="30">ÏµúÍ∑º 30Ïùº</option>
                                <option value="90">ÏµúÍ∑º 3Í∞úÏõî</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="partnerHistoryList">
                    <div class="no-history">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÎ©¥ Ï†ÑÏ≤¥ Í±∞Îûò ÎÇ¥Ïó≠Ïù¥ ÌëúÏãúÎê©ÎãàÎã§.</div>
                </div>
            </div>
        </div>
        
        <!-- ÏÑ†Ï£ºÎ¨∏ Í¥ÄÎ¶¨ -->
        <div id="orders" class="content hide">
            <h3 style="margin-bottom: 20px;">ÏÑ†Ï£ºÎ¨∏ Îì±Î°ù</h3>
            <div class="grid grid-2">
                <div class="form-group">
                    <label>Í±∞ÎûòÏ≤ò</label>
                    <select id="orderPartner">
                        <option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ï£ºÎ¨∏Ïùº</label>
                    <input type="date" id="orderDate">
                </div>
                <div class="form-group">
                    <label>ÏàòÎüâ (kg)</label>
                    <input type="number" id="orderQuantity" placeholder="ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" step="0.1">
                </div>
                <div class="form-group">
                    <label>Îã®Í∞Ä (Ïõê/kg)</label>
                    <input type="number" id="orderPrice" placeholder="Îã®Í∞ÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                </div>
            </div>
            <div class="form-group">
                <label>ÎπÑÍ≥†</label>
                <textarea id="orderMemo" placeholder="Î©îÎ™®ÎÇò ÌäπÏù¥ÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" style="height: 80px;"></textarea>
            </div>
            <div id="orderTotalAmount" style="margin: 10px 0; font-weight: bold; color: #3b82f6;"></div>
            <button class="btn btn-success" onclick="addOrder()">ÏÑ†Ï£ºÎ¨∏ Îì±Î°ù</button>
            
            <div class="history-section">
                <h3 style="margin-bottom: 20px;">üìã ÏÑ†Ï£ºÎ¨∏ ÎÇ¥Ïó≠</h3>
                <div class="history-filters">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Í±∞ÎûòÏ≤ò ÌïÑÌÑ∞</label>
                            <select id="orderHistoryPartner" onchange="loadOrderHistory()">
                                <option value="">Ï†ÑÏ≤¥ Í±∞ÎûòÏ≤ò</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Í∏∞Í∞Ñ ÌïÑÌÑ∞</label>
                            <select id="orderHistoryPeriod" onchange="loadOrderHistory()">
                                <option value="all">Ï†ÑÏ≤¥ Í∏∞Í∞Ñ</option>
                                <option value="7">ÏµúÍ∑º 7Ïùº</option>
                                <option value="30">ÏµúÍ∑º 30Ïùº</option>
                                <option value="90">ÏµúÍ∑º 3Í∞úÏõî</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="orderHistoryList">
                    <!-- ÏÑ†Ï£ºÎ¨∏ ÎÇ¥Ïó≠Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
            </div>
        </div>
        
        <!-- Ïô∏ÏÉÅ Í¥ÄÎ¶¨ -->
        <div id="advance" class="content hide">
            <h3 style="margin-bottom: 20px;">Ïô∏ÏÉÅ Îì±Î°ù</h3>
            <div class="grid grid-2">
                <div class="form-group">
                    <label>Í±∞ÎûòÏ≤ò</label>
                    <select id="advancePartner">
                        <option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ïô∏ÏÉÅÏùº</label>
                    <input type="date" id="advanceDate">
                </div>
                <div class="form-group">
                    <label>ÏàòÎüâ (kg)</label>
                    <input type="number" id="advanceQuantity" placeholder="ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" step="0.1">
                </div>
                <div class="form-group">
                    <label>Îã®Í∞Ä (Ïõê/kg)</label>
                    <input type="number" id="advancePrice" placeholder="Îã®Í∞ÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                </div>
            </div>
            <div class="form-group">
                <label>ÎπÑÍ≥†</label>
                <textarea id="advanceMemo" placeholder="Î©îÎ™®ÎÇò ÌäπÏù¥ÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" style="height: 80px;"></textarea>
            </div>
            <div id="advanceTotalAmount" style="margin: 10px 0; font-weight: bold; color: #f59e0b;"></div>
            <button class="btn btn-warning" onclick="addAdvance()">Ïô∏ÏÉÅ Îì±Î°ù</button>
            
            <div class="history-section">
                <h3 style="margin-bottom: 20px;">üìã Ïô∏ÏÉÅ ÎÇ¥Ïó≠</h3>
                <div class="history-filters">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Í±∞ÎûòÏ≤ò ÌïÑÌÑ∞</label>
                            <select id="advanceHistoryPartner" onchange="loadAdvanceHistory()">
                                <option value="">Ï†ÑÏ≤¥ Í±∞ÎûòÏ≤ò</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Í∏∞Í∞Ñ ÌïÑÌÑ∞</label>
                            <select id="advanceHistoryPeriod" onchange="loadAdvanceHistory()">
                                <option value="all">Ï†ÑÏ≤¥ Í∏∞Í∞Ñ</option>
                                <option value="7">ÏµúÍ∑º 7Ïùº</option>
                                <option value="30">ÏµúÍ∑º 30Ïùº</option>
                                <option value="90">ÏµúÍ∑º 3Í∞úÏõî</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="advanceHistoryList">
                    <!-- Ïô∏ÏÉÅ ÎÇ¥Ïó≠Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
            </div>
        </div>
        
        <!-- ÏûÖÍ∏à Í¥ÄÎ¶¨ -->
        <div id="payments" class="content hide">
            <h3 style="margin-bottom: 20px;">ÏûÖÍ∏à Îì±Î°ù</h3>
            <div class="grid grid-2">
                <div class="form-group">
                    <label>Í±∞ÎûòÏ≤ò</label>
                    <select id="paymentPartner" onchange="updatePaymentInfo()">
                        <option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÏûÖÍ∏àÏùº</label>
                    <input type="date" id="paymentDate">
                </div>
                <div class="form-group">
                    <label>ÏûÖÍ∏à Ïú†Ìòï</label>
                    <select id="paymentType" onchange="updatePaymentTypeInfo()">
                        <option value="auto">ÏûêÎèô Ï†ïÏÇ∞ (Ïô∏ÏÉÅ Ïö∞ÏÑ†)</option>
                        <option value="advance">Ïô∏ÏÉÅÎßå Ï†ïÏÇ∞</option>
                        <option value="order">ÏÑ†Ï£ºÎ¨∏Îßå Ï†ïÏÇ∞</option>
                        <option value="custom">ÏßÅÏ†ë ÏßÄÏ†ï</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÏûÖÍ∏àÏï° (Ïõê)</label>
                    <input type="number" id="paymentAmount" placeholder="ÏûÖÍ∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" onchange="calculatePaymentBreakdown()">
                </div>
            </div>
            <div id="customPaymentAllocation" class="grid grid-2" style="display: none; margin-top: 20px;">
                <div class="form-group">
                    <label>Ïô∏ÏÉÅ Ï†ïÏÇ∞Ïï° (Ïõê)</label>
                    <input type="number" id="customAdvanceAmount" placeholder="Ïô∏ÏÉÅ Ï†ïÏÇ∞Ïï°" onchange="updateCustomTotal()">
                    <small id="maxAdvanceInfo" class="text-gray"></small>
                </div>
                <div class="form-group">
                    <label>ÏÑ†Ï£ºÎ¨∏ Ï†ïÏÇ∞Ïï° (Ïõê)</label>
                    <input type="number" id="customOrderAmount" placeholder="ÏÑ†Ï£ºÎ¨∏ Ï†ïÏÇ∞Ïï°" onchange="updateCustomTotal()">
                    <small id="maxOrderInfo" class="text-gray"></small>
                </div>
            </div>
            <div class="form-group">
                <label>ÎπÑÍ≥†</label>
                <textarea id="paymentMemo" placeholder="ÏûÖÍ∏à Í¥ÄÎ†® Î©îÎ™®ÎÇò ÌäπÏù¥ÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" style="height: 80px;"></textarea>
            </div>
            <div id="paymentInfo" class="payment-breakdown" style="display: none;">
                <!-- ÏûÖÍ∏à Ï†ïÏÇ∞ ÎÇ¥Ïó≠Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
            </div>
            <button class="btn btn-success" onclick="addPayment()">ÏûÖÍ∏à Îì±Î°ù</button>
            
            <div class="history-section">
                <h3 style="margin-bottom: 20px;">üìã ÏûÖÍ∏à ÎÇ¥Ïó≠</h3>
                <div class="history-filters">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Í±∞ÎûòÏ≤ò ÌïÑÌÑ∞</label>
                            <select id="paymentHistoryPartner" onchange="loadPaymentHistory()">
                                <option value="">Ï†ÑÏ≤¥ Í±∞ÎûòÏ≤ò</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Í∏∞Í∞Ñ ÌïÑÌÑ∞</label>
                            <select id="paymentHistoryPeriod" onchange="loadPaymentHistory()">
                                <option value="all">Ï†ÑÏ≤¥ Í∏∞Í∞Ñ</option>
                                <option value="7">ÏµúÍ∑º 7Ïùº</option>
                                <option value="30">ÏµúÍ∑º 30Ïùº</option>
                                <option value="90">ÏµúÍ∑º 3Í∞úÏõî</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="paymentHistoryList">
                    <!-- ÏûÖÍ∏à ÎÇ¥Ïó≠Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
            </div>
        </div>
        
        <!-- ÏûÖÍ≥† Í¥ÄÎ¶¨ -->
        <div id="receipts" class="content hide">
            <h3 style="margin-bottom: 20px;">ÏûÖÍ≥† Îì±Î°ù</h3>
            <div class="grid grid-2">
                <div class="form-group">
                    <label>Í±∞ÎûòÏ≤ò</label>
                    <select id="receiptPartner">
                        <option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÏûÖÍ≥†Ïùº</label>
                    <input type="date" id="receiptDate">
                </div>
                <div class="form-group">
                    <label>ÏûÖÍ≥†Îüâ (kg)</label>
                    <input type="number" id="receiptQuantity" placeholder="ÏûÖÍ≥†ÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" step="0.1">
                </div>
            </div>
            <div class="form-group">
                <label>ÎπÑÍ≥†</label>
                <textarea id="receiptMemo" placeholder="ÏûÖÍ≥† Í¥ÄÎ†® Î©îÎ™®ÎÇò ÌäπÏù¥ÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" style="height: 80px;"></textarea>
            </div>
            <button class="btn btn-success" onclick="addReceipt()">ÏûÖÍ≥† Îì±Î°ù</button>
            
            <div class="history-section">
                <h3 style="margin-bottom: 20px;">üìã ÏûÖÍ≥† ÎÇ¥Ïó≠</h3>
                <div class="history-filters">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Í±∞ÎûòÏ≤ò ÌïÑÌÑ∞</label>
                            <select id="receiptHistoryPartner" onchange="loadReceiptHistory()">
                                <option value="">Ï†ÑÏ≤¥ Í±∞ÎûòÏ≤ò</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Í∏∞Í∞Ñ ÌïÑÌÑ∞</label>
                            <select id="receiptHistoryPeriod" onchange="loadReceiptHistory()">
                                <option value="all">Ï†ÑÏ≤¥ Í∏∞Í∞Ñ</option>
                                <option value="7">ÏµúÍ∑º 7Ïùº</option>
                                <option value="30">ÏµúÍ∑º 30Ïùº</option>
                                <option value="90">ÏµúÍ∑º 3Í∞úÏõî</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="receiptHistoryList">
                    <!-- ÏûÖÍ≥† ÎÇ¥Ïó≠Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
            </div>
        </div>

        <!-- Ï†ÄÏû•Îêú Ï†ïÎ≥¥ ÌôïÏù∏ -->
        <div id="dataView" class="content hide">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">üìã Í±∞ÎûòÎÇ¥Ïó≠ÌôïÏù∏</h3>
                <div>
                    <button class="btn btn-success" onclick="exportFilteredData()" style="padding: 8px 16px; font-size: 14px;">üìÑ Ï∂úÎ†•</button>
                </div>
            </div>

            <!-- ÌïÑÌÑ∞ ÏÑπÏÖò -->
            <div class="card" style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 15px;">üîç Îç∞Ïù¥ÌÑ∞ ÌïÑÌÑ∞</h4>
                <div class="grid grid-4">
                    <div class="form-group">
                        <label>Îç∞Ïù¥ÌÑ∞ Ïú†Ìòï</label>
                        <select id="dataTypeFilter" onchange="filterData()">
                            <option value="all">Ï†ÑÏ≤¥</option>
                            <option value="partners">Í±∞ÎûòÏ≤ò</option>
                            <option value="orders">ÏÑ†Ï£ºÎ¨∏</option>
                            <option value="advances">Ïô∏ÏÉÅ</option>
                            <option value="payments">ÏûÖÍ∏à</option>
                            <option value="receipts">ÏûÖÍ≥†</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Í±∞ÎûòÏ≤ò ÌïÑÌÑ∞</label>
                        <select id="dataPartnerFilter" onchange="filterData()">
                            <option value="">Ï†ÑÏ≤¥ Í±∞ÎûòÏ≤ò</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ÏãúÏûë ÎÇ†Ïßú</label>
                        <input type="date" id="dataStartDate" onchange="filterData()">
                    </div>
                    <div class="form-group">
                        <label>Ï¢ÖÎ£å ÎÇ†Ïßú</label>
                        <input type="date" id="dataEndDate" onchange="filterData()">
                    </div>
                </div>
            </div>

            <!-- Îç∞Ïù¥ÌÑ∞ ÌëúÏãú ÏÑπÏÖò -->
            <div id="dataViewContainer">
                <!-- ÌïÑÌÑ∞Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
            </div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàòÎì§
        let partners = [];        // Í±∞ÎûòÏ≤ò Î™©Î°ù
        let orders = [];         // ÏÑ†Ï£ºÎ¨∏ Î™©Î°ù
        let advances = [];       // Ïô∏ÏÉÅ Î™©Î°ù
        let payments = [];       // ÏûÖÍ∏à Î™©Î°ù
        let receipts = [];       // ÏûÖÍ≥† Î™©Î°ù
        let partnerStatus = new Map(); // Í±∞ÎûòÏ≤òÎ≥Ñ ÏÉÅÌÉú (ÏÑ†Ï£ºÎ¨∏ Ï§ÑÎèà, Ïô∏ÏÉÅ Ï§ÑÎèà, Î∞õÏùÑÏû•Ïñ¥)

        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            // Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            loadData();
            
            updateCurrentDate();
            setTodayDates();
            updateAllSelects();
            setupCalculators();
            
            // ÎåÄÏãúÎ≥¥ÎìúÎ•º Ïó¨Îü¨ Î≤à ÏóÖÎç∞Ïù¥Ìä∏
            updateDashboard();
            setTimeout(() => {
                updateDashboard();
            }, 100);
            setTimeout(() => {
                updateDashboard();
            }, 500);
        });

        // ÌòÑÏû¨ ÎÇ†Ïßú ÌëúÏãú
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('ko-KR', options);
        }

        // Ïò§Îäò ÎÇ†ÏßúÎ°ú ÏÑ§Ï†ï (ÌïúÍµ≠ÏãúÍ∞Ñ Í∏∞Ï§Ä)
        function setTodayDates() {
            const today = new Date();
            // ÌïúÍµ≠ÏãúÍ∞ÑÏúºÎ°ú Î≥ÄÌôò (UTC+9)
            const kstOffset = 9 * 60; // 9ÏãúÍ∞ÑÏùÑ Î∂ÑÏúºÎ°ú Î≥ÄÌôò
            const kstTime = new Date(today.getTime() + (kstOffset * 60 * 1000));
            const todayKST = kstTime.toISOString().split('T')[0];
            
            document.getElementById('orderDate').value = todayKST;
            document.getElementById('advanceDate').value = todayKST;
            document.getElementById('paymentDate').value = todayKST;
            document.getElementById('receiptDate').value = todayKST;
        }

        // Í≥ÑÏÇ∞Í∏∞ ÏÑ§Ï†ï
        function setupCalculators() {
            ['orderQuantity', 'orderPrice'].forEach(id => {
                document.getElementById(id).addEventListener('input', calculateOrderTotal);
            });
            ['advanceQuantity', 'advancePrice'].forEach(id => {
                document.getElementById(id).addEventListener('input', calculateAdvanceTotal);
            });
        }

        // ÏÑ†Ï£ºÎ¨∏ Ï¥ùÏï° Í≥ÑÏÇ∞
        function calculateOrderTotal() {
            const quantity = parseFloat(document.getElementById('orderQuantity').value) || 0;
            const price = parseFloat(document.getElementById('orderPrice').value) || 0;
            const total = quantity * price;
            
            const totalElement = document.getElementById('orderTotalAmount');
            if (total > 0) {
                totalElement.textContent = `Ï¥ù Í∏àÏï°: ${formatCurrency(total)}`;
            } else {
                totalElement.textContent = '';
            }
        }

        // Ïô∏ÏÉÅ Ï¥ùÏï° Í≥ÑÏÇ∞
        function calculateAdvanceTotal() {
            const quantity = parseFloat(document.getElementById('advanceQuantity').value) || 0;
            const price = parseFloat(document.getElementById('advancePrice').value) || 0;
            const total = quantity * price;
            
            const totalElement = document.getElementById('advanceTotalAmount');
            if (total > 0) {
                totalElement.textContent = `Ï¥ù Í∏àÏï°: ${formatCurrency(total)}`;
            } else {
                totalElement.textContent = '';
            }
        }

        // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        function loadData() {
            try {
                const savedData = localStorage.getItem('eelOrderDataV2');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    partners = data.partners || [];
                    orders = data.orders || [];
                    advances = data.advances || [];
                    payments = data.payments || [];
                    receipts = data.receipts || [];
                    
                    // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
                    if (data.partnerStatus) {
                        partnerStatus = new Map(Object.entries(data.partnerStatus));
                    } else {
                        calculatePartnerStatus();
                    }
                } else {
                    // Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞Î°ú ÏÑ§Ï†ï
                    initializeData();
                }
            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
                initializeData();
            }
        }

        // Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî (Ïä§ÌÅ¨Î¶∞ÏÉ∑ Îç∞Ïù¥ÌÑ∞ Ìè¨Ìï®)
        function initializeData() {
            partners = [
                {
                    id: 'partner_seungduyeong',
                    name: 'ÏäπÎëêÏòÅ',
                    phone: '',
                    address: '',
                    createdAt: '2025-08-29T09:00:00.000Z'
                },
                {
                    id: 'partner_hwangsil',
                    name: 'Ìô©Ïã§Î∂ÑÏ†ê',
                    phone: '',
                    address: '',
                    createdAt: '2025-08-23T09:00:00.000Z'
                }
            ];
            
            orders = [
                {
                    id: 'order_seungduyeong_001',
                    partnerId: 'partner_seungduyeong',
                    partnerName: 'ÏäπÎëêÏòÅ',
                    quantity: 150,
                    pricePerKg: 28000,
                    totalAmount: 4200000,
                    date: '2025-08-29',
                    memo: 'Ïò§Îäò 30ÌÇ§Î°ú ÎÇ¥Í∞Ä Î∞õÏïÑÏÑú 150 ÌÇ§Î°úÎÇ®Ïùå',
                    status: 'pending'
                }
            ];
            
            advances = [
                {
                    id: 'advance_hwangsil_001',
                    partnerId: 'partner_hwangsil',
                    partnerName: 'Ìô©Ïã§Î∂ÑÏ†ê',
                    quantity: 0,
                    pricePerKg: 0,
                    totalAmount: 8702500,
                    date: '2025-08-23',
                    memo: 'Ïô∏ÏÉÅÏúºÎ°ú Í∏àÏï° ÎßûÎìúÎùº ÏàòÏ†ïÌïúÍ±∞ÏûÑ Ïô∏ÏÉÅ 8702500 Ïù¥Îû¨Ïùå',
                    status: 'pending'
                }
            ];
            
            payments = [];
            receipts = [];
            
            // Í±∞ÎûòÏ≤ò ÏÉÅÌÉú Í≥ÑÏÇ∞
            partnerStatus = new Map();
            partnerStatus.set('partner_seungduyeong', {
                pending_payment_order: 4600000,
                pending_payment_advance: 0,
                pending_eel_kg: 150
            });
            partnerStatus.set('partner_hwangsil', {
                pending_payment_order: 0,
                pending_payment_advance: 8702500,
                pending_eel_kg: 0
            });
            
            // Í∞ÄÍ≤© Ï†ïÎ≥¥ Ï†ÄÏû•
            localStorage.setItem('partnerPrice_partner_seungduyeong', '28000');
            
            // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
            saveData();
            
            // Ï¶âÏãú ÎåÄÏãúÎ≥¥Îìú ÏóÖÎç∞Ïù¥Ìä∏
            updateDashboard();
        }

        // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        function saveData() {
            try {
                const data = { 
                    partners, 
                    orders, 
                    advances, 
                    payments, 
                    receipts,
                    partnerStatus: Object.fromEntries(partnerStatus)
                };
                localStorage.setItem('eelOrderDataV2', JSON.stringify(data));
            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïò§Î•ò:', error);
                alert('Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // Í±∞ÎûòÏ≤ò ÏÉÅÌÉú Í≥ÑÏÇ∞
        function calculatePartnerStatus() {
            partnerStatus.clear();
            
            partners.forEach(partner => {
                partnerStatus.set(partner.id, {
                    pending_payment_order: 0,    // ÏÑ†Ï£ºÎ¨∏ Ï§ÑÎèà
                    pending_payment_advance: 0,  // Ïô∏ÏÉÅ Ï§ÑÎèà
                    pending_eel_kg: 0            // Î∞õÏùÑÏû•Ïñ¥
                });
            });
            
            // ÏÑ†Ï£ºÎ¨∏ Ï≤òÎ¶¨
            orders.forEach(order => {
                const status = partnerStatus.get(order.partnerId);
                if (status) {
                    status.pending_payment_order += order.totalAmount;
                    status.pending_eel_kg += order.quantity;
                }
            });
            
            // Ïô∏ÏÉÅ Ï≤òÎ¶¨
            advances.forEach(advance => {
                const status = partnerStatus.get(advance.partnerId);
                if (status) {
                    status.pending_payment_advance += advance.totalAmount;
                    status.pending_eel_kg += advance.quantity;
                }
            });
            
            // ÏûÖÍ∏à Ï≤òÎ¶¨ (Ïã†Í∑ú Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÏÇ¨Ïö©)
            payments.forEach(payment => {
                const status = partnerStatus.get(payment.partnerId);
                if (status) {
                    // Ïã†Í∑ú ÏûÖÍ∏à Îç∞Ïù¥ÌÑ∞Ïóê Ï†ïÏÇ∞ Ï†ïÎ≥¥Í∞Ä ÏûàÏúºÎ©¥ ÏÇ¨Ïö©
                    if (payment.advancePayment !== undefined && payment.orderPayment !== undefined) {
                        status.pending_payment_advance -= payment.advancePayment;
                        status.pending_payment_order -= payment.orderPayment;
                    } else {
                        // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Îäî Í∏∞Ï°¥ Î∞©ÏãùÏúºÎ°ú Ï≤òÎ¶¨ (Ïô∏ÏÉÅ Ïö∞ÏÑ†)
                        let remainingAmount = payment.amount;
                        
                        // Ïô∏ÏÉÅ Ï§ÑÎèàÏóêÏÑú Î®ºÏ†Ä Ï∞®Í∞ê
                        if (status.pending_payment_advance > 0 && remainingAmount > 0) {
                            const advancePayment = Math.min(status.pending_payment_advance, remainingAmount);
                            status.pending_payment_advance -= advancePayment;
                            remainingAmount -= advancePayment;
                        }
                        
                        // ÎÇ®ÏùÄ Í∏àÏï°ÏùÑ ÏÑ†Ï£ºÎ¨∏ Ï§ÑÎèàÏóêÏÑú Ï∞®Í∞ê
                        if (status.pending_payment_order > 0 && remainingAmount > 0) {
                            const orderPayment = Math.min(status.pending_payment_order, remainingAmount);
                            status.pending_payment_order -= orderPayment;
                        }
                        
                        // ÏùåÏàò Î∞©ÏßÄ
                        if (status.pending_payment_advance < 0) status.pending_payment_advance = 0;
                        if (status.pending_payment_order < 0) status.pending_payment_order = 0;
                    }
                }
            });
            
            // ÏûÖÍ≥† Ï≤òÎ¶¨
            receipts.forEach(receipt => {
                const status = partnerStatus.get(receipt.partnerId);
                if (status) {
                    status.pending_eel_kg -= receipt.quantity;
                    // ÏùåÏàò Î∞©ÏßÄ
                    if (status.pending_eel_kg < 0) status.pending_eel_kg = 0;
                }
            });
        }

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ko-KR').format(amount) + 'Ïõê';
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ko-KR');
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // ÏûÖÎ†•Í∞í Í≤ÄÏ¶ù Ìï®Ïàò
        function validateNumericInput(value, fieldName, min = 0, max = Number.MAX_SAFE_INTEGER) {
            const numValue = parseFloat(value);
            if (isNaN(numValue)) {
                throw new Error(`${fieldName}ÏùÄ(Îäî) Ïú†Ìö®Ìïú Ïà´ÏûêÏó¨Ïïº Ìï©ÎãàÎã§.`);
            }
            if (numValue < min) {
                throw new Error(`${fieldName}ÏùÄ(Îäî) ${min} Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.`);
            }
            if (numValue > max) {
                throw new Error(`${fieldName}ÏùÄ(Îäî) ${max} Ïù¥ÌïòÏó¨Ïïº Ìï©ÎãàÎã§.`);
            }
            return numValue;
        }
        
        function validateStringInput(value, fieldName, maxLength = 255) {
            const trimmedValue = value.trim();
            if (!trimmedValue) {
                throw new Error(`${fieldName}ÏùÑ(Î•º) ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.`);
            }
            if (trimmedValue.length > maxLength) {
                throw new Error(`${fieldName}ÏùÄ(Îäî) ${maxLength}Ïûê Ïù¥ÌïòÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.`);
            }
            return trimmedValue;
        }
        
        function validateDateInput(dateValue, fieldName) {
            if (!dateValue) {
                throw new Error(`${fieldName}ÏùÑ(Î•º) ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.`);
            }
            const date = new Date(dateValue);
            if (isNaN(date.getTime())) {
                throw new Error(`${fieldName}Ïù¥(Í∞Ä) Ïú†Ìö®ÌïòÏßÄ ÏïäÏäµÎãàÎã§.`);
            }
            // ÎØ∏Îûò ÎÇ†Ïßú Ï†úÌïú (ÌïÑÏöîÏãú)
            const today = new Date();
            const maxDate = new Date(today.getFullYear() + 1, today.getMonth(), today.getDate());
            if (date > maxDate) {
                throw new Error(`${fieldName}ÏùÄ(Îäî) 1ÎÖÑ Ïù¥ÎÇ¥ ÎÇ†ÏßúÏó¨Ïïº Ìï©ÎãàÎã§.`);
            }
            return dateValue;
        }
        
        // Í±∞ÎûòÏ≤òÎ≥Ñ Îã®Í∞Ä Ï†ÄÏû• (ÎåÄÏãúÎ≥¥Îìú Ï†ÑÏö©)
        function savePartnerPrice(partnerId, price) {
            const numPrice = parseFloat(price);
            if (price && !isNaN(numPrice) && numPrice > 0) {
                localStorage.setItem(`partnerPrice_${partnerId}`, numPrice.toString());
            } else if (price === '' || price === null || price === undefined) {
                localStorage.removeItem(`partnerPrice_${partnerId}`);
            }
        }
        
        // ÎÇ†ÏßúÎ≥Ñ Îã®Í∞Ä Îã¨Î†• Í¥ÄÎ†® Ìï®ÏàòÎì§
        let currentCalendarPartnerId = null;
        let currentCalendarDate = new Date();
        let selectedCalendarDate = null;
        
        // Îã¨Î†• ÌÜ†Í∏Ä
        function togglePriceCalendar(partnerId) {
            const calendar = document.getElementById(`priceCalendar_${partnerId}`);
            const isVisible = calendar.style.display === 'block';
            
            // Î™®Îì† Îã¨Î†• Îã´Í∏∞
            document.querySelectorAll('.price-calendar').forEach(cal => {
                cal.style.display = 'none';
            });
            
            if (!isVisible) {
                currentCalendarPartnerId = partnerId;
                currentCalendarDate = new Date();
                selectedCalendarDate = new Date();
                renderPriceCalendar(partnerId);
                calendar.style.display = 'block';
                
                // ÌÅ¥Î¶≠ Ïô∏Î∂Ä ÏòÅÏó≠ Í∞êÏßÄÎ•º ÏúÑÌïú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
                setTimeout(() => {
                    document.addEventListener('click', closePriceCalendarOnOutsideClick);
                }, 100);
            } else {
                document.removeEventListener('click', closePriceCalendarOnOutsideClick);
            }
        }
        
        // Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã¨Î†• Îã´Í∏∞
        function closePriceCalendarOnOutsideClick(event) {
            if (!event.target.closest('.price-calendar-container')) {
                document.querySelectorAll('.price-calendar').forEach(cal => {
                    cal.style.display = 'none';
                });
                document.removeEventListener('click', closePriceCalendarOnOutsideClick);
            }
        }
        
        // Îã¨Î†• Î†åÎçîÎßÅ
        function renderPriceCalendar(partnerId) {
            const calendar = document.getElementById(`priceCalendar_${partnerId}`);
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const today = new Date();
            const todayStr = formatDateKey(today);
            const selectedStr = selectedCalendarDate ? formatDateKey(selectedCalendarDate) : todayStr;
            
            let calendarHTML = `
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="navigateCalendar('${partnerId}', -1)">‚óÄ</button>
                    <div class="calendar-month-year">${year}ÎÖÑ ${month + 1}Ïõî</div>
                    <button class="calendar-nav-btn" onclick="navigateCalendar('${partnerId}', 1)">‚ñ∂</button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Ïùº</div>
                    <div class="calendar-day-header">Ïõî</div>
                    <div class="calendar-day-header">Ìôî</div>
                    <div class="calendar-day-header">Ïàò</div>
                    <div class="calendar-day-header">Î™©</div>
                    <div class="calendar-day-header">Í∏à</div>
                    <div class="calendar-day-header">ÌÜ†</div>
            `;
            
            // 6Ï£º ÌëúÏãú
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + (week * 7 + day));
                    
                    const dateStr = formatDateKey(currentDate);
                    const dayNum = currentDate.getDate();
                    const isCurrentMonth = currentDate.getMonth() === month;
                    const isToday = dateStr === todayStr;
                    const isSelected = dateStr === selectedStr;
                    
                    // Ìï¥Îãπ ÎÇ†ÏßúÏùò Ï†ÄÏû•Îêú Í∞ÄÍ≤© Í∞ÄÏ†∏Ïò§Í∏∞
                    const savedPrice = getDayPrice(partnerId, dateStr);
                    const priceDisplay = savedPrice ? `${parseInt(savedPrice).toLocaleString()}` : '';
                    
                    let dayClass = 'calendar-day';
                    if (!isCurrentMonth) dayClass += ' other-month';
                    if (isToday) dayClass += ' today';
                    if (isSelected) dayClass += ' selected';
                    
                    calendarHTML += `
                        <div class="${dayClass}" onclick="selectCalendarDate('${partnerId}', '${dateStr}')">
                            <div>${dayNum}</div>
                            ${priceDisplay ? `<div class="day-price">${priceDisplay}</div>` : ''}
                        </div>
                    `;
                }
            }
            
            // ÏÑ†ÌÉùÎêú ÎÇ†ÏßúÏùò Í∞ÄÍ≤© ÌëúÏãú Î∞è ÏûÖÎ†•
            const selectedPrice = getDayPrice(partnerId, selectedStr) || '';
            const selectedDateDisplay = selectedCalendarDate ? 
                `${selectedCalendarDate.getMonth() + 1}/${selectedCalendarDate.getDate()}` : 
                `${today.getMonth() + 1}/${today.getDate()}`;
            
            calendarHTML += `
                </div>
                <div class="calendar-footer">
                    <label style="font-size: 12px; color: #374151; white-space: nowrap;">${selectedDateDisplay} Îã®Í∞Ä:</label>
                    <input 
                        type="number" 
                        class="calendar-price-input" 
                        placeholder="Ïõê/kg"
                        value="${selectedPrice}"
                        id="calendarPriceInput_${partnerId}"
                    >
                    <button 
                        class="calendar-save-btn" 
                        onclick="saveDayPrice('${partnerId}', '${selectedStr}')"
                    >
                        Ï†ÄÏû•
                    </button>
                </div>
            `;
            
            calendar.innerHTML = calendarHTML;
        }
        
        // Îã¨Î†• ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
        function navigateCalendar(partnerId, direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderPriceCalendar(partnerId);
        }
        
        // ÎÇ†Ïßú ÏÑ†ÌÉù
        function selectCalendarDate(partnerId, dateStr) {
            selectedCalendarDate = parseDateKey(dateStr);
            renderPriceCalendar(partnerId);
        }
        
        // ÎÇ†ÏßúÎ≥Ñ Í∞ÄÍ≤© Ï†ÄÏû•
        function saveDayPrice(partnerId, dateStr) {
            const input = document.getElementById(`calendarPriceInput_${partnerId}`);
            const price = input.value.trim();
            
            if (price && !isNaN(parseFloat(price)) && parseFloat(price) > 0) {
                localStorage.setItem(`dayPrice_${partnerId}_${dateStr}`, price);
                
                // Ïò§Îäò ÎÇ†ÏßúÎ©¥ Î©îÏù∏ Îã®Í∞Ä ÏûÖÎ†• ÌïÑÎìúÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                const today = formatDateKey(new Date());
                if (dateStr === today) {
                    const mainPriceInput = document.querySelector(`input[onchange="savePartnerPrice('${partnerId}', this.value)"]`);
                    if (mainPriceInput) {
                        mainPriceInput.value = price;
                        savePartnerPrice(partnerId, price);
                    }
                }
            } else if (price === '') {
                localStorage.removeItem(`dayPrice_${partnerId}_${dateStr}`);
            }
            
            renderPriceCalendar(partnerId);
        }
        
        // ÎÇ†ÏßúÎ≥Ñ Í∞ÄÍ≤© Ï°∞Ìöå
        function getDayPrice(partnerId, dateStr) {
            return localStorage.getItem(`dayPrice_${partnerId}_${dateStr}`);
        }
        
        // ÎÇ†Ïßú ÌÇ§ Ìè¨Îß∑ (YYYY-MM-DD)
        function formatDateKey(date) {
            return date.getFullYear() + '-' + 
                   String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(date.getDate()).padStart(2, '0');
        }
        
        // ÎÇ†Ïßú ÌÇ§ ÌååÏã±
        function parseDateKey(dateStr) {
            const parts = dateStr.split('-');
            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        }

        // ÌÉ≠ Ï†ÑÌôò
        function showTab(tabName, targetElement) {
            // Î™®Îì† ÌÉ≠ Ïª®ÌÖêÏ∏† Ïà®Í∏∞Í∏∞
            document.querySelectorAll('.content').forEach(content => {
                content.classList.add('hide');
            });
            
            // Î™®Îì† ÌÉ≠ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÏÑ†ÌÉùÎêú ÌÉ≠ ÌëúÏãú
            document.getElementById(tabName).classList.remove('hide');
            
            // ÌÅ¥Î¶≠Îêú ÌÉ≠ Î≤ÑÌäº ÌôúÏÑ±Ìôî
            if (targetElement) {
                targetElement.classList.add('active');
            } else {
                // ÌÉ≠ Ïù¥Î¶ÑÏúºÎ°ú Î≤ÑÌäº Ï∞æÍ∏∞ (ÌîÑÎ°úÍ∑∏ÎûòÎ∞çÏ†Å Ìò∏Ï∂úÏö©)
                const tabButtons = document.querySelectorAll('.nav-tab');
                tabButtons.forEach(button => {
                    if (button.textContent.includes(getTabDisplayName(tabName))) {
                        button.classList.add('active');
                    }
                });
            }
            
            // ÌÉ≠Î≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'partners') {
                updatePartnersManageList();
                updateHistorySelects();
            } else {
                updateAllSelects();
                if (tabName === 'orders') loadOrderHistory();
                if (tabName === 'advance') loadAdvanceHistory();
                if (tabName === 'payments') loadPaymentHistory();
                if (tabName === 'receipts') loadReceiptHistory();
                if (tabName === 'dataView') initializeDataView();
            }
        }
        
        // ÌÉ≠ Ïù¥Î¶Ñ Îß§Ìïë
        function getTabDisplayName(tabName) {
            const tabNames = {
                'dashboard': 'ÎåÄÏãúÎ≥¥Îìú',
                'partners': 'Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨',
                'orders': 'ÏÑ†Ï£ºÎ¨∏ Í¥ÄÎ¶¨',
                'advance': 'Ïô∏ÏÉÅ Í¥ÄÎ¶¨',
                'payments': 'ÏûÖÍ∏à Í¥ÄÎ¶¨',
                'receipts': 'ÏûÖÍ≥† Í¥ÄÎ¶¨',
                'dataView': 'Í±∞ÎûòÎÇ¥Ïó≠ÌôïÏù∏'
            };
            return tabNames[tabName] || tabName;
        }

        // Î™®Îì† ÏÖÄÎ†âÌä∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateAllSelects() {
            updateOrderSelects();
            updateAdvanceSelects();
            updatePaymentSelects();
            updateReceiptSelects();
            updateHistorySelects();
        }
        
        // ÎÇ¥Ïó≠ Ï°∞ÌöåÏö© ÏÖÄÎ†âÌä∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateHistorySelects() {
            // Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨Ïùò ÎÇ¥Ïó≠ ÏÖÄÎ†âÌä∏
            const historyPartnerSelect = document.getElementById('historyPartnerSelect');
            if (historyPartnerSelect) {
                historyPartnerSelect.innerHTML = '<option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
                partners.forEach(partner => {
                    const option = document.createElement('option');
                    option.value = partner.id;
                    option.textContent = partner.name;
                    historyPartnerSelect.appendChild(option);
                });
            }
            
            // ÏÑ†Ï£ºÎ¨∏ ÎÇ¥Ïó≠ ÌïÑÌÑ∞
            const orderHistoryPartner = document.getElementById('orderHistoryPartner');
            if (orderHistoryPartner) {
                orderHistoryPartner.innerHTML = '<option value="">Ï†ÑÏ≤¥ Í±∞ÎûòÏ≤ò</option>';
                partners.forEach(partner => {
                    const option = document.createElement('option');
                    option.value = partner.id;
                    option.textContent = partner.name;
                    orderHistoryPartner.appendChild(option);
                });
            }
            
            // Ïô∏ÏÉÅ ÎÇ¥Ïó≠ ÌïÑÌÑ∞
            const advanceHistoryPartner = document.getElementById('advanceHistoryPartner');
            if (advanceHistoryPartner) {
                advanceHistoryPartner.innerHTML = '<option value="">Ï†ÑÏ≤¥ Í±∞ÎûòÏ≤ò</option>';
                partners.forEach(partner => {
                    const option = document.createElement('option');
                    option.value = partner.id;
                    option.textContent = partner.name;
                    advanceHistoryPartner.appendChild(option);
                });
            }
            
            // ÏûÖÍ∏à ÎÇ¥Ïó≠ ÌïÑÌÑ∞
            const paymentHistoryPartner = document.getElementById('paymentHistoryPartner');
            if (paymentHistoryPartner) {
                paymentHistoryPartner.innerHTML = '<option value="">Ï†ÑÏ≤¥ Í±∞ÎûòÏ≤ò</option>';
                partners.forEach(partner => {
                    const option = document.createElement('option');
                    option.value = partner.id;
                    option.textContent = partner.name;
                    paymentHistoryPartner.appendChild(option);
                });
            }
            
            // ÏûÖÍ≥† ÎÇ¥Ïó≠ ÌïÑÌÑ∞
            const receiptHistoryPartner = document.getElementById('receiptHistoryPartner');
            if (receiptHistoryPartner) {
                receiptHistoryPartner.innerHTML = '<option value="">Ï†ÑÏ≤¥ Í±∞ÎûòÏ≤ò</option>';
                partners.forEach(partner => {
                    const option = document.createElement('option');
                    option.value = partner.id;
                    option.textContent = partner.name;
                    receiptHistoryPartner.appendChild(option);
                });
            }
        }

        // ÏÑ†Ï£ºÎ¨∏ ÏÖÄÎ†âÌä∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateOrderSelects() {
            const select = document.getElementById('orderPartner');
            select.innerHTML = '<option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
            partners.forEach(partner => {
                const option = document.createElement('option');
                option.value = partner.id;
                option.textContent = partner.name;
                select.appendChild(option);
            });
        }

        // Ïô∏ÏÉÅ ÏÖÄÎ†âÌä∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateAdvanceSelects() {
            const select = document.getElementById('advancePartner');
            select.innerHTML = '<option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
            partners.forEach(partner => {
                const option = document.createElement('option');
                option.value = partner.id;
                option.textContent = partner.name;
                select.appendChild(option);
            });
        }

        // ÏûÖÍ∏à ÏÖÄÎ†âÌä∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updatePaymentSelects() {
            const select = document.getElementById('paymentPartner');
            select.innerHTML = '<option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
            
            partners.forEach(partner => {
                const status = partnerStatus.get(partner.id);
                if (status && (status.pending_payment_order > 0 || status.pending_payment_advance > 0)) {
                    const option = document.createElement('option');
                    option.value = partner.id;
                    const advanceText = status.pending_payment_advance > 0 ? ` (Ïô∏ÏÉÅ: ${formatCurrency(status.pending_payment_advance)})` : '';
                    option.textContent = partner.name + advanceText;
                    select.appendChild(option);
                }
            });
        }

        // ÏûÖÍ≥† ÏÖÄÎ†âÌä∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateReceiptSelects() {
            const select = document.getElementById('receiptPartner');
            select.innerHTML = '<option value="">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
            
            partners.forEach(partner => {
                const status = partnerStatus.get(partner.id);
                if (status && status.pending_eel_kg > 0) {
                    const option = document.createElement('option');
                    option.value = partner.id;
                    option.textContent = `${partner.name} - Î∞õÏùÑÏû•Ïñ¥: ${status.pending_eel_kg}kg`;
                    select.appendChild(option);
                }
            });
        }

        // ÏûÖÍ∏à Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updatePaymentInfo() {
            const partnerId = document.getElementById('paymentPartner').value;
            const infoDiv = document.getElementById('paymentInfo');
            
            if (!partnerId) {
                infoDiv.style.display = 'none';
                document.getElementById('customPaymentAllocation').style.display = 'none';
                return;
            }
            
            const status = partnerStatus.get(partnerId);
            if (!status) {
                infoDiv.style.display = 'none';
                return;
            }
            
            // ÏµúÎåÄ Ï†ïÏÇ∞ Í∞ÄÎä• Í∏àÏï° Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('maxAdvanceInfo').textContent = `ÏµúÎåÄ: ${formatCurrency(status.pending_payment_advance)}`;
            document.getElementById('maxOrderInfo').textContent = `ÏµúÎåÄ: ${formatCurrency(status.pending_payment_order)}`;
            
            updatePaymentTypeInfo();
        }
        
        // ÏûÖÍ∏à Ïú†Ìòï Î≥ÄÍ≤Ω Ïãú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updatePaymentTypeInfo() {
            const partnerId = document.getElementById('paymentPartner').value;
            const paymentType = document.getElementById('paymentType').value;
            const infoDiv = document.getElementById('paymentInfo');
            const customDiv = document.getElementById('customPaymentAllocation');
            
            if (!partnerId) {
                infoDiv.style.display = 'none';
                customDiv.style.display = 'none';
                return;
            }
            
            const status = partnerStatus.get(partnerId);
            if (!status) {
                infoDiv.style.display = 'none';
                customDiv.style.display = 'none';
                return;
            }
            
            // Ïª§Ïä§ÌÖÄ ÏûÖÎ†• ÌïÑÎìú ÌëúÏãú/Ïà®ÍπÄ
            if (paymentType === 'custom') {
                customDiv.style.display = 'grid';
            } else {
                customDiv.style.display = 'none';
                // Ïª§Ïä§ÌÖÄ ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                document.getElementById('customAdvanceAmount').value = '';
                document.getElementById('customOrderAmount').value = '';
            }
            
            // Í∏∞Î≥∏ Ï†ïÎ≥¥ ÌëúÏãú
            let infoText = `
                <strong>ÌòÑÏû¨ ÏûîÏï° Ï†ïÎ≥¥:</strong><br>
                ‚Ä¢ Ïô∏ÏÉÅ Ï§ÑÎèà: ${formatCurrency(status.pending_payment_advance)}<br>
                ‚Ä¢ ÏÑ†Ï£ºÎ¨∏ Ï§ÑÎèà: ${formatCurrency(status.pending_payment_order)}<br>
                ‚Ä¢ Ï¥ù Ï§ÑÎèà: ${formatCurrency(status.pending_payment_advance + status.pending_payment_order)}<br><br>
            `;
            
            // ÏûÖÍ∏à Ïú†ÌòïÎ≥Ñ ÏïàÎÇ¥ Î©îÏãúÏßÄ
            switch(paymentType) {
                case 'auto':
                    infoText += '<strong>üîÑ ÏûêÎèô Ï†ïÏÇ∞:</strong> Ïô∏ÏÉÅÏùÑ Î®ºÏ†Ä Ï†ïÏÇ∞ÌïòÍ≥†, ÎÇ®ÏùÄ Í∏àÏï°ÏúºÎ°ú ÏÑ†Ï£ºÎ¨∏ÏùÑ Ï†ïÏÇ∞Ìï©ÎãàÎã§.';
                    break;
                case 'advance':
                    infoText += '<strong>üí≥ Ïô∏ÏÉÅÎßå Ï†ïÏÇ∞:</strong> ÏûÖÍ∏àÏï° Ï†ÑÏ≤¥Î•º Ïô∏ÏÉÅ Ï†ïÏÇ∞ÏóêÎßå ÏÇ¨Ïö©Ìï©ÎãàÎã§.';
                    break;
                case 'order':
                    infoText += '<strong>üì¶ ÏÑ†Ï£ºÎ¨∏Îßå Ï†ïÏÇ∞:</strong> ÏûÖÍ∏àÏï° Ï†ÑÏ≤¥Î•º ÏÑ†Ï£ºÎ¨∏ Ï†ïÏÇ∞ÏóêÎßå ÏÇ¨Ïö©Ìï©ÎãàÎã§.';
                    break;
                case 'custom':
                    infoText += '<strong>‚úèÔ∏è ÏßÅÏ†ë ÏßÄÏ†ï:</strong> Ïô∏ÏÉÅÍ≥º ÏÑ†Ï£ºÎ¨∏ Ï†ïÏÇ∞Ïï°ÏùÑ ÏßÅÏ†ë ÏûÖÎ†•ÌïòÏÑ∏Ïöî.';
                    break;
            }
            
            infoDiv.innerHTML = infoText;
            infoDiv.style.display = 'block';
            
            // ÏûÖÍ∏àÏï°Ïù¥ ÏûÖÎ†•ÎêòÏñ¥ ÏûàÏúºÎ©¥ Ï†ïÏÇ∞ ÎÇ¥Ïó≠ Í≥ÑÏÇ∞
            if (document.getElementById('paymentAmount').value) {
                calculatePaymentBreakdown();
            }
        }
        
        // Ïª§Ïä§ÌÖÄ Ï¥ùÏï° ÏóÖÎç∞Ïù¥Ìä∏
        function updateCustomTotal() {
            const advanceAmount = parseFloat(document.getElementById('customAdvanceAmount').value) || 0;
            const orderAmount = parseFloat(document.getElementById('customOrderAmount').value) || 0;
            const totalAmount = advanceAmount + orderAmount;
            
            document.getElementById('paymentAmount').value = totalAmount;
            calculatePaymentBreakdown();
        }

        // ÏûÖÍ∏à Ï†ïÏÇ∞ ÎÇ¥Ïó≠ Í≥ÑÏÇ∞
        function calculatePaymentBreakdown() {
            const partnerId = document.getElementById('paymentPartner').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            const paymentType = document.getElementById('paymentType').value;
            const infoDiv = document.getElementById('paymentInfo');
            
            if (!partnerId || amount <= 0) {
                updatePaymentTypeInfo();
                return;
            }
            
            const status = partnerStatus.get(partnerId);
            if (!status) return;
            
            let advancePayment = 0;
            let orderPayment = 0;
            let remainingAmount = amount;
            
            switch (paymentType) {
                case 'auto':
                    // Ïô∏ÏÉÅ Ïö∞ÏÑ† Ï†ïÏÇ∞
                    if (status.pending_payment_advance > 0 && remainingAmount > 0) {
                        advancePayment = Math.min(status.pending_payment_advance, remainingAmount);
                        remainingAmount -= advancePayment;
                    }
                    // ÏÑ†Ï£ºÎ¨∏ Ï†ïÏÇ∞
                    if (status.pending_payment_order > 0 && remainingAmount > 0) {
                        orderPayment = Math.min(status.pending_payment_order, remainingAmount);
                        remainingAmount -= orderPayment;
                    }
                    break;
                    
                case 'advance':
                    // Ïô∏ÏÉÅÎßå Ï†ïÏÇ∞
                    if (status.pending_payment_advance > 0) {
                        advancePayment = Math.min(status.pending_payment_advance, amount);
                        remainingAmount = amount - advancePayment;
                    } else {
                        remainingAmount = amount;
                    }
                    break;
                    
                case 'order':
                    // ÏÑ†Ï£ºÎ¨∏Îßå Ï†ïÏÇ∞
                    if (status.pending_payment_order > 0) {
                        orderPayment = Math.min(status.pending_payment_order, amount);
                        remainingAmount = amount - orderPayment;
                    } else {
                        remainingAmount = amount;
                    }
                    break;
                    
                case 'custom':
                    // ÏßÅÏ†ë ÏßÄÏ†ïÎêú Í∏àÏï° ÏÇ¨Ïö©
                    const customAdvanceAmount = parseFloat(document.getElementById('customAdvanceAmount').value) || 0;
                    const customOrderAmount = parseFloat(document.getElementById('customOrderAmount').value) || 0;
                    
                    advancePayment = Math.min(customAdvanceAmount, status.pending_payment_advance);
                    orderPayment = Math.min(customOrderAmount, status.pending_payment_order);
                    remainingAmount = amount - advancePayment - orderPayment;
                    break;
            }
            
            // Ï†ïÏÇ∞ ÌõÑ ÏÉÅÌÉú Í≥ÑÏÇ∞
            const afterAdvance = status.pending_payment_advance - advancePayment;
            const afterOrder = status.pending_payment_order - orderPayment;
            
            let infoText = `
                <strong>ÏûÖÍ∏à ${formatCurrency(amount)} Ï†ïÏÇ∞ ÎÇ¥Ïó≠:</strong><br>
                ‚Ä¢ Ïô∏ÏÉÅ Ï†ïÏÇ∞: ${formatCurrency(advancePayment)}<br>
                ‚Ä¢ ÏÑ†Ï£ºÎ¨∏ Ï†ïÏÇ∞: ${formatCurrency(orderPayment)}<br>
                ${remainingAmount > 0 ? `‚Ä¢ Ï¥àÍ≥º ÏûÖÍ∏à: ${formatCurrency(remainingAmount)}<br>` : ''}
                ${remainingAmount < 0 ? `‚Ä¢ Î∂ÄÏ°± Í∏àÏï°: ${formatCurrency(Math.abs(remainingAmount))}<br>` : ''}
                <br>
                <strong>Ï†ïÏÇ∞ ÌõÑ ÏûîÏï°:</strong><br>
                ‚Ä¢ Ïô∏ÏÉÅ Ï§ÑÎèà: ${formatCurrency(afterAdvance)}<br>
                ‚Ä¢ ÏÑ†Ï£ºÎ¨∏ Ï§ÑÎèà: ${formatCurrency(afterOrder)}
            `;
            
            infoDiv.innerHTML = infoText;
            infoDiv.style.display = 'block';
        }

        // ÎåÄÏãúÎ≥¥Îìú ÏóÖÎç∞Ïù¥Ìä∏
        function updateDashboard() {
            calculatePartnerStatus();
            
            // ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
            let totalOrderDebt = 0;
            let totalAdvanceDebt = 0;
            let totalPendingEel = 0;
            let warningPartners = 0;
            
            partnerStatus.forEach((status, partnerId) => {
                totalOrderDebt += status.pending_payment_order;
                totalAdvanceDebt += status.pending_payment_advance;
                totalPendingEel += status.pending_eel_kg;
                
                if (status.pending_payment_order > 0 || status.pending_payment_advance > 0 || status.pending_eel_kg > 0) {
                    warningPartners++;
                }
            });

            // ÌÜµÍ≥Ñ Ïπ¥Îìú ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('statsCards').innerHTML = `
                <div class="card stats-card red">
                    <div class="detail-label">ÏÑ†Ï£ºÎ¨∏ Ï§ÑÎèà</div>
                    <div class="stats-number">${formatCurrency(totalOrderDebt)}</div>
                </div>
                <div class="card stats-card orange">
                    <div class="detail-label">Ïô∏ÏÉÅ Ï§ÑÎèà</div>
                    <div class="stats-number">${formatCurrency(totalAdvanceDebt)}</div>
                </div>
                <div class="card stats-card purple">
                    <div class="detail-label">Î∞õÏùÑÏû•Ïñ¥</div>
                    <div class="stats-number">${totalPendingEel}kg</div>
                </div>
                <div class="card stats-card green">
                    <div class="detail-label">Ï£ºÏöîÍ±∞ÎûòÏ≤ò</div>
                    <div class="stats-number">${warningPartners}Í∞ú</div>
                </div>
            `;

            // Ï†ÑÏ≤¥ Í±∞ÎûòÏ≤ò Î™©Î°ù ÌëúÏãú
            updatePartnersList();
            
            // Î©îÎ™® Î™©Î°ù ÌëúÏãú
            updateMemoList();
        }

        // Î©îÎ™® Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updateMemoList() {
            const container = document.getElementById('memoList');
            const allMemos = [];
            
            // ÏÑ†Ï£ºÎ¨∏ Î©îÎ™® ÏàòÏßë
            orders.forEach(order => {
                if (order.memo) {
                    const partner = partners.find(p => p.id === order.partnerId);
                    allMemos.push({
                        id: order.id,
                        type: 'ÏÑ†Ï£ºÎ¨∏',
                        date: order.date,
                        partner: partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò',
                        memo: order.memo,
                        color: 'text-blue'
                    });
                }
            });
            
            // Ïô∏ÏÉÅ Î©îÎ™® ÏàòÏßë
            advances.forEach(advance => {
                if (advance.memo) {
                    const partner = partners.find(p => p.id === advance.partnerId);
                    allMemos.push({
                        id: advance.id,
                        type: 'Ïô∏ÏÉÅ',
                        date: advance.date,
                        partner: partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò',
                        memo: advance.memo,
                        color: 'text-orange'
                    });
                }
            });
            
            // ÏûÖÍ∏à Î©îÎ™® ÏàòÏßë
            payments.forEach(payment => {
                if (payment.memo) {
                    const partner = partners.find(p => p.id === payment.partnerId);
                    allMemos.push({
                        id: payment.id,
                        type: 'ÏûÖÍ∏à',
                        date: payment.date,
                        partner: partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò',
                        memo: payment.memo,
                        color: 'text-green'
                    });
                }
            });
            
            // ÏûÖÍ≥† Î©îÎ™® ÏàòÏßë
            receipts.forEach(receipt => {
                if (receipt.memo) {
                    const partner = partners.find(p => p.id === receipt.partnerId);
                    allMemos.push({
                        id: receipt.id,
                        type: 'ÏûÖÍ≥†',
                        date: receipt.date,
                        partner: partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò',
                        memo: receipt.memo,
                        color: 'text-purple'
                    });
                }
            });
            
            // ÎÇ†ÏßúÏàúÏúºÎ°ú Ï†ïÎ†¨ (ÏµúÏã† 10Í∞úÎßå)
            allMemos.sort((a, b) => new Date(b.date) - new Date(a.date));
            const recentMemos = allMemos.slice(0, 10);
            
            if (recentMemos.length === 0) {
                container.innerHTML = '<div class="text-center text-gray">Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }
            
            container.innerHTML = recentMemos.map((memo, index) => `
                <div class="card" style="padding: 15px; margin-bottom: 10px; border-left: 4px solid #e5e7eb;" id="memo-${memo.type}-${memo.id || index}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                        <span class="${memo.color}" style="font-weight: bold; font-size: 0.875rem;">[${memo.type}] ${memo.partner}</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="text-gray" style="font-size: 0.75rem;">${formatDate(memo.date)}</span>
                            <button class="delete-btn" onclick="deleteMemoFromDashboard('${memo.type}', '${memo.id}', this)" title="Î©îÎ™®Îßå ÏÇ≠Ï†ú" style="padding: 4px 6px; font-size: 0.75rem;">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    <div style="font-size: 0.875rem; line-height: 1.4;">${memo.memo}</div>
                </div>
            `).join('');
        }
        
        // ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú Î©îÎ™® ÏÇ≠Ï†ú
        function deleteMemoFromDashboard(type, itemId, buttonElement) {
            if (!confirm('Ïù¥ Î©îÎ™®Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n‚Äª Î©îÎ™®Îßå ÏÇ≠Ï†úÎêòÍ≥† Í±∞Îûò ÎÇ¥Ïó≠ÏùÄ Ïú†ÏßÄÎê©ÎãàÎã§.')) {
                return;
            }
            
            let found = false;
            
            // Ìï¥Îãπ Í±∞Îûò ÎÇ¥Ïó≠ÏóêÏÑú Î©îÎ™®Îßå ÏÇ≠Ï†ú
            switch (type) {
                case 'ÏÑ†Ï£ºÎ¨∏':
                    const orderIndex = orders.findIndex(o => o.id === itemId);
                    if (orderIndex !== -1) {
                        orders[orderIndex].memo = '';
                        found = true;
                    }
                    break;
                case 'Ïô∏ÏÉÅ':
                    const advanceIndex = advances.findIndex(a => a.id === itemId);
                    if (advanceIndex !== -1) {
                        advances[advanceIndex].memo = '';
                        found = true;
                    }
                    break;
                case 'ÏûÖÍ∏à':
                    const paymentIndex = payments.findIndex(p => p.id === itemId);
                    if (paymentIndex !== -1) {
                        payments[paymentIndex].memo = '';
                        found = true;
                    }
                    break;
                case 'ÏûÖÍ≥†':
                    const receiptIndex = receipts.findIndex(r => r.id === itemId);
                    if (receiptIndex !== -1) {
                        receipts[receiptIndex].memo = '';
                        found = true;
                    }
                    break;
            }
            
            if (found) {
                // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                saveData();
                
                // Î©îÎ™® Ïπ¥Îìú Ïï†ÎãàÎ©îÏù¥ÏÖòÏúºÎ°ú Ï†úÍ±∞
                const memoCard = buttonElement.closest('.card');
                memoCard.style.transition = 'opacity 0.3s, transform 0.3s';
                memoCard.style.opacity = '0';
                memoCard.style.transform = 'translateX(100px)';
                
                // Ïï†ÎãàÎ©îÏù¥ÏÖò ÌõÑ Î©îÎ™® Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                setTimeout(() => {
                    updateMemoList();
                }, 300);
                
                alert('Î©îÎ™®Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            } else {
                alert('Ìï¥Îãπ Î©îÎ™®Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }

        // Ï†ÑÏ≤¥ Í±∞ÎûòÏ≤ò Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updatePartnersList() {
            const container = document.getElementById('partnersList');
            
            if (partners.length === 0) {
                container.innerHTML = '<div class="text-center text-gray">Îì±Î°ùÎêú Í±∞ÎûòÏ≤òÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }
            
            container.innerHTML = partners.map(partner => {
                const status = partnerStatus.get(partner.id) || {
                    pending_payment_order: 0,
                    pending_payment_advance: 0,
                    pending_eel_kg: 0
                };
                return createPartnerCard(partner, status, false);
            }).join('');
        }

        // Í±∞ÎûòÏ≤ò Ïπ¥Îìú ÏÉùÏÑ±
        function createPartnerCard(partner, status, isWarning) {
            const totalDebt = status.pending_payment_order + status.pending_payment_advance;
            const hasAdvance = status.pending_payment_advance > 0;
            const cardClass = isWarning ? 'warning' : (totalDebt === 0 && status.pending_eel_kg === 0 ? 'completed' : '');
            
            // Í±∞ÎûòÏ≤òÎ≥Ñ Ï†ÄÏû•Îêú Îã®Í∞Ä Î∂àÎü¨Ïò§Í∏∞ (Ïò§Îäò ÎÇ†Ïßú Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Îã®Í∞Ä)
            const todayKey = formatDateKey(new Date());
            const todayPrice = localStorage.getItem(`dayPrice_${partner.id}_${todayKey}`);
            const savedPrice = todayPrice || localStorage.getItem(`partnerPrice_${partner.id}`) || '';
            
            return `
                <div class="card partner-card ${cardClass}">
                    <div class="partner-info">
                        <div>
                            <div class="partner-name">
                                ${partner.name}
                                ${hasAdvance ? `<span class="advance-indicator">Ïô∏ÏÉÅ: ${formatCurrency(status.pending_payment_advance)}</span>` : ''}
                            </div>
                            ${partner.contact ? `<div class="text-gray" style="font-size: 0.875rem;">üìû ${partner.contact}</div>` : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button class="delete-btn" onclick="deletePartner('${partner.id}', '${partner.name}')" title="Í±∞ÎûòÏ≤ò ÏÇ≠Ï†ú">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    
                    <!-- Îã®Í∞Ä ÏûÖÎ†• ÌïÑÎìú Ï∂îÍ∞Ä -->
                    <div style="margin: 15px 0; padding: 10px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="font-size: 0.875rem; font-weight: 600; color: #374151; min-width: 80px;">Ïû•Ïñ¥ Îã®Í∞Ä:</label>
                            <input 
                                type="number" 
                                value="${savedPrice}" 
                                placeholder="Ïõê/kg" 
                                style="flex: 1; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem; max-width: 120px;"
                                onchange="savePartnerPrice('${partner.id}', this.value)"
                                onblur="savePartnerPrice('${partner.id}', this.value)"
                            >
                            <span style="font-size: 0.75rem; color: #6b7280;">Ïõê/kg</span>
                            <div class="price-calendar-container">
                                <button 
                                    type="button"
                                    onclick="togglePriceCalendar('${partner.id}')"
                                    style="background: #3b82f6; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;"
                                    title="ÎÇ†ÏßúÎ≥Ñ Îã®Í∞Ä Î≥¥Í∏∞"
                                >
                                    üìÖ
                                </button>
                                <div id="priceCalendar_${partner.id}" class="price-calendar">
                                    <!-- Îã¨Î†•Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="partner-details">
                        <div class="detail-item">
                            <div class="detail-label">Î∞õÏùÑÏû•Ïñ¥</div>
                            <div class="detail-value ${status.pending_eel_kg > 0 ? 'text-purple' : 'text-green'}">${status.pending_eel_kg}kg</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ÏÑ†Ï£ºÎ¨∏ Ï§ÑÎèà</div>
                            <div class="detail-value ${status.pending_payment_order > 0 ? 'text-red' : 'text-green'}">${formatCurrency(status.pending_payment_order)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ïô∏ÏÉÅ Ï§ÑÎèà</div>
                            <div class="detail-value ${status.pending_payment_advance > 0 ? 'text-orange' : 'text-green'}">${formatCurrency(status.pending_payment_advance)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ï¥ù Ï§ÑÎèà</div>
                            <div class="detail-value ${totalDebt > 0 ? 'text-red' : 'text-green'}">${formatCurrency(totalDebt)}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updatePartnersManageList() {
            const container = document.getElementById('partnersListManage');
            if (partners.length === 0) {
                container.innerHTML = '<div class="text-center text-gray">Îì±Î°ùÎêú Í±∞ÎûòÏ≤òÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }
            
            container.innerHTML = partners.map(partner => `
                <div class="card">
                    <div class="partner-info">
                        <div>
                            <div class="partner-name">${partner.name}</div>
                            <div class="text-gray">${partner.contact || 'Ïó∞ÎùΩÏ≤ò ÏóÜÏùå'}</div>
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="editPartner('${partner.id}')" style="margin-right: 10px;">ÏàòÏ†ï</button>
                            <button class="btn btn-danger" onclick="deletePartner('${partner.id}')">ÏÇ≠Ï†ú</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Í±∞ÎûòÏ≤ò Ï∂îÍ∞Ä
        function addPartner() {
            try {
                const name = validateStringInput(
                    document.getElementById('partnerName').value, 
                    'Í±∞ÎûòÏ≤òÎ™Ö', 
                    50
                );
                const contact = document.getElementById('partnerContact').value.trim();
                
                // Ï§ëÎ≥µ Í±∞ÎûòÏ≤òÎ™Ö Í≤ÄÏÇ¨
                if (partners.some(p => p.name === name)) {
                    throw new Error('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Í±∞ÎûòÏ≤òÎ™ÖÏûÖÎãàÎã§.');
                }
                
                // Ïó∞ÎùΩÏ≤ò Í≤ÄÏ¶ù (ÏÑ†ÌÉùÏÇ¨Ìï≠Ïù¥ÎØÄÎ°ú Í∞íÏù¥ ÏûàÏùÑ ÎïåÎßå)
                if (contact && contact.length > 20) {
                    throw new Error('Ïó∞ÎùΩÏ≤òÎäî 20Ïûê Ïù¥ÌïòÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                }
                
                const partner = {
                    id: generateId(),
                    name,
                    contact
                };
                
                partners.push(partner);
                
                // Í±∞ÎûòÏ≤ò ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                partnerStatus.set(partner.id, {
                    pending_payment_order: 0,
                    pending_payment_advance: 0,
                    pending_eel_kg: 0
                });
                
                saveData();
                updateAllSelects();
                updatePartnersManageList();
                updateDashboard();
                
                // ÌòÑÏû¨ ÌÉ≠Ïù¥ Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨ÎùºÎ©¥ ÎÇ¥Ïó≠ÎèÑ ÏÉàÎ°úÍ≥†Ïπ®
                const activeTab = document.querySelector('.nav-tab.active');
                if (activeTab && activeTab.textContent.includes('Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨')) {
                    loadPartnerHistory();
                }
                
                // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                document.getElementById('partnerName').value = '';
                document.getElementById('partnerContact').value = '';
                
                alert('Í±∞ÎûòÏ≤òÍ∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.');
            } catch (error) {
                alert(error.message);
            }
        }

        // Í±∞ÎûòÏ≤ò ÏàòÏ†ï Î™®Îìú ÌôúÏÑ±Ìôî
        function editPartner(id) {
            const partner = partners.find(p => p.id === id);
            if (!partner) {
                alert('Í±∞ÎûòÏ≤òÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // ÌèºÏóê Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•
            document.getElementById('partnerName').value = partner.name;
            document.getElementById('partnerContact').value = partner.contact || '';
            document.getElementById('partnerEditId').value = id;
            
            // Ï†úÎ™©Í≥º Î≤ÑÌäº Î≥ÄÍ≤Ω
            document.getElementById('partnerFormTitle').textContent = 'Í±∞ÎûòÏ≤ò ÏàòÏ†ï';
            document.getElementById('partnerFormButtons').innerHTML = `
                <button class="btn btn-success" onclick="updatePartner()">ÏàòÏ†ï ÏôÑÎ£å</button>
                <button class="btn btn-secondary" onclick="cancelEdit()" style="margin-left: 10px;">Ï∑®ÏÜå</button>
            `;
            
            // ÏÉÅÎã®ÏúºÎ°ú Ïä§ÌÅ¨Î°§
            document.getElementById('partnerFormTitle').scrollIntoView({ behavior: 'smooth' });
        }

        // Í±∞ÎûòÏ≤ò ÏàòÏ†ï ÏôÑÎ£å
        function updatePartner() {
            try {
                const editId = document.getElementById('partnerEditId').value;
                const name = validateStringInput(
                    document.getElementById('partnerName').value, 
                    'Í±∞ÎûòÏ≤òÎ™Ö', 
                    50
                );
                const contact = document.getElementById('partnerContact').value.trim();
                
                if (!editId) {
                    alert('ÏàòÏ†ïÌï† Í±∞ÎûòÏ≤òÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }
                
                // Í∏∞Ï°¥ Í±∞ÎûòÏ≤òÏôÄ Ïù¥Î¶Ñ Ï§ëÎ≥µ Ï≤¥ÌÅ¨ (ÏûêÍ∏∞ ÏûêÏã† Ï†úÏô∏)
                if (partners.some(p => p.id !== editId && p.name === name)) {
                    throw new Error('Ïù¥ÎØ∏ Îì±Î°ùÎêú Í±∞ÎûòÏ≤òÎ™ÖÏûÖÎãàÎã§.');
                }
                
                // Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                const partnerIndex = partners.findIndex(p => p.id === editId);
                if (partnerIndex === -1) {
                    alert('Í±∞ÎûòÏ≤òÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }
                
                partners[partnerIndex].name = name;
                partners[partnerIndex].contact = contact;
                
                saveData();
                updateAllSelects();
                updatePartnersManageList();
                updateDashboard();
                
                // ÌòÑÏû¨ ÌÉ≠Ïù¥ Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨ÎùºÎ©¥ ÎÇ¥Ïó≠ÎèÑ ÏÉàÎ°úÍ≥†Ïπ®
                const activeTab = document.querySelector('.nav-tab.active');
                if (activeTab && activeTab.textContent.includes('Í±∞ÎûòÏ≤ò Í¥ÄÎ¶¨')) {
                    loadPartnerHistory();
                }
                
                // ÏàòÏ†ï Î™®Îìú Ï¢ÖÎ£å
                cancelEdit();
                
                alert('Í±∞ÎûòÏ≤òÍ∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.');
            } catch (error) {
                alert(error.message);
            }
        }

        // ÏàòÏ†ï Î™®Îìú Ï∑®ÏÜå
        function cancelEdit() {
            // Ìèº Ï¥àÍ∏∞Ìôî
            document.getElementById('partnerName').value = '';
            document.getElementById('partnerContact').value = '';
            document.getElementById('partnerEditId').value = '';
            
            // Ï†úÎ™©Í≥º Î≤ÑÌäº ÏõêÎûòÎåÄÎ°ú
            document.getElementById('partnerFormTitle').textContent = 'Í±∞ÎûòÏ≤ò Îì±Î°ù';
            document.getElementById('partnerFormButtons').innerHTML = `
                <button class="btn btn-success" onclick="addPartner()">Í±∞ÎûòÏ≤ò Îì±Î°ù</button>
            `;
        }

        // Í±∞ÎûòÏ≤ò ÏÇ≠Ï†ú (Í±∞Îûò ÎÇ¥Ïó≠ÏùÄ Î≥¥Ï°¥)
        function deletePartner(id, name) {
            if (confirm(`${name || 'Ïù¥ Í±∞ÎûòÏ≤ò'}Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏ£ºÏùò: Í±∞ÎûòÏ≤òÎäî ÏÇ≠Ï†úÎêòÏßÄÎßå Í±∞Îûò ÎÇ¥Ïó≠ÏùÄ Î≥¥Ï°¥Îê©ÎãàÎã§.`)) {
                // Í±∞ÎûòÏ≤òÎßå ÏÇ≠Ï†ú, Í±∞Îûò ÎÇ¥Ïó≠ÏùÄ Î≥¥Ï°¥
                partners = partners.filter(p => p.id !== id);
                partnerStatus.delete(id);
                
                saveData();
                updateAllSelects();
                updatePartnersManageList();
                updateDashboard();
                loadPartnerHistory();
            }
        }

        // ÏÑ†Ï£ºÎ¨∏ Ï∂îÍ∞Ä
        function addOrder() {
            try {
                const partnerId = document.getElementById('orderPartner').value;
                if (!partnerId) {
                    throw new Error('Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                }
                
                const date = validateDateInput(
                    document.getElementById('orderDate').value, 
                    'Ï£ºÎ¨∏Ïùº'
                );
                
                const quantity = validateNumericInput(
                    document.getElementById('orderQuantity').value, 
                    'ÏàòÎüâ', 
                    0.1, 
                    99999
                );
                
                const pricePerKg = validateNumericInput(
                    document.getElementById('orderPrice').value, 
                    'Îã®Í∞Ä', 
                    1, 
                    999999
                );
                
                const memo = document.getElementById('orderMemo').value.trim();
                if (memo.length > 500) {
                    throw new Error('ÎπÑÍ≥†Îäî 500Ïûê Ïù¥ÌïòÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                }
                
                const totalAmount = quantity * pricePerKg;
                
                const order = {
                    id: generateId(),
                    partnerId,
                    date,
                    quantity,
                    pricePerKg,
                    totalAmount,
                    memo
                };
                
                orders.push(order);
                
                // Í±∞ÎûòÏ≤ò ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                const status = partnerStatus.get(partnerId);
                if (status) {
                    status.pending_payment_order += totalAmount;
                    status.pending_eel_kg += quantity;
                }
                
                saveData();
                updateAllSelects();
                updateDashboard();
                loadOrderHistory();
                
                // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                document.getElementById('orderPartner').value = '';
                document.getElementById('orderQuantity').value = '';
                document.getElementById('orderPrice').value = '';
                document.getElementById('orderMemo').value = '';
                document.getElementById('orderTotalAmount').textContent = '';
                
                alert('ÏÑ†Ï£ºÎ¨∏Ïù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.');
            } catch (error) {
                alert(error.message);
            }
        }

        // Ïô∏ÏÉÅ Ï∂îÍ∞Ä
        function addAdvance() {
            try {
                const partnerId = document.getElementById('advancePartner').value;
                if (!partnerId) {
                    throw new Error('Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                }
                
                const date = validateDateInput(
                    document.getElementById('advanceDate').value, 
                    'Ïô∏ÏÉÅÏùº'
                );
                
                const quantity = validateNumericInput(
                    document.getElementById('advanceQuantity').value, 
                    'ÏàòÎüâ', 
                    0.1, 
                    99999
                );
                
                const pricePerKg = validateNumericInput(
                    document.getElementById('advancePrice').value, 
                    'Îã®Í∞Ä', 
                    1, 
                    999999
                );
                
                const memo = document.getElementById('advanceMemo').value.trim();
                if (memo.length > 500) {
                    throw new Error('ÎπÑÍ≥†Îäî 500Ïûê Ïù¥ÌïòÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                }
                
                const totalAmount = quantity * pricePerKg;
                
                const advance = {
                    id: generateId(),
                    partnerId,
                    date,
                    quantity,
                    pricePerKg,
                    totalAmount,
                    memo
                };
                
                advances.push(advance);
                
                // Í±∞ÎûòÏ≤ò ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                const status = partnerStatus.get(partnerId);
                if (status) {
                    status.pending_payment_advance += totalAmount;
                    status.pending_eel_kg += quantity;
                }
                
                saveData();
                updateAllSelects();
                updateDashboard();
                loadAdvanceHistory();
                
                // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                document.getElementById('advancePartner').value = '';
                document.getElementById('advanceQuantity').value = '';
                document.getElementById('advancePrice').value = '';
                document.getElementById('advanceMemo').value = '';
                document.getElementById('advanceTotalAmount').textContent = '';
                
                alert('Ïô∏ÏÉÅÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.');
            } catch (error) {
                alert(error.message);
            }
        }

        // ÏûÖÍ∏à Ï∂îÍ∞Ä
        function addPayment() {
            try {
                const partnerId = document.getElementById('paymentPartner').value;
                if (!partnerId) {
                    throw new Error('Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                }
                
                const date = validateDateInput(
                    document.getElementById('paymentDate').value, 
                    'ÏûÖÍ∏àÏùº'
                );
                
                const amount = validateNumericInput(
                    document.getElementById('paymentAmount').value, 
                    'ÏûÖÍ∏àÏï°', 
                    1, 
                    99999999
                );
                
                const paymentType = document.getElementById('paymentType').value;
                const memo = document.getElementById('paymentMemo').value.trim();
                if (memo.length > 500) {
                    throw new Error('ÎπÑÍ≥†Îäî 500Ïûê Ïù¥ÌïòÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                }
                
                const status = partnerStatus.get(partnerId);
                if (!status) {
                    throw new Error('Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
            
            // ÏûÖÍ∏à Ïú†ÌòïÎ≥Ñ Ï†ïÏÇ∞ Í∏àÏï° Í≥ÑÏÇ∞
            let advancePayment = 0;
            let orderPayment = 0;
            let remainingAmount = amount;
            
            switch (paymentType) {
                case 'auto':
                    // Ïô∏ÏÉÅ Ïö∞ÏÑ† Ï†ïÏÇ∞
                    if (status.pending_payment_advance > 0 && remainingAmount > 0) {
                        advancePayment = Math.min(status.pending_payment_advance, remainingAmount);
                        remainingAmount -= advancePayment;
                    }
                    // ÏÑ†Ï£ºÎ¨∏ Ï†ïÏÇ∞
                    if (status.pending_payment_order > 0 && remainingAmount > 0) {
                        orderPayment = Math.min(status.pending_payment_order, remainingAmount);
                        remainingAmount -= orderPayment;
                    }
                    break;
                    
                case 'advance':
                    // Ïô∏ÏÉÅÎßå Ï†ïÏÇ∞
                    if (status.pending_payment_advance > 0) {
                        advancePayment = Math.min(status.pending_payment_advance, amount);
                        remainingAmount = amount - advancePayment;
                    }
                    break;
                    
                case 'order':
                    // ÏÑ†Ï£ºÎ¨∏Îßå Ï†ïÏÇ∞
                    if (status.pending_payment_order > 0) {
                        orderPayment = Math.min(status.pending_payment_order, amount);
                        remainingAmount = amount - orderPayment;
                    }
                    break;
                    
                case 'custom':
                    // ÏßÅÏ†ë ÏßÄÏ†ïÎêú Í∏àÏï° ÏÇ¨Ïö©
                    const customAdvanceAmount = parseFloat(document.getElementById('customAdvanceAmount').value) || 0;
                    const customOrderAmount = parseFloat(document.getElementById('customOrderAmount').value) || 0;
                    
                            if (customAdvanceAmount + customOrderAmount !== amount) {
                        throw new Error('Ïô∏ÏÉÅ Ï†ïÏÇ∞Ïï° + ÏÑ†Ï£ºÎ¨∏ Ï†ïÏÇ∞Ïï°Ïù¥ ÏûÖÍ∏àÏï°Í≥º ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                    }
                    
                    if (customAdvanceAmount > status.pending_payment_advance) {
                        throw new Error('Ïô∏ÏÉÅ Ï†ïÏÇ∞Ïï°Ïù¥ Ïã§Ï†ú Ïô∏ÏÉÅ Í∏àÏï°Î≥¥Îã§ ÌÅΩÎãàÎã§.');
                    }
                    
                    if (customOrderAmount > status.pending_payment_order) {
                        throw new Error('ÏÑ†Ï£ºÎ¨∏ Ï†ïÏÇ∞Ïï°Ïù¥ Ïã§Ï†ú ÏÑ†Ï£ºÎ¨∏ Í∏àÏï°Î≥¥Îã§ ÌÅΩÎãàÎã§.');
                    }
                    
                    advancePayment = customAdvanceAmount;
                    orderPayment = customOrderAmount;
                    remainingAmount = 0;
                    break;
            }
            
            // ÏûÖÍ∏à ÎÇ¥Ïó≠ Ï†ÄÏû• (Ï†ïÏÇ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ìè¨Ìï®)
            const payment = {
                id: generateId(),
                partnerId,
                date,
                amount,
                paymentType,
                advancePayment,
                orderPayment,
                remainingAmount,
                memo
            };
            
            payments.push(payment);
            
            // Í±∞ÎûòÏ≤ò ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            status.pending_payment_advance -= advancePayment;
            status.pending_payment_order -= orderPayment;
            
            saveData();
            updateAllSelects();
            updateDashboard();
            loadPaymentHistory();
            
            // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            document.getElementById('paymentPartner').value = '';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentMemo').value = '';
            document.getElementById('paymentType').value = 'auto';
            document.getElementById('customAdvanceAmount').value = '';
            document.getElementById('customOrderAmount').value = '';
            document.getElementById('paymentInfo').style.display = 'none';
            document.getElementById('customPaymentAllocation').style.display = 'none';
            
            let alertMessage = 'ÏûÖÍ∏àÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.\n\n';
            alertMessage += `Ïô∏ÏÉÅ Ï†ïÏÇ∞: ${formatCurrency(advancePayment)}\n`;
            alertMessage += `ÏÑ†Ï£ºÎ¨∏ Ï†ïÏÇ∞: ${formatCurrency(orderPayment)}`;
            if (remainingAmount > 0) {
                alertMessage += `\nÏ¥àÍ≥º ÏûÖÍ∏à: ${formatCurrency(remainingAmount)}`;
            }
            
                alert(alertMessage);
            } catch (error) {
                alert(error.message);
            }
        }

        // ÏûÖÍ≥† Ï∂îÍ∞Ä
        function addReceipt() {
            try {
                const partnerId = document.getElementById('receiptPartner').value;
                if (!partnerId) {
                    throw new Error('Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                }
                
                const date = validateDateInput(
                    document.getElementById('receiptDate').value, 
                    'ÏûÖÍ≥†Ïùº'
                );
                
                const quantity = validateNumericInput(
                    document.getElementById('receiptQuantity').value, 
                    'ÏûÖÍ≥†Îüâ', 
                    0.1, 
                    99999
                );
                
                const memo = document.getElementById('receiptMemo').value.trim();
                if (memo.length > 500) {
                    throw new Error('ÎπÑÍ≥†Îäî 500Ïûê Ïù¥ÌïòÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                }
                
                const receipt = {
                    id: generateId(),
                    partnerId,
                    date,
                    quantity,
                    memo
                };
                
                receipts.push(receipt);
                
                // Í±∞ÎûòÏ≤ò ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                const status = partnerStatus.get(partnerId);
                if (status) {
                    status.pending_eel_kg -= quantity;
                    // ÏùåÏàò Î∞©ÏßÄ
                    if (status.pending_eel_kg < 0) status.pending_eel_kg = 0;
                }
                
                saveData();
                updateAllSelects();
                updateDashboard();
                loadReceiptHistory();
                
                // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                document.getElementById('receiptPartner').value = '';
                document.getElementById('receiptQuantity').value = '';
                document.getElementById('receiptMemo').value = '';
                
                alert('ÏûÖÍ≥†Í∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.');
            } catch (error) {
                alert(error.message);
            }
        }

        // ÏûÖÍ∏à ÎÇ¥Ïó≠ Î°úÎìú
        function loadPaymentHistory() {
            const partnerFilter = document.getElementById('paymentHistoryPartner').value;
            const periodFilter = document.getElementById('paymentHistoryPeriod').value;
            const container = document.getElementById('paymentHistoryList');
            
            let filteredPayments = payments;
            
            // Í±∞ÎûòÏ≤ò ÌïÑÌÑ∞ Ï†ÅÏö©
            if (partnerFilter) {
                filteredPayments = filteredPayments.filter(payment => payment.partnerId === partnerFilter);
            }
            
            // Í∏∞Í∞Ñ ÌïÑÌÑ∞ Ï†ÅÏö©
            if (periodFilter !== 'all') {
                const days = parseInt(periodFilter);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                filteredPayments = filteredPayments.filter(payment => new Date(payment.date) >= cutoffDate);
            }
            
            // ÎÇ†ÏßúÏàú Ï†ïÎ†¨ (ÏµúÏã†Ïàú)
            filteredPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredPayments.length === 0) {
                container.innerHTML = '<div class="text-center text-gray">ÏûÖÍ∏à ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }
            
            container.innerHTML = filteredPayments.map(payment => {
                const partner = partners.find(p => p.id === payment.partnerId);
                const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                
                // ÏûÖÍ∏à Ïú†Ìòï ÌëúÏãú
                let paymentTypeText = '';
                switch(payment.paymentType) {
                    case 'auto': paymentTypeText = 'üîÑ ÏûêÎèôÏ†ïÏÇ∞'; break;
                    case 'advance': paymentTypeText = 'üí≥ Ïô∏ÏÉÅÏ†ïÏÇ∞'; break;
                    case 'order': paymentTypeText = 'üì¶ ÏÑ†Ï£ºÎ¨∏Ï†ïÏÇ∞'; break;
                    case 'custom': paymentTypeText = '‚úèÔ∏è ÏßÅÏ†ëÏßÄÏ†ï'; break;
                    default: paymentTypeText = 'üîÑ ÏûêÎèôÏ†ïÏÇ∞'; break;
                }
                
                // Ï†ïÏÇ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ (Ïã†Í∑ú ÏûÖÍ∏à ÎÇ¥Ïó≠ÏóêÎßå ÏûàÏùå)
                let settlementInfo = '';
                if (payment.advancePayment !== undefined && payment.orderPayment !== undefined) {
                    settlementInfo = `
                        <div class="payment-breakdown" style="margin-top: 10px;">
                            <strong>Ï†ïÏÇ∞ ÏÉÅÏÑ∏:</strong><br>
                            ‚Ä¢ Ïô∏ÏÉÅ Ï†ïÏÇ∞: ${formatCurrency(payment.advancePayment || 0)}<br>
                            ‚Ä¢ ÏÑ†Ï£ºÎ¨∏ Ï†ïÏÇ∞: ${formatCurrency(payment.orderPayment || 0)}
                            ${payment.remainingAmount > 0 ? `<br>‚Ä¢ Ï¥àÍ≥º ÏûÖÍ∏à: ${formatCurrency(payment.remainingAmount)}` : ''}
                        </div>
                    `;
                }
                
                return `
                    <div class="card" style="margin-bottom: 15px; border-left: 4px solid #10b981;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">
                                    ${partnerName} 
                                    <span style="background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px;">
                                        ${paymentTypeText}
                                    </span>
                                </div>
                                <div class="text-gray" style="font-size: 0.875rem;">${formatDate(payment.date)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #10b981;">
                                    ${formatCurrency(payment.amount)}
                                </div>
                                <button class="delete-btn" onclick="deletePayment('${payment.id}')" title="ÏûÖÍ∏à ÎÇ¥Ïó≠ ÏÇ≠Ï†ú">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        ${settlementInfo}
                        ${payment.memo ? `<div style="margin-top: 10px; padding: 8px; background: #f9fafb; border-radius: 4px; font-size: 0.875rem;">${payment.memo}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // ÏÑ†Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Î°úÎìú 
        function loadOrderHistory() {
            const partnerFilter = document.getElementById('orderHistoryPartner').value;
            const periodFilter = document.getElementById('orderHistoryPeriod').value;
            const container = document.getElementById('orderHistoryList');
            
            let filteredOrders = orders;
            
            // Í±∞ÎûòÏ≤ò ÌïÑÌÑ∞ Ï†ÅÏö©
            if (partnerFilter) {
                filteredOrders = filteredOrders.filter(order => order.partnerId === partnerFilter);
            }
            
            // Í∏∞Í∞Ñ ÌïÑÌÑ∞ Ï†ÅÏö©
            if (periodFilter !== 'all') {
                const days = parseInt(periodFilter);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                filteredOrders = filteredOrders.filter(order => new Date(order.date) >= cutoffDate);
            }
            
            // ÎÇ†ÏßúÏàú Ï†ïÎ†¨ (ÏµúÏã†Ïàú)
            filteredOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredOrders.length === 0) {
                container.innerHTML = '<div class="text-center text-gray">ÏÑ†Ï£ºÎ¨∏ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }
            
            container.innerHTML = filteredOrders.map(order => {
                const partner = partners.find(p => p.id === order.partnerId);
                const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                
                return `
                    <div class="card" style="margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">${partnerName}</div>
                                <div class="text-gray" style="font-size: 0.875rem;">${formatDate(order.date)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #3b82f6;">
                                    ${formatCurrency(order.totalAmount)}
                                </div>
                                <button class="delete-btn" onclick="deleteOrder('${order.id}')" title="ÏÑ†Ï£ºÎ¨∏ ÏÇ≠Ï†ú">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                            <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                                <div class="text-gray" style="font-size: 0.75rem;">ÏàòÎüâ</div>
                                <div style="font-weight: bold;">${order.quantity}kg</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                                <div class="text-gray" style="font-size: 0.75rem;">Îã®Í∞Ä</div>
                                <div style="font-weight: bold;">${formatCurrency(order.pricePerKg)}/kg</div>
                            </div>
                        </div>
                        ${order.memo ? `<div style="padding: 8px; background: #f9fafb; border-radius: 4px; font-size: 0.875rem;">${order.memo}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Ïô∏ÏÉÅ ÎÇ¥Ïó≠ Î°úÎìú
        function loadAdvanceHistory() {
            const partnerFilter = document.getElementById('advanceHistoryPartner').value;
            const periodFilter = document.getElementById('advanceHistoryPeriod').value;
            const container = document.getElementById('advanceHistoryList');
            
            let filteredAdvances = advances;
            
            // Í±∞ÎûòÏ≤ò ÌïÑÌÑ∞ Ï†ÅÏö©
            if (partnerFilter) {
                filteredAdvances = filteredAdvances.filter(advance => advance.partnerId === partnerFilter);
            }
            
            // Í∏∞Í∞Ñ ÌïÑÌÑ∞ Ï†ÅÏö©
            if (periodFilter !== 'all') {
                const days = parseInt(periodFilter);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                filteredAdvances = filteredAdvances.filter(advance => new Date(advance.date) >= cutoffDate);
            }
            
            // ÎÇ†ÏßúÏàú Ï†ïÎ†¨ (ÏµúÏã†Ïàú)
            filteredAdvances.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredAdvances.length === 0) {
                container.innerHTML = '<div class="text-center text-gray">Ïô∏ÏÉÅ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }
            
            container.innerHTML = filteredAdvances.map(advance => {
                const partner = partners.find(p => p.id === advance.partnerId);
                const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                
                return `
                    <div class="card" style="margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">${partnerName}</div>
                                <div class="text-gray" style="font-size: 0.875rem;">${formatDate(advance.date)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #f59e0b;">
                                    ${formatCurrency(advance.totalAmount)}
                                </div>
                                <button class="delete-btn" onclick="deleteAdvance('${advance.id}')" title="Ïô∏ÏÉÅ ÏÇ≠Ï†ú">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                            <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                                <div class="text-gray" style="font-size: 0.75rem;">ÏàòÎüâ</div>
                                <div style="font-weight: bold;">${advance.quantity}kg</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                                <div class="text-gray" style="font-size: 0.75rem;">Îã®Í∞Ä</div>
                                <div style="font-weight: bold;">${formatCurrency(advance.pricePerKg)}/kg</div>
                            </div>
                        </div>
                        ${advance.memo ? `<div style="padding: 8px; background: #f9fafb; border-radius: 4px; font-size: 0.875rem;">${advance.memo}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // ÏûÖÍ≥† ÎÇ¥Ïó≠ Î°úÎìú
        function loadReceiptHistory() {
            const partnerFilter = document.getElementById('receiptHistoryPartner').value;
            const periodFilter = document.getElementById('receiptHistoryPeriod').value;
            const container = document.getElementById('receiptHistoryList');
            
            let filteredReceipts = receipts;
            
            // Í±∞ÎûòÏ≤ò ÌïÑÌÑ∞ Ï†ÅÏö©
            if (partnerFilter) {
                filteredReceipts = filteredReceipts.filter(receipt => receipt.partnerId === partnerFilter);
            }
            
            // Í∏∞Í∞Ñ ÌïÑÌÑ∞ Ï†ÅÏö©
            if (periodFilter !== 'all') {
                const days = parseInt(periodFilter);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                filteredReceipts = filteredReceipts.filter(receipt => new Date(receipt.date) >= cutoffDate);
            }
            
            // ÎÇ†ÏßúÏàú Ï†ïÎ†¨ (ÏµúÏã†Ïàú)
            filteredReceipts.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredReceipts.length === 0) {
                container.innerHTML = '<div class="text-center text-gray">ÏûÖÍ≥† ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }
            
            container.innerHTML = filteredReceipts.map(receipt => {
                const partner = partners.find(p => p.id === receipt.partnerId);
                const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                
                return `
                    <div class="card" style="margin-bottom: 15px; border-left: 4px solid #8b5cf6;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">${partnerName}</div>
                                <div class="text-gray" style="font-size: 0.875rem;">${formatDate(receipt.date)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #8b5cf6;">
                                    ${receipt.quantity}kg
                                </div>
                                <button class="delete-btn" onclick="deleteReceipt('${receipt.id}')" title="ÏûÖÍ≥† ÏÇ≠Ï†ú">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        ${receipt.memo ? `<div style="padding: 8px; background: #f9fafb; border-radius: 4px; font-size: 0.875rem;">${receipt.memo}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Í±∞ÎûòÏ≤òÎ≥Ñ Ï†ÑÏ≤¥ ÎÇ¥Ïó≠ Î°úÎìú
        function loadPartnerHistory() {
            const partnerId = document.getElementById('historyPartnerSelect').value;
            const periodFilter = document.getElementById('historyPeriodFilter').value;
            const container = document.getElementById('partnerHistoryList');
            
            if (!partnerId) {
                container.innerHTML = '<div class="no-history">Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÎ©¥ Ï†ÑÏ≤¥ Í±∞Îûò ÎÇ¥Ïó≠Ïù¥ ÌëúÏãúÎê©ÎãàÎã§.</div>';
                return;
            }
            
            const partner = partners.find(p => p.id === partnerId);
            if (!partner) {
                container.innerHTML = '<div class="text-center text-gray">ÏÑ†ÌÉùÌïú Í±∞ÎûòÏ≤òÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }
            
            // Î™®Îì† Í±∞Îûò ÎÇ¥Ïó≠ ÏàòÏßë
            const allTransactions = [];
            
            // ÏÑ†Ï£ºÎ¨∏ Ï∂îÍ∞Ä
            orders.filter(o => o.partnerId === partnerId).forEach(order => {
                allTransactions.push({
                    type: 'order',
                    date: order.date,
                    data: order,
                    sortDate: new Date(order.date)
                });
            });
            
            // Ïô∏ÏÉÅ Ï∂îÍ∞Ä
            advances.filter(a => a.partnerId === partnerId).forEach(advance => {
                allTransactions.push({
                    type: 'advance',
                    date: advance.date,
                    data: advance,
                    sortDate: new Date(advance.date)
                });
            });
            
            // ÏûÖÍ∏à Ï∂îÍ∞Ä
            payments.filter(p => p.partnerId === partnerId).forEach(payment => {
                allTransactions.push({
                    type: 'payment',
                    date: payment.date,
                    data: payment,
                    sortDate: new Date(payment.date)
                });
            });
            
            // ÏûÖÍ≥† Ï∂îÍ∞Ä
            receipts.filter(r => r.partnerId === partnerId).forEach(receipt => {
                allTransactions.push({
                    type: 'receipt',
                    date: receipt.date,
                    data: receipt,
                    sortDate: new Date(receipt.date)
                });
            });
            
            // Í∏∞Í∞Ñ ÌïÑÌÑ∞ Ï†ÅÏö©
            let filteredTransactions = allTransactions;
            if (periodFilter !== 'all') {
                const days = parseInt(periodFilter);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                filteredTransactions = allTransactions.filter(transaction => transaction.sortDate >= cutoffDate);
            }
            
            // ÎÇ†ÏßúÏàú Ï†ïÎ†¨ (ÏµúÏã†Ïàú)
            filteredTransactions.sort((a, b) => b.sortDate - a.sortDate);
            
            if (filteredTransactions.length === 0) {
                container.innerHTML = '<div class="text-center text-gray">Ìï¥Îãπ Í∏∞Í∞ÑÏóê Í±∞Îûò ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }
            
            container.innerHTML = filteredTransactions.map(transaction => {
                const data = transaction.data;
                
                switch (transaction.type) {
                    case 'order':
                        return `
                            <div class="card" style="margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="background: #dbeafe; color: #1d4ed8; padding: 4px 8px; border-radius: 4px; font-size: 0.875rem; font-weight: bold;">üì¶ ÏÑ†Ï£ºÎ¨∏</span>
                                    <span class="text-gray" style="font-size: 0.875rem;">${formatDate(data.date)}</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
                                    <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                                        <div class="text-gray" style="font-size: 0.75rem;">ÏàòÎüâ</div>
                                        <div style="font-weight: bold;">${data.quantity}kg</div>
                                    </div>
                                    <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                                        <div class="text-gray" style="font-size: 0.75rem;">Îã®Í∞Ä</div>
                                        <div style="font-weight: bold;">${formatCurrency(data.pricePerKg)}/kg</div>
                                    </div>
                                    <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                                        <div class="text-gray" style="font-size: 0.75rem;">Ï¥ùÏï°</div>
                                        <div style="font-weight: bold; color: #3b82f6;">${formatCurrency(data.totalAmount)}</div>
                                    </div>
                                </div>
                                ${data.memo ? `<div style="padding: 8px; background: #f9fafb; border-radius: 4px; font-size: 0.875rem;">${data.memo}</div>` : ''}
                            </div>
                        `;
                    case 'advance':
                        return `
                            <div class="card" style="margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="background: #fef3c7; color: #d97706; padding: 4px 8px; border-radius: 4px; font-size: 0.875rem; font-weight: bold;">üí≥ Ïô∏ÏÉÅ</span>
                                    <span class="text-gray" style="font-size: 0.875rem;">${formatDate(data.date)}</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
                                    <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                                        <div class="text-gray" style="font-size: 0.75rem;">ÏàòÎüâ</div>
                                        <div style="font-weight: bold;">${data.quantity}kg</div>
                                    </div>
                                    <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                                        <div class="text-gray" style="font-size: 0.75rem;">Îã®Í∞Ä</div>
                                        <div style="font-weight: bold;">${formatCurrency(data.pricePerKg)}/kg</div>
                                    </div>
                                    <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                                        <div class="text-gray" style="font-size: 0.75rem;">Ï¥ùÏï°</div>
                                        <div style="font-weight: bold; color: #f59e0b;">${formatCurrency(data.totalAmount)}</div>
                                    </div>
                                </div>
                                ${data.memo ? `<div style="padding: 8px; background: #f9fafb; border-radius: 4px; font-size: 0.875rem;">${data.memo}</div>` : ''}
                            </div>
                        `;
                    case 'payment':
                        let paymentTypeText = '';
                        switch(data.paymentType) {
                            case 'auto': paymentTypeText = 'üîÑ ÏûêÎèôÏ†ïÏÇ∞'; break;
                            case 'advance': paymentTypeText = 'üí≥ Ïô∏ÏÉÅÏ†ïÏÇ∞'; break;
                            case 'order': paymentTypeText = 'üì¶ ÏÑ†Ï£ºÎ¨∏Ï†ïÏÇ∞'; break;
                            case 'custom': paymentTypeText = '‚úèÔ∏è ÏßÅÏ†ëÏßÄÏ†ï'; break;
                            default: paymentTypeText = 'üîÑ ÏûêÎèôÏ†ïÏÇ∞'; break;
                        }
                        
                        let settlementInfo = '';
                        if (data.advancePayment !== undefined && data.orderPayment !== undefined) {
                            settlementInfo = `
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
                                    <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                                        <div class="text-gray" style="font-size: 0.75rem;">Ïô∏ÏÉÅ Ï†ïÏÇ∞</div>
                                        <div style="font-weight: bold;">${formatCurrency(data.advancePayment)}</div>
                                    </div>
                                    <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                                        <div class="text-gray" style="font-size: 0.75rem;">ÏÑ†Ï£ºÎ¨∏ Ï†ïÏÇ∞</div>
                                        <div style="font-weight: bold;">${formatCurrency(data.orderPayment)}</div>
                                    </div>
                                    <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                                        <div class="text-gray" style="font-size: 0.75rem;">Ï¥ù ÏûÖÍ∏àÏï°</div>
                                        <div style="font-weight: bold; color: #10b981;">${formatCurrency(data.amount)}</div>
                                    </div>
                                </div>
                            `;
                        } else {
                            settlementInfo = `
                                <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 4px; margin-bottom: 10px;">
                                    <div class="text-gray" style="font-size: 0.75rem;">ÏûÖÍ∏àÏï°</div>
                                    <div style="font-weight: bold; color: #10b981;">${formatCurrency(data.amount)}</div>
                                </div>
                            `;
                        }
                        
                        return `
                            <div class="card" style="margin-bottom: 15px; border-left: 4px solid #10b981;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 0.875rem; font-weight: bold;">üí∞ ÏûÖÍ∏à (${paymentTypeText})</span>
                                    <span class="text-gray" style="font-size: 0.875rem;">${formatDate(data.date)}</span>
                                </div>
                                ${settlementInfo}
                                ${data.memo ? `<div style="padding: 8px; background: #f9fafb; border-radius: 4px; font-size: 0.875rem;">${data.memo}</div>` : ''}
                            </div>
                        `;
                    case 'receipt':
                        return `
                            <div class="card" style="margin-bottom: 15px; border-left: 4px solid #8b5cf6;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="background: #ede9fe; color: #7c3aed; padding: 4px 8px; border-radius: 4px; font-size: 0.875rem; font-weight: bold;">üì• ÏûÖÍ≥†</span>
                                    <span class="text-gray" style="font-size: 0.875rem;">${formatDate(data.date)}</span>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 4px; margin-bottom: 10px;">
                                    <div class="text-gray" style="font-size: 0.75rem;">ÏûÖÍ≥†Îüâ</div>
                                    <div style="font-weight: bold; color: #8b5cf6;">${data.quantity}kg</div>
                                </div>
                                ${data.memo ? `<div style="padding: 8px; background: #f9fafb; border-radius: 4px; font-size: 0.875rem;">${data.memo}</div>` : ''}
                            </div>
                        `;
                }
            }).join('');
        }
        
        // ÎÇ¥Ïó≠ ÏÇ≠Ï†ú Ìï®ÏàòÎì§ÎèÑ Ï∂îÍ∞Ä (ÌïÑÏöîÏãú)
        function deletePayment(paymentId) {
            if (confirm('Ïù¥ ÏûÖÍ∏à ÎÇ¥Ïó≠ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n‚Äª ÏÇ≠Ï†úÌïòÎ©¥ Ï†ïÏÇ∞ ÎÇ¥Ïó≠ÎèÑ Ï∑®ÏÜåÎê©ÎãàÎã§.')) {
                payments = payments.filter(p => p.id !== paymentId);
                calculatePartnerStatus();
                saveData();
                updateDashboard();
                loadPaymentHistory();
                alert('ÏûÖÍ∏à ÎÇ¥Ïó≠Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            }
        }
        
        function deleteOrder(orderId) {
            if (confirm('Ïù¥ ÏÑ†Ï£ºÎ¨∏ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                orders = orders.filter(o => o.id !== orderId);
                calculatePartnerStatus();
                saveData();
                updateDashboard();
                loadOrderHistory();
                alert('ÏÑ†Ï£ºÎ¨∏Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            }
        }
        
        function deleteAdvance(advanceId) {
            if (confirm('Ïù¥ Ïô∏ÏÉÅÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                advances = advances.filter(a => a.id !== advanceId);
                calculatePartnerStatus();
                saveData();
                updateDashboard();
                loadAdvanceHistory();
                alert('Ïô∏ÏÉÅÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            }
        }
        
        function deleteReceipt(receiptId) {
            if (confirm('Ïù¥ ÏûÖÍ≥† ÎÇ¥Ïó≠ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                receipts = receipts.filter(r => r.id !== receiptId);
                calculatePartnerStatus();
                saveData();
                updateDashboard();
                loadReceiptHistory();
                alert('ÏûÖÍ≥† ÎÇ¥Ïó≠Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            }
        }

        // Í±∞ÎûòÎÇ¥Ïó≠ÌôïÏù∏ Ï¥àÍ∏∞Ìôî
        function initializeDataView() {
            updateDataViewSelects();
            filterData();
        }

        // Í±∞ÎûòÎÇ¥Ïó≠ÌôïÏù∏ ÏÖÄÎ†âÌä∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateDataViewSelects() {
            const partnerSelect = document.getElementById('dataPartnerFilter');
            partnerSelect.innerHTML = '<option value="">Ï†ÑÏ≤¥ Í±∞ÎûòÏ≤ò</option>';
            
            partners.forEach(partner => {
                const option = document.createElement('option');
                option.value = partner.id;
                option.textContent = partner.name;
                partnerSelect.appendChild(option);
            });
        }

        // Îç∞Ïù¥ÌÑ∞ ÌïÑÌÑ∞ÎßÅ
        function filterData() {
            const dataType = document.getElementById('dataTypeFilter').value;
            const partnerId = document.getElementById('dataPartnerFilter').value;
            const startDate = document.getElementById('dataStartDate').value;
            const endDate = document.getElementById('dataEndDate').value;

            let filteredData = [];

            // Îç∞Ïù¥ÌÑ∞ Ïú†ÌòïÎ≥ÑÎ°ú ÌïÑÌÑ∞ÎßÅ
            if (dataType === 'all' || dataType === 'partners') {
                let partnerData = partners.filter(p => !partnerId || p.id === partnerId);
                filteredData.push({
                    type: 'partners',
                    title: 'Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥',
                    data: partnerData
                });
            }

            if (dataType === 'all' || dataType === 'orders') {
                let orderData = orders.filter(order => {
                    const matchPartner = !partnerId || order.partnerId === partnerId;
                    const matchDate = (!startDate || order.date >= startDate) && 
                                    (!endDate || order.date <= endDate);
                    return matchPartner && matchDate;
                });
                filteredData.push({
                    type: 'orders',
                    title: 'ÏÑ†Ï£ºÎ¨∏ ÎÇ¥Ïó≠',
                    data: orderData
                });
            }

            if (dataType === 'all' || dataType === 'advances') {
                let advanceData = advances.filter(advance => {
                    const matchPartner = !partnerId || advance.partnerId === partnerId;
                    const matchDate = (!startDate || advance.date >= startDate) && 
                                    (!endDate || advance.date <= endDate);
                    return matchPartner && matchDate;
                });
                filteredData.push({
                    type: 'advances',
                    title: 'Ïô∏ÏÉÅ ÎÇ¥Ïó≠',
                    data: advanceData
                });
            }

            if (dataType === 'all' || dataType === 'payments') {
                let paymentData = payments.filter(payment => {
                    const matchPartner = !partnerId || payment.partnerId === partnerId;
                    const matchDate = (!startDate || payment.date >= startDate) && 
                                    (!endDate || payment.date <= endDate);
                    return matchPartner && matchDate;
                });
                filteredData.push({
                    type: 'payments',
                    title: 'ÏûÖÍ∏à ÎÇ¥Ïó≠',
                    data: paymentData
                });
            }

            if (dataType === 'all' || dataType === 'receipts') {
                let receiptData = receipts.filter(receipt => {
                    const matchPartner = !partnerId || receipt.partnerId === partnerId;
                    const matchDate = (!startDate || receipt.date >= startDate) && 
                                    (!endDate || receipt.date <= endDate);
                    return matchPartner && matchDate;
                });
                filteredData.push({
                    type: 'receipts',
                    title: 'ÏûÖÍ≥† ÎÇ¥Ïó≠',
                    data: receiptData
                });
            }

            displayFilteredData(filteredData);
        }

        // ÌïÑÌÑ∞Îêú Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
        function displayFilteredData(filteredData) {
            const container = document.getElementById('dataViewContainer');
            
            if (filteredData.every(section => section.data.length === 0)) {
                container.innerHTML = '<div class="card"><p style="text-align: center; color: #666;">Ï°∞Í±¥Ïóê ÎßûÎäî Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p></div>';
                return;
            }

            let html = '';

            filteredData.forEach(section => {
                if (section.data.length > 0) {
                    html += `<div class="card" style="margin-bottom: 20px;">`;
                    html += `<h4 style="margin-bottom: 15px;">${section.title} (${section.data.length}Í±¥)</h4>`;
                    
                    if (section.type === 'partners') {
                        html += displayPartnersData(section.data);
                    } else if (section.type === 'orders') {
                        html += displayOrdersData(section.data);
                    } else if (section.type === 'advances') {
                        html += displayAdvancesData(section.data);
                    } else if (section.type === 'payments') {
                        html += displayPaymentsData(section.data);
                    } else if (section.type === 'receipts') {
                        html += displayReceiptsData(section.data);
                    }
                    
                    html += `</div>`;
                }
            });

            container.innerHTML = html;
        }

        // Í±∞ÎûòÏ≤ò Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
        function displayPartnersData(data) {
            return data.map(partner => {
                const status = partnerStatus.get(partner.id) || {
                    pending_payment_order: 0,
                    pending_payment_advance: 0,
                    pending_eel_kg: 0
                };
                return `
                    <div class="data-item" data-type="partners" data-id="${partner.id}" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; align-items: center;">
                            <div>
                                <strong><span class="partner-name-clickable" onclick="filterByPartner('${partner.id}', '${partner.name}')" style="cursor: pointer; color: #2563eb; text-decoration: underline;">${partner.name}</span></strong><br>
                                <small style="color: #666;">${partner.contact || 'Ïó∞ÎùΩÏ≤ò ÏóÜÏùå'}</small>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #dc2626;">ÏÑ†Ï£ºÎ¨∏: ${formatCurrency(status.pending_payment_order)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #ea580c;">Ïô∏ÏÉÅ: ${formatCurrency(status.pending_payment_advance)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #7c3aed;">Î∞õÏùÑÏû•Ïñ¥: ${status.pending_eel_kg}kg</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ÏÑ†Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
        function displayOrdersData(data) {
            return data.map(order => {
                const partner = partners.find(p => p.id === order.partnerId);
                const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                return `
                    <div class="data-item" data-type="orders" data-id="${order.id}" style="border: 1px solid #3b82f6; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 10px; align-items: center;">
                            <div><strong><span class="partner-name-clickable" onclick="filterByPartnerName('${partnerName}')" style="cursor: pointer; color: #2563eb; text-decoration: underline;">${partnerName}</span></strong></div>
                            <div style="text-align: center;">${order.date}</div>
                            <div style="text-align: center;">${order.quantity}kg</div>
                            <div style="text-align: center;">${formatCurrency(order.pricePerKg)}/kg</div>
                            <div style="text-align: center;"><strong>${formatCurrency(order.totalAmount)}</strong></div>
                        </div>
                        ${order.memo ? `<div style="margin-top: 10px; color: #666; font-size: 0.9em;">Î©îÎ™®: ${order.memo}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Ïô∏ÏÉÅ Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
        function displayAdvancesData(data) {
            return data.map(advance => {
                const partner = partners.find(p => p.id === advance.partnerId);
                const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                return `
                    <div class="data-item" data-type="advances" data-id="${advance.id}" style="border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 10px; align-items: center;">
                            <div><strong><span class="partner-name-clickable" onclick="filterByPartnerName('${partnerName}')" style="cursor: pointer; color: #2563eb; text-decoration: underline;">${partnerName}</span></strong></div>
                            <div style="text-align: center;">${advance.date}</div>
                            <div style="text-align: center;">${advance.quantity}kg</div>
                            <div style="text-align: center;">${formatCurrency(advance.pricePerKg)}/kg</div>
                            <div style="text-align: center;"><strong>${formatCurrency(advance.totalAmount)}</strong></div>
                        </div>
                        ${advance.memo ? `<div style="margin-top: 10px; color: #666; font-size: 0.9em;">Î©îÎ™®: ${advance.memo}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // ÏûÖÍ∏à Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
        function displayPaymentsData(data) {
            return data.map(payment => {
                const partner = partners.find(p => p.id === payment.partnerId);
                const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                return `
                    <div class="data-item" data-type="payments" data-id="${payment.id}" style="border: 1px solid #10b981; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; align-items: center;">
                            <div><strong><span class="partner-name-clickable" onclick="filterByPartnerName('${partnerName}')" style="cursor: pointer; color: #2563eb; text-decoration: underline;">${partnerName}</span></strong></div>
                            <div style="text-align: center;">${payment.date}</div>
                            <div style="text-align: center;"><strong>${formatCurrency(payment.amount)}</strong></div>
                        </div>
                        ${payment.memo ? `<div style="margin-top: 10px; color: #666; font-size: 0.9em;">Î©îÎ™®: ${payment.memo}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // ÏûÖÍ≥† Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
        function displayReceiptsData(data) {
            return data.map(receipt => {
                const partner = partners.find(p => p.id === receipt.partnerId);
                const partnerName = partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò';
                return `
                    <div class="data-item" data-type="receipts" data-id="${receipt.id}" style="border: 1px solid #8b5cf6; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; align-items: center;">
                            <div><strong><span class="partner-name-clickable" onclick="filterByPartnerName('${partnerName}')" style="cursor: pointer; color: #2563eb; text-decoration: underline;">${partnerName}</span></strong></div>
                            <div style="text-align: center;">${receipt.date}</div>
                            <div style="text-align: center;"><strong>${receipt.quantity}kg</strong></div>
                        </div>
                        ${receipt.memo ? `<div style="margin-top: 10px; color: #666; font-size: 0.9em;">Î©îÎ™®: ${receipt.memo}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // ÌïÑÌÑ∞Îêú Îç∞Ïù¥ÌÑ∞ Ï∂úÎ†•
        function exportFilteredData() {
            const dataType = document.getElementById('dataTypeFilter').value;
            const partnerId = document.getElementById('dataPartnerFilter').value;
            const startDate = document.getElementById('dataStartDate').value;
            const endDate = document.getElementById('dataEndDate').value;

            let filteredData = {};
            let filterInfo = [];

            // ÌïÑÌÑ∞ Ï†ïÎ≥¥ ÏÉùÏÑ±
            if (partnerId) {
                const partner = partners.find(p => p.id === partnerId);
                filterInfo.push(`Í±∞ÎûòÏ≤ò: ${partner ? partner.name : 'Ïïå Ïàò ÏóÜÏùå'}`);
            }
            if (startDate) filterInfo.push(`ÏãúÏûëÏùº: ${startDate}`);
            if (endDate) filterInfo.push(`Ï¢ÖÎ£åÏùº: ${endDate}`);

            // Îç∞Ïù¥ÌÑ∞ ÌïÑÌÑ∞ÎßÅ
            if (dataType === 'all' || dataType === 'partners') {
                filteredData['Í±∞ÎûòÏ≤ò'] = partners.filter(p => !partnerId || p.id === partnerId);
            }
            if (dataType === 'all' || dataType === 'orders') {
                filteredData['ÏÑ†Ï£ºÎ¨∏'] = orders.filter(order => {
                    const matchPartner = !partnerId || order.partnerId === partnerId;
                    const matchDate = (!startDate || order.date >= startDate) && (!endDate || order.date <= endDate);
                    return matchPartner && matchDate;
                });
            }
            if (dataType === 'all' || dataType === 'advances') {
                filteredData['Ïô∏ÏÉÅ'] = advances.filter(advance => {
                    const matchPartner = !partnerId || advance.partnerId === partnerId;
                    const matchDate = (!startDate || advance.date >= startDate) && (!endDate || advance.date <= endDate);
                    return matchPartner && matchDate;
                });
            }
            if (dataType === 'all' || dataType === 'payments') {
                filteredData['ÏûÖÍ∏à'] = payments.filter(payment => {
                    const matchPartner = !partnerId || payment.partnerId === partnerId;
                    const matchDate = (!startDate || payment.date >= startDate) && (!endDate || payment.date <= endDate);
                    return matchPartner && matchDate;
                });
            }
            if (dataType === 'all' || dataType === 'receipts') {
                filteredData['ÏûÖÍ≥†'] = receipts.filter(receipt => {
                    const matchPartner = !partnerId || receipt.partnerId === partnerId;
                    const matchDate = (!startDate || receipt.date >= startDate) && (!endDate || receipt.date <= endDate);
                    return matchPartner && matchDate;
                });
            }

            const title = `ÌïÑÌÑ∞Îêú Í±∞Îûò Îç∞Ïù¥ÌÑ∞${filterInfo.length > 0 ? ' (' + filterInfo.join(', ') + ')' : ''}`;
            printData(title, filteredData);
        }

        // Í±∞ÎûòÏ≤ò IDÎ°ú ÌïÑÌÑ∞ÎßÅ
        function filterByPartner(partnerId, partnerName) {
            // Í±∞ÎûòÏ≤ò ÌïÑÌÑ∞ ÏÖÄÎ†âÌä∏ Î∞ïÏä§ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('dataPartnerFilter').value = partnerId;
            
            // ÌïÑÌÑ∞ Ï†ÅÏö©
            filterData();
            
            // ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞± Ï†úÍ≥µ
            showFilterNotification(partnerName);
        }

        // Í±∞ÎûòÏ≤ò Ïù¥Î¶ÑÏúºÎ°ú ÌïÑÌÑ∞ÎßÅ (Ïù¥Î¶ÑÏúºÎ°ú ID Ï∞æÏïÑÏÑú ÌïÑÌÑ∞ÎßÅ)
        function filterByPartnerName(partnerName) {
            const partner = partners.find(p => p.name === partnerName);
            if (partner) {
                filterByPartner(partner.id, partnerName);
            } else {
                // ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤òÏùò Í≤ΩÏö∞ ÏàòÎèôÏúºÎ°ú ÌïÑÌÑ∞ÎßÅ
                document.getElementById('dataPartnerFilter').value = '';
                manualFilterByPartnerName(partnerName);
            }
        }

        // ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤òÎ•º ÏúÑÌïú ÏàòÎèô ÌïÑÌÑ∞ÎßÅ
        function manualFilterByPartnerName(partnerName) {
            const dataItems = document.querySelectorAll('.data-item');
            
            dataItems.forEach(item => {
                const partnerNameElement = item.querySelector('.partner-name-clickable');
                if (partnerNameElement) {
                    const itemPartnerName = partnerNameElement.textContent;
                    if (itemPartnerName === partnerName) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                } else {
                    item.style.display = 'none';
                }
            });
            
            showFilterNotification(partnerName + ' (ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò)');
        }

        // ÌïÑÌÑ∞ ÏïåÎ¶º ÌëúÏãú
        function showFilterNotification(partnerName) {
            // Í∏∞Ï°¥ ÏïåÎ¶º Ï†úÍ±∞
            const existingNotification = document.getElementById('filterNotification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // ÏÉà ÏïåÎ¶º ÏÉùÏÑ±
            const notification = document.createElement('div');
            notification.id = 'filterNotification';
            notification.innerHTML = `
                <div style="background: #3b82f6; color: white; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <span>üìã "${partnerName}" Í±∞ÎûòÏ≤òÎ°ú ÌïÑÌÑ∞ÎßÅÎêòÏóàÏäµÎãàÎã§.</span>
                    <button onclick="clearPartnerFilter()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Ï†ÑÏ≤¥ Î≥¥Í∏∞</button>
                </div>
            `;
            
            // Îç∞Ïù¥ÌÑ∞ Ïª®ÌÖåÏù¥ÎÑà ÏúÑÏóê ÏÇΩÏûÖ
            const container = document.getElementById('dataViewContainer');
            container.parentNode.insertBefore(notification, container);
        }

        // Í±∞ÎûòÏ≤ò ÌïÑÌÑ∞ Ìï¥Ï†ú
        function clearPartnerFilter() {
            // ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
            document.getElementById('dataPartnerFilter').value = '';
            
            // Îç∞Ïù¥ÌÑ∞ Îã§Ïãú ÌïÑÌÑ∞ÎßÅ
            filterData();
            
            // ÏïåÎ¶º Ï†úÍ±∞
            const notification = document.getElementById('filterNotification');
            if (notification) {
                notification.remove();
            }
        }

        // Îç∞Ïù¥ÌÑ∞ Ï∂úÎ†• Ìï®Ïàò
        function printData(title, data) {
            const printWindow = window.open('', '_blank');
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #333; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        h2 { color: #666; margin-top: 30px; }
                        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f5f5f5; font-weight: bold; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .print-date { text-align: right; color: #666; margin-bottom: 20px; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-date">Ï∂úÎ†•Ïùº: ${new Date().toLocaleDateString('ko-KR')}</div>
                    <h1>${title}</h1>
            `;

            Object.entries(data).forEach(([category, items]) => {
                if (items && items.length > 0) {
                    html += `<h2>${category} (${items.length}Í±¥)</h2>`;
                    html += '<table>';
                    
                    if (category === 'Í±∞ÎûòÏ≤ò') {
                        html += '<tr><th>Í±∞ÎûòÏ≤òÎ™Ö</th><th>Ïó∞ÎùΩÏ≤ò</th><th>Îì±Î°ùÏùº</th></tr>';
                        items.forEach(item => {
                            html += `<tr>
                                <td>${item.name}</td>
                                <td>${item.contact || 'ÏóÜÏùå'}</td>
                                <td>${formatDate(item.createdAt)}</td>
                            </tr>`;
                        });
                    } else if (category === 'ÏÑ†Ï£ºÎ¨∏') {
                        html += '<tr><th>Í±∞ÎûòÏ≤ò</th><th>ÎÇ†Ïßú</th><th>ÏàòÎüâ(kg)</th><th>Îã®Í∞Ä</th><th>Ï¥ùÏï°</th><th>Î©îÎ™®</th></tr>';
                        items.forEach(item => {
                            const partner = partners.find(p => p.id === item.partnerId);
                            html += `<tr>
                                <td>${partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò'}</td>
                                <td>${item.date}</td>
                                <td>${item.quantity}</td>
                                <td>${formatCurrency(item.pricePerKg)}</td>
                                <td>${formatCurrency(item.totalAmount)}</td>
                                <td>${item.memo || ''}</td>
                            </tr>`;
                        });
                    } else if (category === 'Ïô∏ÏÉÅ') {
                        html += '<tr><th>Í±∞ÎûòÏ≤ò</th><th>ÎÇ†Ïßú</th><th>ÏàòÎüâ(kg)</th><th>Îã®Í∞Ä</th><th>Ï¥ùÏï°</th><th>Î©îÎ™®</th></tr>';
                        items.forEach(item => {
                            const partner = partners.find(p => p.id === item.partnerId);
                            html += `<tr>
                                <td>${partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò'}</td>
                                <td>${item.date}</td>
                                <td>${item.quantity}</td>
                                <td>${formatCurrency(item.pricePerKg)}</td>
                                <td>${formatCurrency(item.totalAmount)}</td>
                                <td>${item.memo || ''}</td>
                            </tr>`;
                        });
                    } else if (category === 'ÏûÖÍ∏à') {
                        html += '<tr><th>Í±∞ÎûòÏ≤ò</th><th>ÎÇ†Ïßú</th><th>ÏûÖÍ∏àÏï°</th><th>Î©îÎ™®</th></tr>';
                        items.forEach(item => {
                            const partner = partners.find(p => p.id === item.partnerId);
                            html += `<tr>
                                <td>${partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò'}</td>
                                <td>${item.date}</td>
                                <td>${formatCurrency(item.amount)}</td>
                                <td>${item.memo || ''}</td>
                            </tr>`;
                        });
                    } else if (category === 'ÏûÖÍ≥†') {
                        html += '<tr><th>Í±∞ÎûòÏ≤ò</th><th>ÎÇ†Ïßú</th><th>ÏàòÎüâ(kg)</th><th>Î©îÎ™®</th></tr>';
                        items.forEach(item => {
                            const partner = partners.find(p => p.id === item.partnerId);
                            html += `<tr>
                                <td>${partner ? partner.name : 'ÏÇ≠Ï†úÎêú Í±∞ÎûòÏ≤ò'}</td>
                                <td>${item.date}</td>
                                <td>${item.quantity}</td>
                                <td>${item.memo || ''}</td>
                            </tr>`;
                        });
                    }
                    
                    html += '</table>';
                }
            });

            html += `
                    <div style="margin-top: 30px; text-align: center;" class="no-print">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Ïù∏ÏáÑ</button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">Îã´Í∏∞</button>
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(html);
            printWindow.document.close();
        }
    </script>
</body>
</html>